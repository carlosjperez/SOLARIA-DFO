<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="SOLARIA DFO">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#0a0a0a">
    <meta name="format-detection" content="telephone=no">

    <title>SOLARIA DFO - Production Dashboard</title>

    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">

    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" href="/solaria-logo.png">
    <link rel="icon" type="image/png" href="/solaria-logo.png">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <!-- Socket.IO Client -->
    <script src="/socket.io/socket.io.js"></script>

    <style>
        /* ============================================
           CSS Variables - SOLARIA Design System
           ============================================ */
        :root {
            /* Colors */
            --solaria-orange: #f6921d;
            --solaria-orange-dark: #d97b0d;
            --solaria-orange-light: #ffa94d;

            --bg-primary: #0a0a0a;
            --bg-secondary: #111111;
            --bg-tertiary: #1a1a1a;
            --bg-card: #161616;
            --bg-hover: #222222;

            --text-primary: #ffffff;
            --text-secondary: #a0a0a0;
            --text-muted: #666666;

            --border-color: #2a2a2a;
            --border-light: #333333;

            /* Semantic Colors - Design Hub Linked */
            --color-positive: #22c55e;
            --color-positive-bg: rgba(34, 197, 94, 0.12);
            --color-negative: #ef4444;
            --color-negative-bg: rgba(239, 68, 68, 0.12);
            --color-neutral: #6b7280;
            --color-info: #3b82f6;
            --color-info-bg: rgba(59, 130, 246, 0.12);
            --color-warning: #f59e0b;
            --color-warning-bg: rgba(245, 158, 11, 0.12);

            /* Metrics Card Design System */
            --metric-card-bg: var(--bg-card);
            --metric-card-border: var(--border-color);
            --metric-card-radius: 12px;
            --metric-card-padding: 16px;
            --metric-label-size: 11px;
            --metric-label-color: var(--text-muted);
            --metric-value-size: 24px;
            --metric-value-weight: 700;
            --metric-change-size: 12px;
            --metric-divider-color: var(--border-color);

            /* Sidebar */
            --sidebar-width: 260px;
            --sidebar-collapsed-width: 72px;

            /* Header/Footer */
            --header-height: 56px;
            --footer-height: 40px;

            /* Transitions */
            --transition-fast: 150ms ease;
            --transition-normal: 250ms ease;

            /* Safe areas for iOS */
            --safe-area-top: env(safe-area-inset-top, 0px);
            --safe-area-bottom: env(safe-area-inset-bottom, 0px);
            --safe-area-left: env(safe-area-inset-left, 0px);
            --safe-area-right: env(safe-area-inset-right, 0px);
        }

        /* Light Theme */
        [data-theme="light"] {
            --bg-primary: #f5f5f5;
            --bg-secondary: #ffffff;
            --bg-tertiary: #e8e8e8;
            --bg-card: #ffffff;
            --bg-hover: #e0e0e0;

            --text-primary: #1a1a1a;
            --text-secondary: #666666;
            --text-muted: #999999;

            --border-color: #e0e0e0;
            --border-light: #d0d0d0;
        }

        [data-theme="light"] .progress-segment.planning { background: linear-gradient(90deg, #6d28d9, #7c3aed); }
        [data-theme="light"] .progress-segment.development { background: linear-gradient(90deg, #0e7490, #0891b2); }
        [data-theme="light"] .progress-segment.testing { background: linear-gradient(90deg, #0f766e, #0d9488); }
        [data-theme="light"] .progress-segment.production { background: linear-gradient(90deg, #15803d, #16a34a); }

        [data-theme="light"] .stat-value.green { color: #16a34a; }
        [data-theme="light"] .stat-value.blue { color: #2563eb; }
        [data-theme="light"] .stat-value.orange { color: #d97706; }
        [data-theme="light"] .stat-value.purple { color: #7c3aed; }
        [data-theme="light"] .stat-value.yellow { color: #ca8a04; }
        [data-theme="light"] .stat-value.pink { color: #db2777; }
        [data-theme="light"] .stat-value.indigo { color: #4f46e5; }

        /* ============================================
           Reset & Base - PWA Optimized
           ============================================ */
        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
        }

        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            font-size: 14px;
            line-height: 1.5;
            background: var(--bg-primary);
            color: var(--text-primary);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overscroll-behavior: none;
            touch-action: manipulation;
        }

        /* Prevent elastic bounce on iOS */
        body {
            -webkit-overflow-scrolling: touch;
        }

        /* ============================================
           App Container - Full viewport lock
           ============================================ */
        .app-container {
            display: flex;
            height: 100%;
            width: 100%;
            overflow: hidden;
            position: relative;
            padding-top: var(--safe-area-top);
            padding-bottom: var(--safe-area-bottom);
            padding-left: var(--safe-area-left);
            padding-right: var(--safe-area-right);
        }

        /* ============================================
           Sidebar - Fixed, No Scroll
           ============================================ */
        .sidebar {
            width: var(--sidebar-width);
            min-width: var(--sidebar-width);
            height: 100%;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            transition: width var(--transition-normal), min-width var(--transition-normal);
            overflow: hidden;
            position: relative;
            z-index: 100;
        }

        .sidebar.collapsed {
            width: var(--sidebar-collapsed-width);
            min-width: var(--sidebar-collapsed-width);
        }

        /* Sidebar Header - Logo */
        .sidebar-header {
            height: var(--header-height);
            min-height: var(--header-height);
            display: flex;
            align-items: center;
            padding: 0 16px;
            border-bottom: 1px solid var(--border-color);
            gap: 12px;
        }

        .sidebar-logo {
            width: 40px;
            height: 40px;
            min-width: 40px;
            border-radius: 8px;
            overflow: hidden;
        }

        .sidebar-logo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .sidebar-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            opacity: 1;
            transition: opacity var(--transition-fast);
        }

        .sidebar.collapsed .sidebar-title {
            opacity: 0;
            width: 0;
        }

        /* Sidebar Navigation */
        .sidebar-nav {
            flex: 1;
            padding: 16px 12px;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 14px;
            border-radius: 8px;
            color: var(--text-secondary);
            text-decoration: none;
            cursor: pointer;
            transition: background var(--transition-fast), color var(--transition-fast);
            white-space: nowrap;
            overflow: hidden;
        }

        .nav-item:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .nav-item.active {
            background: var(--solaria-orange);
            color: var(--text-primary);
        }

        .nav-item i {
            width: 20px;
            min-width: 20px;
            font-size: 18px;
            text-align: center;
        }

        .nav-item span {
            opacity: 1;
            transition: opacity var(--transition-fast);
        }

        .sidebar.collapsed .nav-item span {
            opacity: 0;
            width: 0;
        }

        /* External Links in Sidebar */
        .nav-separator {
            height: 1px;
            background: var(--border-color);
            margin: 12px 14px;
            opacity: 0.5;
        }

        .nav-item.nav-external {
            position: relative;
        }

        .nav-item .external-icon {
            font-size: 10px;
            opacity: 0.4;
            margin-left: auto;
            transition: opacity var(--transition-fast);
        }

        .nav-item.nav-external:hover .external-icon {
            opacity: 0.8;
        }

        .sidebar.collapsed .nav-separator {
            margin: 12px 8px;
        }

        .sidebar.collapsed .external-icon {
            display: none;
        }

        /* Sidebar Footer - Collapse Button */
        .sidebar-footer {
            height: var(--footer-height);
            min-height: var(--footer-height);
            padding: 0 12px;
            border-top: 1px solid var(--border-color);
            display: flex;
            align-items: center;
        }

        .collapse-btn {
            width: 100%;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            border: none;
            border-radius: 6px;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            cursor: pointer;
            transition: background var(--transition-fast), color var(--transition-fast);
        }

        .collapse-btn:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .collapse-btn i {
            font-size: 12px;
            transition: transform var(--transition-normal);
        }

        .sidebar.collapsed .collapse-btn i {
            transform: rotate(180deg);
        }

        /* ============================================
           Main Content Area
           ============================================ */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-width: 0;
        }

        /* Header */
        .header {
            height: var(--header-height);
            min-height: var(--header-height);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }

        .header-left .search-box {
            flex: 1;
            max-width: 360px;
        }

        .search-box {
            display: flex;
            align-items: center;
            gap: 10px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 0 14px;
            height: 40px;
            transition: border-color var(--transition-fast), background var(--transition-fast);
        }

        .search-box:focus-within {
            border-color: var(--solaria-orange);
            background: var(--bg-hover);
        }

        .search-box i {
            color: var(--text-muted);
            font-size: 14px;
        }

        .search-box input {
            flex: 1;
            border: none;
            background: transparent;
            color: var(--text-primary);
            font-size: 14px;
            outline: none;
        }

        .search-box input::placeholder {
            color: var(--text-muted);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .header-btn {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            border-radius: 10px;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            cursor: pointer;
            transition: background var(--transition-fast), color var(--transition-fast);
            position: relative;
        }

        .header-btn:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .header-btn.active {
            background: var(--solaria-orange);
            color: white;
        }

        .notification-badge {
            position: absolute;
            top: 2px;
            right: 2px;
            min-width: 18px;
            height: 18px;
            padding: 0 5px;
            background: #ef4444;
            border-radius: 9px;
            border: 2px solid var(--bg-secondary);
            font-size: 10px;
            font-weight: 600;
            color: white;
            display: none;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }

        .notification-badge.has-notifications {
            display: flex;
        }

        /* Notifications Panel */
        .notifications-panel {
            position: absolute;
            top: calc(var(--header-height) - 8px);
            right: 100px;
            width: 380px;
            max-height: 480px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            z-index: 1000;
            display: none;
            flex-direction: column;
            overflow: hidden;
        }

        .notifications-panel.show {
            display: flex;
        }

        .notifications-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
        }

        .notifications-header h3 {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .notifications-clear {
            font-size: 12px;
            color: var(--solaria-orange);
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background var(--transition-fast);
        }

        .notifications-clear:hover {
            background: var(--bg-hover);
        }

        .notifications-list {
            flex: 1;
            overflow-y: auto;
            max-height: 400px;
        }

        .notification-item {
            display: flex;
            gap: 12px;
            padding: 14px 16px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background var(--transition-fast);
        }

        .notification-item:hover {
            background: var(--bg-hover);
        }

        .notification-item.unread {
            background: rgba(246, 146, 29, 0.05);
        }

        .notification-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 14px;
        }

        .notification-icon.task { background: var(--color-info-bg); color: var(--color-info); }
        .notification-icon.project { background: var(--color-positive-bg); color: var(--color-positive); }
        .notification-icon.business { background: rgba(168, 85, 247, 0.12); color: #a855f7; }
        .notification-icon.alert { background: var(--color-negative-bg); color: var(--color-negative); }

        .notification-content {
            flex: 1;
            min-width: 0;
        }

        .notification-title {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 4px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .notification-message {
            font-size: 12px;
            color: var(--text-secondary);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .notification-time {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .notifications-empty {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 48px 24px;
            color: var(--text-muted);
        }

        .notifications-empty i {
            font-size: 32px;
            margin-bottom: 12px;
            opacity: 0.5;
        }

        .notifications-empty p {
            font-size: 13px;
        }

        /* ============================================
           COMPLETED TASKS FEED WIDGET
           Global view of recently completed tasks
           ============================================ */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin-top: 20px;
        }

        @media (max-width: 1024px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }

        .completed-tasks-widget {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            overflow: hidden;
        }

        .widget-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-color);
            background: rgba(246, 146, 29, 0.05);
        }

        .widget-header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .widget-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .widget-icon.success {
            background: rgba(34, 197, 94, 0.15);
            color: #4ade80;
        }

        .widget-icon.info {
            background: rgba(59, 130, 246, 0.15);
            color: #60a5fa;
        }

        .widget-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .widget-subtitle {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .widget-badge {
            background: rgba(34, 197, 94, 0.2);
            color: #4ade80;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .completed-tasks-feed {
            max-height: 400px;
            overflow-y: auto;
        }

        .completed-task-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 14px 20px;
            border-bottom: 1px solid var(--border-color);
            transition: background var(--transition-fast);
        }

        .completed-task-item:last-child {
            border-bottom: none;
        }

        .completed-task-item:hover {
            background: var(--bg-hover);
        }

        .completed-task-item.new {
            animation: taskSlideIn 0.3s ease-out;
            background: rgba(34, 197, 94, 0.08);
        }

        @keyframes taskSlideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .task-check-icon {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: rgba(34, 197, 94, 0.15);
            color: #4ade80;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            flex-shrink: 0;
        }

        .task-content {
            flex: 1;
            min-width: 0;
        }

        .task-title-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
        }

        .task-title {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .task-priority-badge {
            font-size: 9px;
            font-weight: 600;
            text-transform: uppercase;
            padding: 2px 6px;
            border-radius: 4px;
            flex-shrink: 0;
        }

        .task-priority-badge.critical {
            background: rgba(239, 68, 68, 0.2);
            color: #f87171;
        }

        .task-priority-badge.high {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
        }

        .task-priority-badge.medium {
            background: rgba(59, 130, 246, 0.2);
            color: #60a5fa;
        }

        .task-priority-badge.low {
            background: rgba(107, 114, 128, 0.2);
            color: #9ca3af;
        }

        .task-meta {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 11px;
            color: var(--text-muted);
        }

        .task-meta-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .task-meta-item i {
            font-size: 10px;
            opacity: 0.7;
        }

        .task-time {
            font-size: 11px;
            color: var(--text-muted);
            white-space: nowrap;
            flex-shrink: 0;
        }

        .feed-empty {
            padding: 48px 24px;
            text-align: center;
            color: var(--text-muted);
        }

        .feed-empty i {
            font-size: 32px;
            margin-bottom: 12px;
            opacity: 0.5;
        }

        .feed-empty p {
            font-size: 13px;
        }

        .feed-loading {
            padding: 24px;
            text-align: center;
            color: var(--text-muted);
        }

        .feed-loading i {
            font-size: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Dashboard Stats Cards */
        .dashboard-stats-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        @media (max-width: 1024px) {
            .dashboard-stats-row {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 640px) {
            .dashboard-stats-row {
                grid-template-columns: 1fr;
            }
        }

        .stat-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 16px;
            transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
            touch-action: manipulation;
            -webkit-tap-highlight-color: rgba(246, 146, 29, 0.1);
            cursor: pointer;
        }

        .stat-card:hover {
            transform: translateY(-2px);
        }

        .stat-card:active {
            transform: scale(0.97);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            border-color: var(--solaria-orange);
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .stat-icon.projects {
            background: rgba(59, 130, 246, 0.15);
            color: #60a5fa;
        }

        .stat-icon.tasks {
            background: rgba(34, 197, 94, 0.15);
            color: #4ade80;
        }

        .stat-icon.agents {
            background: rgba(168, 85, 247, 0.15);
            color: #c084fc;
        }

        .stat-icon.active {
            background: rgba(246, 146, 29, 0.15);
            color: var(--solaria-orange);
        }

        .stat-content {
            flex: 1;
        }

        .stat-label {
            font-size: 11px;
            text-transform: uppercase;
            color: var(--text-muted);
            margin-bottom: 4px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .stat-change {
            font-size: 11px;
            margin-top: 4px;
        }

        .stat-change.positive {
            color: #4ade80;
        }

        .stat-change.negative {
            color: #f87171;
        }

        .mode-toggle {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            background: var(--bg-tertiary);
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            transition: background var(--transition-fast), color var(--transition-fast), transform var(--transition-fast);
        }

        .mode-toggle:hover {
            background: var(--bg-hover);
            color: var(--solaria-orange);
        }

        .mode-toggle:active {
            transform: scale(0.95);
        }

        .mode-toggle i {
            font-size: 16px;
            transition: transform 0.3s ease;
        }

        .mode-toggle:hover i {
            transform: rotate(20deg);
        }

        .header-divider {
            width: 1px;
            height: 24px;
            background: var(--border-color);
            margin: 0 4px;
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 6px 10px 6px 6px;
            border-radius: 10px;
            background: var(--bg-tertiary);
            border: none;
            cursor: pointer;
            transition: background var(--transition-fast);
        }

        .user-menu:hover {
            background: var(--bg-hover);
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--solaria-orange);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 12px;
            color: white;
            overflow: hidden;
        }

        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .user-info {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            line-height: 1.2;
        }

        .user-name {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .user-role {
            font-size: 11px;
            color: var(--text-muted);
        }

        .user-menu i.fa-chevron-down {
            font-size: 10px;
            color: var(--text-muted);
            margin-left: 4px;
        }

        /* Content Area */
        .content-area {
            flex: 1;
            padding: 24px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* Section Header */
        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            flex-shrink: 0;
        }

        .section-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .section-subtitle {
            font-size: 13px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .section-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .content-placeholder {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            gap: 16px;
        }

        .content-placeholder i {
            font-size: 48px;
            color: var(--border-light);
        }

        .content-placeholder p {
            font-size: 16px;
        }

        /* ============================================
           Project Cards
           ============================================ */

        /* Projects Container with Horizontal Slider */
        .projects-slider {
            display: flex;
            overflow-x: auto;
            scroll-snap-type: x mandatory;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            gap: 0;
            flex: 1;
        }

        .projects-slider::-webkit-scrollbar {
            display: none;
        }

        .projects-page {
            min-width: 100%;
            scroll-snap-align: start;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            grid-template-rows: repeat(2, 1fr);
            gap: 16px;
            padding: 0 4px;
        }

        /* Page Indicators */
        .page-indicators {
            display: flex;
            justify-content: center;
            gap: 8px;
            padding: 16px 0 0;
        }

        .page-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--border-light);
            border: none;
            cursor: pointer;
            transition: all var(--transition-fast);
            padding: 0;
        }

        .page-dot.active {
            background: var(--solaria-orange);
            width: 24px;
            border-radius: 4px;
        }

        /* Project Card - Grid Version (Compact) */
        /* Scrollable container class */
        .scrollable {
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
            touch-action: pan-y;
            scrollbar-width: thin;
            scrollbar-color: var(--border-color) transparent;
        }

        .scrollable::-webkit-scrollbar {
            width: 6px;
        }

        .scrollable::-webkit-scrollbar-track {
            background: transparent;
        }

        .scrollable::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 3px;
        }

        .project-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: border-color var(--transition-fast), transform var(--transition-fast);
            touch-action: manipulation;
            -webkit-tap-highlight-color: rgba(246, 146, 29, 0.1);
        }

        .project-card:active {
            transform: scale(0.98);
        }

        .project-card:hover {
            border-color: var(--solaria-orange);
        }

        .project-card-header {
            display: flex;
            align-items: flex-start;
            gap: 14px;
            margin-bottom: 16px;
        }

        .project-icon {
            width: 48px;
            height: 48px;
            min-width: 48px;
            border-radius: 12px;
            background: linear-gradient(135deg, var(--solaria-orange), var(--solaria-orange-dark));
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .project-icon i {
            font-size: 20px;
            color: white;
        }

        .project-info {
            flex: 1;
            min-width: 0;
        }

        .project-name {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .project-description {
            font-size: 12px;
            color: var(--text-secondary);
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            line-height: 1.4;
        }

        .project-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 16px;
        }

        .project-tag {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            width: 70px;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .project-tag.blue { background: rgba(59, 130, 246, 0.2); color: #60a5fa; }
        .project-tag.green { background: rgba(34, 197, 94, 0.2); color: #4ade80; }
        .project-tag.purple { background: rgba(168, 85, 247, 0.2); color: #c084fc; }
        .project-tag.orange { background: rgba(246, 146, 29, 0.2); color: var(--solaria-orange-light); }
        .project-tag.red { background: rgba(239, 68, 68, 0.2); color: #f87171; }

        /* Progress Bar - Segmented Phases */
        .project-progress {
            margin-bottom: 16px;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .progress-label {
            font-size: 12px;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .progress-phase-badge {
            font-size: 10px;
            font-weight: 700;
            padding: 3px 10px;
            border-radius: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .progress-phase-badge.planning { background: rgba(139, 92, 246, 0.2); color: #a78bfa; }     /* Purple */
        .progress-phase-badge.development { background: rgba(6, 182, 212, 0.2); color: #22d3ee; }  /* Cyan */
        .progress-phase-badge.testing { background: rgba(20, 184, 166, 0.2); color: #2dd4bf; }     /* Teal */
        .progress-phase-badge.production { background: rgba(34, 197, 94, 0.2); color: #4ade80; }   /* Green */

        /* Mini Trello - Equalizer Style */
        .mini-trello {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 12px;
            padding: 10px 12px;
            background: var(--bg-tertiary);
            border-radius: 10px;
        }

        .trello-column {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .trello-column-header {
            font-size: 7px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            color: var(--text-muted);
            margin-bottom: 4px;
            text-align: center;
        }

        .trello-slots {
            display: flex;
            flex-direction: column-reverse;
            gap: 2px;
        }

        .trello-slot {
            height: 5px;
            border-radius: 2px;
            border: 1px solid var(--border-color);
            background: transparent;
            transition: all 0.2s ease;
        }

        .trello-slot.filled {
            border-color: transparent;
        }

        .trello-column.backlog .trello-slot.filled { background: #6b7280; }
        .trello-column.todo .trello-slot.filled { background: #f59e0b; }
        .trello-column.doing .trello-slot.filled { background: #3b82f6; }
        .trello-column.done .trello-slot.filled { background: #22c55e; }

        /* Segmented Progress Track */
        .progress-segments {
            display: flex;
            gap: 4px;
            height: 10px;
        }

        .progress-segment {
            flex: 1;
            border-radius: 5px;
            transition: all 0.3s ease;
        }

        /* Inactive segments */
        .progress-segment.inactive {
            background: var(--bg-tertiary);
        }

        /* Active segment colors - Project Phase progression (different from Trello tasks) */
        .progress-segment.planning {
            background: linear-gradient(90deg, #7c3aed, #8b5cf6);  /* Purple/Violet */
        }

        .progress-segment.development {
            background: linear-gradient(90deg, #0891b2, #06b6d4);  /* Cyan */
        }

        .progress-segment.testing {
            background: linear-gradient(90deg, #0d9488, #14b8a6);  /* Teal */
        }

        .progress-segment.production {
            background: linear-gradient(90deg, #16a34a, #22c55e);  /* Green */
        }

        /* Phase labels below segments */
        .progress-labels {
            display: flex;
            gap: 4px;
            margin-top: 6px;
        }

        .progress-label-item {
            flex: 1;
            font-size: 9px;
            text-align: center;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .progress-label-item.active {
            color: var(--text-primary);
            font-weight: 600;
        }

        .progress-label-item.completed {
            color: var(--text-secondary);
        }

        /* Stats Grid - 6 Items Responsive */
        .project-stats {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 6px;
            margin-top: auto;
        }

        .stat-item {
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 10px 4px;
            text-align: center;
            border: 1px solid transparent;
            transition: border-color var(--transition-fast), background var(--transition-fast);
            min-width: 0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .stat-item:hover {
            border-color: var(--border-light);
            background: var(--bg-hover);
        }

        .stat-icon {
            width: 24px;
            height: 24px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 4px;
            font-size: 10px;
            flex-shrink: 0;
        }

        .stat-icon.tasks { background: rgba(59, 130, 246, 0.2); color: #60a5fa; }
        .stat-icon.pending { background: rgba(245, 158, 11, 0.2); color: #fbbf24; }
        .stat-icon.completed { background: rgba(34, 197, 94, 0.2); color: #4ade80; }
        .stat-icon.budget { background: rgba(246, 146, 29, 0.2); color: var(--solaria-orange-light); }
        .stat-icon.client { background: rgba(168, 85, 247, 0.2); color: #c084fc; }
        .stat-icon.date { background: rgba(99, 102, 241, 0.2); color: #818cf8; }
        .stat-icon.docs { background: rgba(236, 72, 153, 0.2); color: #f472b6; }

        .stat-value {
            font-size: 14px;
            font-weight: 700;
            color: var(--text-primary);
            line-height: 1.2;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }

        .stat-value.green { color: #22c55e; }
        .stat-value.blue { color: #3b82f6; }
        .stat-value.orange { color: var(--solaria-orange); }
        .stat-value.purple { color: #a855f7; }
        .stat-value.yellow { color: #fbbf24; }
        .stat-value.pink { color: #f472b6; }
        .stat-value.indigo { color: #818cf8; }

        .stat-label {
            font-size: 8px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.3px;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }

        /* Project Card - Full Width Version */
        .project-card.full-width {
            padding: 24px;
        }

        .project-card.full-width .project-card-header {
            margin-bottom: 20px;
        }

        .project-card.full-width .project-icon {
            width: 64px;
            height: 64px;
        }

        .project-card.full-width .project-icon i {
            font-size: 28px;
        }

        .project-card.full-width .project-name {
            font-size: 22px;
            margin-bottom: 6px;
        }

        .project-card.full-width .project-description {
            font-size: 14px;
            -webkit-line-clamp: 3;
        }

        .project-card.full-width .project-tags {
            margin-top: 12px;
            margin-bottom: 20px;
        }

        .project-card.full-width .project-tag {
            padding: 6px 14px;
            font-size: 12px;
        }

        .project-card.full-width .progress-track {
            height: 14px;
        }

        .project-card.full-width .project-stats {
            grid-template-columns: repeat(6, 1fr);
            gap: 12px;
        }

        .project-card.full-width .stat-item {
            padding: 16px 12px;
        }

        .project-card.full-width .stat-icon {
            width: 32px;
            height: 32px;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .project-card.full-width .stat-value {
            font-size: 22px;
            margin-bottom: 6px;
        }

        .project-card.full-width .stat-label {
            font-size: 11px;
        }

        /* Project Card - Compact List Version (Grid Layout) */
        .project-card.compact {
            display: grid;
            grid-template-columns: 180px 200px minmax(100px, 1fr) 48px 48px 48px 56px 70px 80px;
            grid-template-areas: "header tags progress tasks pend done budget client date";
            align-items: center;
            gap: 12px;
            padding: 10px 16px;
            min-height: 48px;
        }

        .project-card.compact .project-card-header {
            grid-area: header;
            margin-bottom: 0;
            align-items: center;
            justify-content: center;
        }

        .project-card.compact .project-icon {
            display: none;
        }

        .project-card.compact .project-info {
            flex: 1;
            min-width: 0;
        }

        .project-card.compact .project-name {
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 0;
            line-height: 1.2;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            text-align: center;
        }

        .project-card.compact .project-description {
            display: none;
        }

        .project-card.compact .project-tags {
            grid-area: tags;
            margin-bottom: 0;
            gap: 4px;
            justify-content: center;
        }

        .project-card.compact .project-tag {
            padding: 2px 0;
            font-size: 8px;
            width: 60px;
        }

        .project-card.compact .project-progress {
            grid-area: progress;
            margin-bottom: 0;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .project-card.compact .progress-header {
            margin-bottom: 0;
            width: 100%;
            display: flex;
            position: relative;
            height: 14px;
        }

        .project-card.compact .progress-label {
            display: none;
        }

        .project-card.compact .progress-phase-badge {
            font-size: 7px;
            padding: 2px 6px;
            position: absolute;
            top: 0;
            transform: translateX(-50%);
            white-space: nowrap;
        }

        /* Position badge over corresponding phase segment */
        .project-card.compact .progress-phase-badge.planning { left: 12.5%; }
        .project-card.compact .progress-phase-badge.development { left: 37.5%; }
        .project-card.compact .progress-phase-badge.testing { left: 62.5%; }
        .project-card.compact .progress-phase-badge.production { left: 87.5%; }

        .project-card.compact .progress-segments {
            height: 5px;
            gap: 2px;
            width: 100%;
            margin-top: 4px;
        }

        .project-card.compact .progress-labels {
            display: none;
        }

        .project-card.compact .progress-phases-labels {
            display: none;
        }

        .project-card.compact .mini-trello {
            display: none;
        }

        .project-card.compact .project-stats {
            display: contents;
        }

        .project-card.compact .stat-item {
            padding: 4px;
            border-radius: 6px;
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

        .project-card.compact .stat-item:nth-child(1) { grid-area: tasks; }
        .project-card.compact .stat-item:nth-child(2) { grid-area: pend; }
        .project-card.compact .stat-item:nth-child(3) { grid-area: done; }
        .project-card.compact .stat-item:nth-child(4) { grid-area: budget; }
        .project-card.compact .stat-item:nth-child(5) { grid-area: client; }
        .project-card.compact .stat-item:nth-child(6) { grid-area: date; }

        .project-card.compact .stat-icon {
            width: 14px;
            height: 14px;
            margin: 0;
            font-size: 7px;
            flex-shrink: 0;
        }

        .project-card.compact .stat-value {
            font-size: 10px;
            font-weight: 700;
            margin-bottom: 0;
            white-space: nowrap;
            text-align: center;
        }

        .project-card.compact .stat-label {
            display: none;
        }

        .project-card.compact .project-edit-btn {
            display: none;
        }

        /* List View Header */
        .list-header {
            display: grid;
            grid-template-columns: 180px 200px minmax(100px, 1fr) 48px 48px 48px 56px 70px 80px;
            grid-template-areas: "header tags progress tasks pend done budget client date";
            align-items: center;
            gap: 12px;
            padding: 8px 16px;
            margin-bottom: 4px;
            border-bottom: 1px solid var(--border-color);
        }

        .list-header-col {
            font-size: 9px;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            text-align: center;
        }

        /* Edit Button */
        .project-edit-btn {
            padding: 8px 14px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-secondary);
            font-size: 13px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all var(--transition-fast);
        }

        .project-edit-btn:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
            border-color: var(--solaria-orange);
        }

        /* View Toggle */
        .view-toggle {
            display: flex;
            gap: 8px;
        }

        .view-toggle-btn {
            padding: 8px 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-secondary);
            font-size: 13px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all var(--transition-fast);
        }

        .view-toggle-btn.active {
            background: var(--solaria-orange);
            border-color: var(--solaria-orange);
            color: white;
        }

        .view-toggle-btn:not(.active):hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        /* Sort Buttons */
        .sort-buttons {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .sort-btn {
            padding: 6px 12px;
            background: transparent;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-muted);
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .sort-btn:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
            border-color: var(--text-muted);
        }

        .sort-btn.active {
            background: var(--solaria-orange);
            border-color: var(--solaria-orange);
            color: white;
        }

        /* Footer */
        .footer {
            height: var(--footer-height);
            min-height: var(--footer-height);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-color);
            font-size: 12px;
            color: var(--text-muted);
        }

        .footer-left {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .footer-status {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #22c55e;
        }

        .status-dot.offline {
            background: #ef4444;
        }

        /* ============================================
           Responsive - iPad & Mobile
           ============================================ */
        @media (max-width: 1024px) {
            :root {
                --sidebar-width: 240px;
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                position: absolute;
                left: 0;
                top: 0;
                bottom: 0;
                z-index: 200;
                transform: translateX(0);
                box-shadow: 4px 0 24px rgba(0, 0, 0, 0.5);
            }

            .sidebar.collapsed {
                transform: translateX(-100%);
                width: var(--sidebar-width);
                min-width: var(--sidebar-width);
            }

            .sidebar.collapsed .sidebar-title,
            .sidebar.collapsed .nav-item span,
            .sidebar.collapsed .collapse-btn span {
                opacity: 1;
                width: auto;
            }

            .mobile-menu-btn {
                display: flex !important;
            }

            .sidebar-overlay {
                display: block;
                position: absolute;
                inset: 0;
                background: rgba(0, 0, 0, 0.5);
                z-index: 150;
                opacity: 1;
                transition: opacity var(--transition-normal);
            }

            .sidebar-overlay.hidden {
                opacity: 0;
                pointer-events: none;
            }

            /* Hide elements on mobile */
            .header-center {
                display: none;
            }

            .user-info {
                display: none;
            }

            .mode-toggle span {
                display: none;
            }

            .header-divider {
                display: none;
            }

            .header {
                padding: 0 16px;
            }

            .header-title {
                font-size: 16px;
            }
        }

        @media (min-width: 769px) {
            .mobile-menu-btn {
                display: none !important;
            }

            .sidebar-overlay {
                display: none !important;
            }
        }

        /* ============================================
           Touch Optimizations
           ============================================ */

        /* Scrollable containers - touch momentum scrolling */
        .scrollable,
        .kanban-column-body,
        .projects-slider,
        .modal-content,
        .edit-modal,
        [style*="overflow-y: auto"],
        [style*="overflow-x: auto"] {
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
        }

        /* Touch-specific media query for coarse pointers (touch screens) */
        @media (pointer: coarse) {
            /* Ensure all scrollable containers have momentum scrolling */
            .kanban-column-body {
                -webkit-overflow-scrolling: touch;
                overscroll-behavior-y: contain;
                touch-action: pan-y;
                scroll-behavior: smooth;
            }

            .scrollable {
                -webkit-overflow-scrolling: touch;
                overscroll-behavior: contain;
                touch-action: pan-y;
            }

            /* Navigation items - larger touch targets */
            .nav-item {
                padding: 14px 14px;
                min-height: 48px;
            }

            .header-btn {
                width: 48px;
                height: 48px;
                min-width: 48px;
                min-height: 48px;
            }

            .collapse-btn {
                padding: 14px;
                min-width: 48px;
                min-height: 48px;
            }

            /* Task cards - larger touch targets and better feedback */
            .task-card {
                min-height: 80px;
                padding: 14px;
                cursor: pointer;
                -webkit-tap-highlight-color: rgba(246, 146, 29, 0.15);
                touch-action: manipulation;
            }

            .task-card:active {
                transform: scale(0.98);
                background: var(--bg-tertiary);
            }

            /* Kanban columns - enable vertical scrolling */
            .kanban-column {
                touch-action: pan-y;
            }

            /* Project cards - touch feedback */
            .project-card {
                min-height: 60px;
                -webkit-tap-highlight-color: rgba(246, 146, 29, 0.15);
            }

            .project-card:active {
                transform: scale(0.98);
            }

            /* List view rows - touch friendly */
            .list-table tr,
            .gantt-row {
                min-height: 52px;
                -webkit-tap-highlight-color: rgba(246, 146, 29, 0.15);
            }

            .list-table tr:active,
            .gantt-row:active {
                background: var(--bg-tertiary) !important;
            }

            /* Stat cards - touch feedback */
            .stat-card {
                min-height: 80px;
                -webkit-tap-highlight-color: rgba(246, 146, 29, 0.15);
            }

            .stat-card:active {
                transform: scale(0.97);
            }

            /* Buttons - larger touch area */
            .btn,
            .view-toggle-btn,
            .filter-btn,
            .tab-btn {
                min-height: 44px;
                min-width: 44px;
                padding: 10px 16px;
            }

            /* Dropdown and select elements */
            select,
            .dropdown-item {
                min-height: 44px;
                padding: 12px;
            }

            /* Memory cards */
            .memory-card {
                min-height: 60px;
                -webkit-tap-highlight-color: rgba(246, 146, 29, 0.15);
            }

            .memory-card:active {
                transform: scale(0.98);
            }

            /* Modal close buttons */
            .modal-close,
            .close-btn {
                min-width: 44px;
                min-height: 44px;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            /* Tab navigation */
            .view-toggle-btn {
                min-width: 80px;
            }

            /* Checkbox items - larger touch target */
            .checklist-item {
                min-height: 44px;
                padding: 8px 12px;
            }

            /* Page indicators for slider */
            .page-indicator {
                min-width: 32px;
                min-height: 32px;
                padding: 8px;
            }

            /* Links in task info */
            .task-card a,
            .url-item a {
                padding: 8px;
                min-height: 44px;
                display: inline-flex;
                align-items: center;
            }

            /* Priority badges - larger */
            .priority-badge {
                min-width: 28px;
                min-height: 22px;
                padding: 4px 8px;
            }
        }

        /* iOS Safari specific fixes */
        @supports (-webkit-touch-callout: none) {
            .kanban-column-body,
            .scrollable {
                -webkit-overflow-scrolling: touch;
            }

            /* Fix position fixed issues in iOS */
            .modal-overlay {
                position: fixed;
                -webkit-transform: translateZ(0);
            }
        }

        /* ============================================
           Project Detail - Info Cards Grid
           ============================================ */
        .info-cards-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 12px;
        }

        @media (max-width: 1024px) {
            .info-cards-grid {
                grid-template-columns: 1fr 1fr;
            }
        }

        @media (max-width: 768px) {
            .info-cards-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Tasks Summary Card */
        .tasks-summary {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 6px;
            margin-bottom: 8px;
        }

        .tasks-summary-item {
            text-align: center;
            padding: 8px 6px;
            background: var(--bg-tertiary);
            border-radius: 6px;
        }

        .tasks-summary-value {
            font-size: 20px;
            font-weight: 700;
        }

        .tasks-summary-label {
            font-size: 9px;
            text-transform: uppercase;
            color: var(--text-muted);
            margin-top: 2px;
        }

        /* Budget Graph */
        .budget-graph {
            height: 50px;
            display: flex;
            align-items: flex-end;
            gap: 3px;
            padding: 6px;
            background: var(--bg-tertiary);
            border-radius: 6px;
        }

        .budget-bar {
            flex: 1;
            background: linear-gradient(180deg, var(--solaria-orange), var(--solaria-orange-dark));
            border-radius: 3px 3px 0 0;
            min-height: 8px;
            transition: height 0.3s ease;
        }

        .budget-deadline {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 8px;
            padding: 8px;
            background: var(--bg-tertiary);
            border-radius: 6px;
        }

        .budget-deadline-icon {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: rgba(99, 102, 241, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #818cf8;
            font-size: 12px;
        }

        /* URL Links */
        .url-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .url-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 7px 10px;
            background: var(--bg-tertiary);
            border-radius: 6px;
            text-decoration: none;
            color: var(--text-primary);
            transition: background var(--transition-fast), transform var(--transition-fast);
        }

        .url-item:hover {
            background: var(--bg-hover);
            transform: translateX(4px);
        }

        .url-item:active {
            transform: scale(0.98);
        }

        .url-item-icon {
            width: 24px;
            height: 24px;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            flex-shrink: 0;
        }

        .url-item-icon.prod { background: rgba(34, 197, 94, 0.2); color: #4ade80; }
        .url-item-icon.staging { background: rgba(245, 158, 11, 0.2); color: #fbbf24; }
        .url-item-icon.local { background: rgba(99, 102, 241, 0.2); color: #818cf8; }
        .url-item-icon.repo { background: rgba(168, 85, 247, 0.2); color: #c084fc; }
        .url-item-icon.portal { background: rgba(246, 146, 29, 0.2); color: var(--solaria-orange); }

        .url-item-text {
            flex: 1;
            min-width: 0;
        }

        .url-item-label {
            font-size: 10px;
            text-transform: uppercase;
            color: var(--text-muted);
            font-weight: 600;
            letter-spacing: 0.3px;
        }

        .url-item-url {
            font-size: 12px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: var(--text-secondary);
        }

        /* Activity Split */
        .activity-split {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        @media (max-width: 768px) {
            .activity-split {
                grid-template-columns: 1fr;
            }
        }

        /* Detail 2-column grid */
        .detail-grid-2col {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 12px;
        }

        @media (max-width: 900px) {
            .detail-grid-2col {
                grid-template-columns: 1fr;
            }
        }

        /* Manual TODO */
        .todo-input-wrapper {
            display: flex;
            gap: 6px;
            margin-bottom: 8px;
        }

        .todo-input {
            flex: 1;
            padding: 8px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 12px;
            font-family: inherit;
        }

        .todo-input:focus {
            outline: none;
            border-color: var(--solaria-orange);
        }

        .todo-input::placeholder {
            color: var(--text-muted);
        }

        .todo-add-btn {
            padding: 8px 14px;
            background: var(--solaria-orange);
            border: none;
            border-radius: 6px;
            color: white;
            cursor: pointer;
            transition: background var(--transition-fast), transform var(--transition-fast);
        }

        .todo-add-btn:hover {
            background: var(--solaria-orange-dark);
        }

        .todo-add-btn:active {
            transform: scale(0.95);
        }

        .todo-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
            max-height: 200px;
            overflow-y: auto;
        }

        .todo-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 10px;
            background: var(--bg-tertiary);
            border-radius: 6px;
            transition: background var(--transition-fast);
        }

        .todo-item:hover {
            background: var(--bg-hover);
        }

        .todo-item.done {
            opacity: 0.6;
        }

        .todo-item.done .todo-text {
            text-decoration: line-through;
            color: var(--text-muted);
        }

        .todo-checkbox {
            width: 16px;
            height: 16px;
            min-width: 16px;
            border-radius: 3px;
            border: 1.5px solid var(--border-light);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-fast);
        }

        .todo-checkbox:hover {
            border-color: var(--solaria-orange);
        }

        .todo-checkbox.checked {
            background: var(--solaria-orange);
            border-color: var(--solaria-orange);
        }

        .todo-text {
            flex: 1;
            font-size: 11px;
            min-width: 0;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .todo-date {
            font-size: 9px;
            color: var(--text-muted);
            white-space: nowrap;
        }

        .todo-convert-btn {
            padding: 3px 6px;
            font-size: 9px;
            background: rgba(59, 130, 246, 0.2);
            border: none;
            border-radius: 3px;
            color: #60a5fa;
            cursor: pointer;
            font-weight: 600;
            white-space: nowrap;
            transition: all var(--transition-fast);
        }

        .todo-convert-btn:hover {
            background: rgba(59, 130, 246, 0.3);
        }

        /* Edit Project Modal */
        .edit-modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            animation: fadeIn 0.2s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .edit-modal {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            width: 100%;
            max-width: 800px;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @keyframes pulse-highlight {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(246, 146, 29, 0.7); }
            50% { transform: scale(1.02); box-shadow: 0 0 0 10px rgba(246, 146, 29, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(246, 146, 29, 0); }
        }

        .edit-modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .edit-modal-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .edit-modal-close {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            border: none;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-fast);
        }

        .edit-modal-close:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .edit-modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
        }

        .edit-modal-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        /* Form Sections */
        .form-section {
            margin-bottom: 24px;
        }

        .form-section:last-child {
            margin-bottom: 0;
        }

        .form-section-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-section-title i {
            color: var(--solaria-orange);
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        @media (max-width: 600px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-label {
            font-size: 11px;
            text-transform: uppercase;
            color: var(--text-muted);
            font-weight: 600;
            letter-spacing: 0.3px;
        }

        .form-input, .form-textarea, .form-select {
            padding: 10px 14px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 13px;
            font-family: inherit;
            transition: border-color var(--transition-fast);
        }

        .form-input:focus, .form-textarea:focus, .form-select:focus {
            outline: none;
            border-color: var(--solaria-orange);
        }

        .form-textarea {
            min-height: 80px;
            resize: vertical;
        }

        .form-select {
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23666' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 36px;
        }

        /* Action Buttons */
        .btn-primary {
            padding: 10px 20px;
            background: var(--solaria-orange);
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all var(--transition-fast);
        }

        .btn-primary:hover {
            background: var(--solaria-orange-dark);
        }

        .btn-primary:active {
            transform: scale(0.98);
        }

        .btn-secondary {
            padding: 10px 20px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 13px;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .btn-secondary:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        /* Card Title Style */
        .card-title {
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .card-title-badge {
            font-size: 10px;
            color: var(--text-muted);
            font-weight: 400;
        }

        /* ============================================
           Design Hub Styles
           ============================================ */
        .design-section {
            margin-bottom: 24px;
        }

        .design-section-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-color);
        }

        .design-section-title i {
            color: var(--solaria-orange);
            font-size: 14px;
        }

        .design-grid {
            display: grid;
            gap: 16px;
        }

        .design-grid.cols-2 {
            grid-template-columns: repeat(2, 1fr);
        }

        .design-grid.cols-3 {
            grid-template-columns: repeat(3, 1fr);
        }

        .design-grid.cols-4 {
            grid-template-columns: repeat(4, 1fr);
        }

        @media (max-width: 1024px) {
            .design-grid.cols-3,
            .design-grid.cols-4 {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .design-grid.cols-2,
            .design-grid.cols-3,
            .design-grid.cols-4 {
                grid-template-columns: 1fr;
            }
        }

        .design-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 16px;
        }

        .design-card h3 {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }

        /* ============================================
           View Toggle (Trello/Gantt/List)
           ============================================ */
        .view-toggle {
            display: flex;
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 4px;
            gap: 4px;
        }

        .view-toggle-btn {
            padding: 6px 12px;
            border: none;
            background: transparent;
            color: var(--text-muted);
            font-size: 11px;
            font-weight: 600;
            border-radius: 6px;
            cursor: pointer;
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .view-toggle-btn:hover {
            color: var(--text-primary);
        }

        .view-toggle-btn.active {
            background: var(--solaria-orange);
            color: white;
        }

        /* ============================================
           Priority Badges
           ============================================ */
        .priority-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 9px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .priority-badge.critical {
            background: rgba(239, 68, 68, 0.2);
            color: #f87171;
        }

        .priority-badge.high {
            background: rgba(249, 115, 22, 0.2);
            color: #fb923c;
        }

        .priority-badge.medium {
            background: rgba(234, 179, 8, 0.2);
            color: #facc15;
        }

        .priority-badge.low {
            background: rgba(34, 197, 94, 0.2);
            color: #4ade80;
        }

        .priority-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
        }

        .priority-badge.critical .priority-dot { background: #f87171; }
        .priority-badge.high .priority-dot { background: #fb923c; }
        .priority-badge.medium .priority-dot { background: #facc15; }
        .priority-badge.low .priority-dot { background: #4ade80; }

        /* ============================================
           Status Badges
           ============================================ */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 9px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-badge.backlog {
            background: rgba(100, 116, 139, 0.2);
            color: #94a3b8;
        }

        .status-badge.todo {
            background: rgba(245, 158, 11, 0.2);
            color: #fbbf24;
        }

        .status-badge.doing {
            background: rgba(59, 130, 246, 0.2);
            color: #60a5fa;
        }

        .status-badge.done {
            background: rgba(34, 197, 94, 0.2);
            color: #4ade80;
        }

        /* ============================================
           Assignee Avatar
           ============================================ */
        .assignee-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--bg-tertiary);
            border: 2px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 9px;
            font-weight: 600;
            color: var(--text-muted);
            overflow: hidden;
        }

        .assignee-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .assignee-avatar.agent {
            background: rgba(168, 85, 247, 0.2);
            border-color: #a855f7;
            color: #c084fc;
        }

        .assignee-stack {
            display: flex;
        }

        .assignee-stack .assignee-avatar {
            margin-left: -8px;
        }

        .assignee-stack .assignee-avatar:first-child {
            margin-left: 0;
        }

        /* ============================================
           Task Card (Full)
           ============================================ */
        .task-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px;
            cursor: pointer;
            transition: all var(--transition-fast);
            touch-action: manipulation;
            -webkit-tap-highlight-color: rgba(246, 146, 29, 0.1);
            user-select: none;
            -webkit-user-select: none;
        }

        .task-card:hover {
            border-color: var(--solaria-orange);
            transform: translateY(-2px);
        }

        .task-card:active {
            transform: scale(0.98);
            opacity: 0.9;
        }

        .task-card-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 8px;
            margin-bottom: 8px;
        }

        .task-card-title {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-primary);
            line-height: 1.3;
        }

        .task-card-desc {
            font-size: 11px;
            color: var(--text-muted);
            margin-bottom: 10px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .task-card-footer {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
        }

        .task-card-meta {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .task-card-date {
            font-size: 10px;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 4px;
        }

        /* Task Tags (DFO-036) */
        .task-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-top: 6px;
        }

        .task-tag {
            display: inline-flex;
            align-items: center;
            gap: 3px;
            font-size: 9px;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .task-tag:hover {
            filter: brightness(1.1);
            transform: scale(1.02);
        }

        .task-tag i {
            font-size: 8px;
        }

        .tag-picker {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            padding: 8px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            margin-top: 8px;
        }

        .tag-picker-item {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 11px;
            padding: 4px 10px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.15s ease;
            border: 1px solid transparent;
        }

        .tag-picker-item:hover {
            border-color: currentColor;
        }

        .tag-picker-item.selected {
            border-color: currentColor;
            box-shadow: 0 0 0 2px currentColor;
        }

        .tag-picker-item i {
            font-size: 10px;
        }

        /* iPad compact task cards */
        @media (max-width: 1024px) {
            .task-card {
                padding: 10px;
            }
            .task-card-title {
                font-size: 12px;
            }
            .task-card-desc {
                display: none;
            }
            .task-card-header {
                margin-bottom: 6px;
            }
        }

        /* ============================================
           Kanban Board (Full Trello)
           ============================================ */
        .kanban-board {
            display: flex;
            gap: 12px;
            height: 100%;
            min-height: 0;
        }

        .kanban-column {
            flex: 1;
            min-width: 0;
            background: var(--bg-tertiary);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }

        /* iPad responsive - 2x2 grid if needed */
        @media (max-width: 900px) {
            .kanban-board {
                flex-wrap: wrap;
            }
            .kanban-column {
                flex: 1 1 calc(50% - 6px);
                min-width: calc(50% - 6px);
                max-height: 45vh;
            }
        }

        @media (max-width: 600px) {
            .kanban-column {
                flex: 1 1 100%;
                min-width: 100%;
                max-height: 40vh;
            }
        }

        .kanban-column-header {
            padding: 14px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--border-color);
        }

        .kanban-column-title {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .kanban-column-title .column-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .kanban-column.backlog .column-dot { background: #64748b; }
        .kanban-column.todo .column-dot { background: #f59e0b; }
        .kanban-column.doing .column-dot { background: #3b82f6; }
        .kanban-column.done .column-dot { background: #22c55e; }

        .kanban-column-count {
            font-size: 11px;
            color: var(--text-muted);
            background: var(--bg-secondary);
            padding: 2px 8px;
            border-radius: 10px;
        }

        .kanban-column-body {
            flex: 1;
            min-height: 0;
            overflow-y: auto;
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior-y: contain;
            touch-action: pan-y;
        }

        .kanban-add-btn {
            width: 100%;
            padding: 10px;
            background: transparent;
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            color: var(--text-muted);
            font-size: 12px;
            cursor: pointer;
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .kanban-add-btn:hover {
            border-color: var(--solaria-orange);
            color: var(--solaria-orange);
            background: rgba(246, 146, 29, 0.05);
        }

        /* ============================================
           Gantt Chart
           ============================================ */
        .gantt-container {
            overflow-x: auto;
        }

        .gantt-header {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            padding: 12px 0;
            position: sticky;
            top: 0;
            background: var(--bg-primary);
        }

        .gantt-header-cell {
            flex: 0 0 80px;
            text-align: center;
            font-size: 10px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .gantt-row {
            display: flex;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            touch-action: manipulation;
            -webkit-tap-highlight-color: rgba(246, 146, 29, 0.1);
            transition: background var(--transition-fast);
        }

        .gantt-row:active {
            background: var(--bg-tertiary);
        }

        .gantt-row-label {
            flex: 0 0 180px;
            font-size: 12px;
            font-weight: 500;
            padding-right: 16px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .gantt-row-bars {
            flex: 1;
            display: flex;
            position: relative;
            height: 24px;
        }

        .gantt-bar {
            position: absolute;
            height: 20px;
            border-radius: 4px;
            top: 2px;
        }

        .gantt-bar.planning { background: linear-gradient(90deg, #a855f7, #c084fc); }
        .gantt-bar.development { background: linear-gradient(90deg, #22d3ee, #67e8f9); }
        .gantt-bar.testing { background: linear-gradient(90deg, #14b8a6, #2dd4bf); }
        .gantt-bar.production { background: linear-gradient(90deg, #22c55e, #4ade80); }
        .gantt-bar.default { background: linear-gradient(90deg, var(--solaria-orange), var(--solaria-orange-dark)); }

        /* ============================================
           List Table
           ============================================ */
        .list-table {
            width: 100%;
            border-collapse: collapse;
        }

        .list-table th {
            text-align: left;
            padding: 12px 16px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--text-muted);
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            user-select: none;
        }

        .list-table th:hover {
            color: var(--text-primary);
        }

        .list-table th.sortable::after {
            content: '';
            margin-left: 4px;
            opacity: 0.5;
        }

        .list-table th.sorted-asc::after {
            content: '';
            opacity: 1;
        }

        .list-table th.sorted-desc::after {
            content: '';
            opacity: 1;
        }

        .list-table td {
            padding: 12px 16px;
            font-size: 13px;
            border-bottom: 1px solid var(--border-color);
        }

        .list-table tbody tr {
            cursor: pointer;
            touch-action: manipulation;
            -webkit-tap-highlight-color: rgba(246, 146, 29, 0.1);
            transition: background var(--transition-fast);
        }

        .list-table tr:hover {
            background: var(--bg-hover);
        }

        .list-table tbody tr:active {
            background: var(--bg-tertiary);
        }

        /* ============================================
           Budget Elements
           ============================================ */
        .budget-summary-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }

        .budget-summary-label {
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        .budget-summary-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--solaria-orange);
            margin-bottom: 12px;
        }

        .budget-progress-bar {
            height: 8px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            overflow: hidden;
        }

        .budget-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--solaria-orange), var(--solaria-orange-dark));
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .budget-category-row {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .budget-category-name {
            flex: 0 0 120px;
            font-size: 13px;
            font-weight: 500;
        }

        .budget-category-amount {
            flex: 0 0 80px;
            font-size: 12px;
            color: var(--text-muted);
        }

        .budget-category-bar {
            flex: 1;
            height: 6px;
            background: var(--bg-tertiary);
            border-radius: 3px;
            overflow: hidden;
        }

        .budget-category-fill {
            height: 100%;
            background: var(--solaria-orange);
            border-radius: 3px;
        }

        .budget-category-pct {
            flex: 0 0 40px;
            text-align: right;
            font-size: 11px;
            color: var(--text-muted);
        }

        /* Payment Status */
        .payment-status {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 9px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .payment-status.paid {
            background: rgba(34, 197, 94, 0.2);
            color: #4ade80;
        }

        .payment-status.pending {
            background: rgba(245, 158, 11, 0.2);
            color: #fbbf24;
        }

        .payment-status.scheduled {
            background: rgba(59, 130, 246, 0.2);
            color: #60a5fa;
        }

        .payment-status.overdue {
            background: rgba(239, 68, 68, 0.2);
            color: #f87171;
        }

        .payment-row {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 14px 16px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .payment-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        .payment-icon.paid { background: rgba(34, 197, 94, 0.2); color: #4ade80; }
        .payment-icon.pending { background: rgba(245, 158, 11, 0.2); color: #fbbf24; }
        .payment-icon.scheduled { background: rgba(100, 116, 139, 0.2); color: #94a3b8; }

        .payment-info {
            flex: 1;
        }

        .payment-title {
            font-size: 13px;
            font-weight: 500;
        }

        .payment-date {
            font-size: 11px;
            color: var(--text-muted);
        }

        .payment-amount {
            font-size: 14px;
            font-weight: 600;
        }

        /* ============================================
           Environment Cards
           ============================================ */
        .env-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 16px;
            margin-bottom: 10px;
        }

        .env-card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .env-card-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .env-status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .env-status-dot.online { background: #4ade80; box-shadow: 0 0 8px #4ade80; }
        .env-status-dot.offline { background: #f87171; }
        .env-status-dot.degraded { background: #fbbf24; }
        .env-status-dot.unknown { background: #64748b; }

        .env-card-url {
            font-size: 14px;
            color: var(--solaria-orange);
            font-family: monospace;
            margin-bottom: 8px;
        }

        .env-card-meta {
            display: flex;
            gap: 16px;
            font-size: 11px;
            color: var(--text-muted);
        }

        .copy-btn {
            padding: 6px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-secondary);
            font-size: 11px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all var(--transition-fast);
        }

        .copy-btn:hover {
            background: var(--bg-hover);
            border-color: var(--solaria-orange);
            color: var(--solaria-orange);
        }

        .copy-btn.copied {
            background: rgba(34, 197, 94, 0.2);
            border-color: #4ade80;
            color: #4ade80;
        }

        /* URL Row (Compact) */
        .url-row {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 14px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            margin-bottom: 6px;
        }

        .url-row-icon {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            background: rgba(168, 85, 247, 0.2);
            color: #c084fc;
        }

        .url-row-info {
            flex: 1;
            min-width: 0;
        }

        .url-row-title {
            font-size: 12px;
            font-weight: 500;
        }

        .url-row-url {
            font-size: 11px;
            color: var(--text-muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Section Divider */
        .section-divider {
            display: flex;
            align-items: center;
            gap: 12px;
            margin: 20px 0 16px 0;
        }

        .section-divider-text {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--text-muted);
            letter-spacing: 0.5px;
        }

        .section-divider-line {
            flex: 1;
            height: 1px;
            background: var(--border-color);
        }

        /* ============================================
           Business Cards - NEGOCIOS Page
           ============================================ */
        .business-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .business-card:hover {
            border-color: var(--solaria-orange);
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(246, 146, 29, 0.15);
        }

        .business-card-header {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .business-card-icon {
            width: 44px;
            height: 44px;
            border-radius: 10px;
            background: linear-gradient(135deg, var(--solaria-orange), var(--solaria-orange-dark));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
        }

        .business-card-title {
            flex: 1;
        }

        .business-card-name {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 2px;
        }

        .business-card-category {
            font-size: 10px;
            text-transform: uppercase;
            color: var(--text-muted);
            letter-spacing: 0.5px;
        }

        .business-status {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .business-status.active {
            background: rgba(34, 197, 94, 0.15);
            color: #4ade80;
        }

        .business-status.paused {
            background: rgba(234, 179, 8, 0.15);
            color: #facc15;
        }

        .business-status.maintenance {
            background: rgba(99, 102, 241, 0.15);
            color: #818cf8;
        }

        .business-card-desc {
            font-size: 12px;
            color: var(--text-secondary);
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        /* Business Metrics Grid */
        .business-metrics {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .business-metric {
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 10px 8px;
            text-align: center;
        }

        .business-metric-value {
            font-size: 16px;
            font-weight: 700;
        }

        .business-metric-value.green { color: #4ade80; }
        .business-metric-value.blue { color: #60a5fa; }
        .business-metric-value.orange { color: var(--solaria-orange); }
        .business-metric-value.purple { color: #c084fc; }

        .business-metric-label {
            font-size: 9px;
            text-transform: uppercase;
            color: var(--text-muted);
            margin-top: 2px;
        }

        /* Revenue Indicator */
        .revenue-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 12px;
            background: rgba(34, 197, 94, 0.1);
            border-radius: 8px;
            border-left: 3px solid #4ade80;
        }

        .revenue-amount {
            font-size: 20px;
            font-weight: 700;
            color: #4ade80;
        }

        .revenue-period {
            font-size: 10px;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .revenue-growth {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .revenue-growth.positive { color: #4ade80; }
        .revenue-growth.negative { color: #f87171; }
        .revenue-growth.neutral { color: var(--text-muted); }

        /* Business Tags */
        .business-tags {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        /* Business Management Links */
        .business-links {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            padding-top: 8px;
            border-top: 1px solid var(--border-color);
        }

        .business-link {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            background: var(--bg-tertiary);
            border-radius: 6px;
            font-size: 11px;
            color: var(--text-secondary);
            text-decoration: none;
            transition: all var(--transition-fast);
        }

        .business-link:hover {
            background: var(--bg-hover);
            color: var(--solaria-orange);
        }

        .business-link i {
            font-size: 10px;
        }

        /* Business Card List View */
        .business-list-item {
            display: grid;
            grid-template-columns: 44px 1fr 120px 120px 100px;
            gap: 16px;
            align-items: center;
            padding: 14px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .business-list-item:hover {
            border-color: var(--solaria-orange);
            background: var(--bg-hover);
        }

        .business-list-mrr {
            text-align: right;
        }

        .business-list-clients {
            text-align: center;
        }

        /* Total MRR Summary Card */
        .mrr-summary-card {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.15) 0%, rgba(34, 197, 94, 0.05) 100%);
            border: 1px solid rgba(34, 197, 94, 0.3);
            border-radius: 12px;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        .mrr-summary-icon {
            width: 56px;
            height: 56px;
            border-radius: 12px;
            background: rgba(34, 197, 94, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: #4ade80;
        }

        .mrr-summary-content {
            flex: 1;
        }

        .mrr-summary-label {
            font-size: 11px;
            text-transform: uppercase;
            color: var(--text-muted);
            margin-bottom: 4px;
        }

        .mrr-summary-value {
            font-size: 28px;
            font-weight: 700;
            color: #4ade80;
        }

        .mrr-summary-stats {
            display: flex;
            gap: 24px;
        }

        .mrr-stat {
            text-align: center;
        }

        .mrr-stat-value {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .mrr-stat-label {
            font-size: 10px;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        /* Responsive Business Grid */
        .businesses-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }

        @media (max-width: 1024px) {
            .businesses-grid {
                grid-template-columns: 1fr;
            }

            .business-list-item {
                grid-template-columns: 44px 1fr 100px;
            }

            .business-list-item > .business-list-clients,
            .business-list-item > .business-status {
                display: none;
            }
        }

        @media (max-width: 768px) {
            .mrr-summary-card {
                flex-direction: column;
                text-align: center;
            }

            .mrr-summary-stats {
                width: 100%;
                justify-content: space-around;
            }
        }

        /* ============================================
           METRICS ROW CARD - Design Hub Core Component
           Estructura: Label  Value  Change%
           Basado en Twitter/X Analytics Style
           ============================================ */
        .metrics-row {
            background: var(--metric-card-bg);
            border: 1px solid var(--metric-card-border);
            border-radius: var(--metric-card-radius);
            display: flex;
            overflow: hidden;
        }

        .metrics-row.two-rows {
            flex-wrap: wrap;
        }

        .metric-cell {
            flex: 1;
            padding: var(--metric-card-padding);
            display: flex;
            flex-direction: column;
            gap: 4px;
            min-width: 0;
            position: relative;
        }

        /* Dividers between cells */
        .metric-cell:not(:last-child)::after {
            content: '';
            position: absolute;
            right: 0;
            top: 12px;
            bottom: 12px;
            width: 1px;
            background: var(--metric-divider-color);
        }

        .metrics-row.two-rows .metric-cell {
            flex: 1 1 20%;
            min-width: 120px;
        }

        .metrics-row.two-rows .metric-cell:nth-child(5)::after {
            display: none;
        }

        /* Metric Label */
        .metric-label {
            font-size: var(--metric-label-size);
            font-weight: 500;
            color: var(--metric-label-color);
            text-transform: uppercase;
            letter-spacing: 0.3px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .metric-label i {
            font-size: 10px;
        }

        .metric-label .verified {
            color: var(--color-info);
        }

        /* Metric Value */
        .metric-value {
            font-size: var(--metric-value-size);
            font-weight: var(--metric-value-weight);
            color: var(--text-primary);
            line-height: 1.1;
            display: flex;
            align-items: baseline;
            gap: 4px;
        }

        .metric-value .secondary {
            font-size: 14px;
            font-weight: 400;
            color: var(--text-muted);
        }

        /* Metric Change (percentage) */
        .metric-change {
            font-size: var(--metric-change-size);
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 3px;
        }

        .metric-change.positive {
            color: var(--color-positive);
        }

        .metric-change.negative {
            color: var(--color-negative);
        }

        .metric-change.neutral {
            color: var(--color-neutral);
        }

        .metric-change i {
            font-size: 10px;
        }

        /* Compact variant for smaller spaces */
        .metrics-row.compact .metric-cell {
            padding: 12px;
        }

        .metrics-row.compact .metric-value {
            font-size: 20px;
        }

        .metrics-row.compact .metric-label {
            font-size: 10px;
        }

        /* Highlight variant */
        .metric-cell.highlight {
            background: var(--color-positive-bg);
        }

        .metric-cell.highlight .metric-value {
            color: var(--color-positive);
        }

        .metric-cell.warning {
            background: var(--color-warning-bg);
        }

        .metric-cell.warning .metric-value {
            color: var(--color-warning);
        }

        /* Responsive */
        @media (max-width: 900px) {
            .metrics-row {
                flex-wrap: wrap;
            }

            .metric-cell {
                flex: 1 1 33.33%;
                min-width: 100px;
            }

            .metric-cell:nth-child(3)::after,
            .metric-cell:nth-child(6)::after {
                display: none;
            }

            /* Ficha page responsive */
            .ficha-split-grid {
                grid-template-columns: 1fr !important;
            }

            .ficha-client-grid {
                grid-template-columns: 1fr !important;
            }
        }

        @media (max-width: 600px) {
            .metric-cell {
                flex: 1 1 50%;
            }

            .metric-cell:nth-child(2n)::after {
                display: none;
            }

            .metrics-row.compact .metric-value {
                font-size: 18px;
            }

            /* Ficha page mobile */
            .ficha-client-header {
                flex-direction: column;
                text-align: center;
            }
        }

        /* Ficha Page Hover States */
        .ficha-doc-item:hover {
            background: var(--bg-hover) !important;
        }

        .ficha-request-item:hover {
            background: var(--bg-hover) !important;
        }

        /* ============================================
           STAT CARD - Single Metric Card
           Layout: Icon above Value above Label (all left-aligned)
           Change indicator positioned at top-right
           ============================================ */
        .stat-card {
            background: var(--metric-card-bg);
            border: 1px solid var(--metric-card-border);
            border-radius: var(--metric-card-radius);
            padding: var(--metric-card-padding);
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 6px;
        }

        /* Change indicator positioned at top-right */
        .stat-card .metric-change {
            position: absolute;
            top: var(--metric-card-padding);
            right: var(--metric-card-padding);
        }

        /* Icon at top-left */
        .stat-card .stat-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            margin-bottom: 4px;
        }

        .stat-card .stat-icon.green { background: var(--color-positive-bg); color: var(--color-positive); }
        .stat-card .stat-icon.red { background: var(--color-negative-bg); color: var(--color-negative); }
        .stat-card .stat-icon.blue { background: var(--color-info-bg); color: var(--color-info); }
        .stat-card .stat-icon.orange { background: var(--color-warning-bg); color: var(--color-warning); }
        .stat-card .stat-icon.purple { background: rgba(168, 85, 247, 0.12); color: #a855f7; }

        /* Value directly below icon */
        .stat-card .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
            line-height: 1.1;
        }

        /* Label at bottom */
        .stat-card .stat-label {
            font-size: 11px;
            font-weight: 500;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        /* Optional wrapper for value+label if needed */
        .stat-card .stat-content {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        /* ============================================
           METRICS GRID - For multiple stat cards
           ============================================ */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
        }

        .metrics-grid.cols-3 {
            grid-template-columns: repeat(3, 1fr);
        }

        .metrics-grid.cols-4 {
            grid-template-columns: repeat(4, 1fr);
        }

        .metrics-grid.cols-5 {
            grid-template-columns: repeat(5, 1fr);
        }

        @media (max-width: 768px) {
            .metrics-grid.cols-4,
            .metrics-grid.cols-5 {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar Overlay (Mobile) -->
        <div class="sidebar-overlay hidden" id="sidebarOverlay"></div>

        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <!-- Sidebar Header -->
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <img src="/solaria-logo.png" alt="SOLARIA">
                </div>
                <span class="sidebar-title">SOLARIA DFO</span>
            </div>

            <!-- Navigation -->
            <nav class="sidebar-nav">
                <a href="#dashboard" class="nav-item active" data-page="dashboard">
                    <i class="fas fa-chart-line"></i>
                    <span>Dashboard</span>
                </a>
                <a href="#proyectos" class="nav-item" data-page="proyectos">
                    <i class="fas fa-folder-open"></i>
                    <span>Proyectos</span>
                </a>
                <a href="#negocios" class="nav-item" data-page="negocios">
                    <i class="fas fa-briefcase"></i>
                    <span>Negocios</span>
                </a>
                <a href="#infraestructura" class="nav-item" data-page="infraestructura">
                    <i class="fas fa-server"></i>
                    <span>Infraestructura</span>
                </a>
                <a href="#design-hub" class="nav-item" data-page="design-hub">
                    <i class="fas fa-palette"></i>
                    <span>Design Hub</span>
                </a>
                <a href="#memorias" class="nav-item" data-page="memorias">
                    <i class="fas fa-brain"></i>
                    <span>Memorias</span>
                </a>

                <!-- External Tools -->
                <div class="nav-separator"></div>
                <a href="https://vibe.solaria.agency" target="_blank" class="nav-item nav-external" title="Abrir VibeSDK en nueva pestaa">
                    <i class="fas fa-wand-magic-sparkles"></i>
                    <span>VibeSDK</span>
                    <i class="fas fa-external-link-alt external-icon"></i>
                </a>
            </nav>

            <!-- Sidebar Footer -->
            <div class="sidebar-footer">
                <button class="collapse-btn" id="collapseBtn" title="Colapsar menu">
                    <i class="fas fa-chevron-left"></i>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <header class="header">
                <div class="header-left">
                    <button class="header-btn mobile-menu-btn" id="mobileMenuBtn">
                        <i class="fas fa-bars"></i>
                    </button>
                    <!-- Search Bar - Left aligned -->
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" placeholder="Buscar proyectos, tareas..." id="searchInput">
                    </div>
                </div>

                <div class="header-right">
                    <!-- Dark/Light Mode Toggle -->
                    <button class="mode-toggle" id="modeToggle" title="Cambiar tema">
                        <i class="fas fa-moon" id="modeIcon"></i>
                    </button>

                    <div class="header-divider"></div>

                    <!-- Notifications -->
                    <button class="header-btn" id="notificationsBtn" title="Notificaciones">
                        <i class="fas fa-bell"></i>
                        <span class="notification-badge" id="notificationBadge"></span>
                    </button>

                    <!-- Notifications Panel -->
                    <div class="notifications-panel" id="notificationsPanel">
                        <div class="notifications-header">
                            <h3><i class="fas fa-bell"></i> Notificaciones</h3>
                            <button class="notifications-clear" id="clearNotifications">Limpiar todo</button>
                        </div>
                        <div class="notifications-list" id="notificationsList">
                            <div class="notifications-empty">
                                <i class="fas fa-bell-slash"></i>
                                <p>No hay notificaciones</p>
                            </div>
                        </div>
                    </div>

                    <!-- User Menu -->
                    <button class="user-menu" id="userMenu">
                        <div class="user-avatar">
                            <img src="https://avatars.githubusercontent.com/u/carlosjperez" alt="Carlos J. Perez" onerror="this.style.display='none'; this.parentElement.innerHTML='CJ';">
                        </div>
                        <div class="user-info">
                            <span class="user-name">Carlos J. Perez</span>
                            <span class="user-role">CEO / Founder</span>
                        </div>
                        <i class="fas fa-chevron-down"></i>
                    </button>
                </div>
            </header>

            <!-- Content Area -->
            <div class="content-area" id="contentArea">
                <div class="content-placeholder">
                    <i class="fas fa-rocket"></i>
                    <p>Selecciona una opcion del menu</p>
                </div>
            </div>

            <!-- Footer -->
            <footer class="footer">
                <div class="footer-left">
                    <div class="footer-status">
                        <span class="status-dot" id="statusDot"></span>
                        <span id="statusText">Conectado</span>
                    </div>
                </div>
                <div class="footer-right">
                    <span>SOLARIA DFO v3.1.0</span>
                </div>
            </footer>
        </main>
    </div>

    <script>
        // ============================================
        // PWA Dashboard - Core JavaScript
        // ============================================

        // Project Phases
        const PROJECT_PHASES = {
            planning: { label: 'Planificacion', value: 25, color: 'phase-1' },
            development: { label: 'Desarrollo', value: 50, color: 'phase-2' },
            testing: { label: 'Testing', value: 75, color: 'phase-3' },
            production: { label: 'Produccion', value: 100, color: 'phase-4' }
        };

        // ============================================
        // API SERVICE - Conexion con Backend
        // ============================================
        const API = {
            baseUrl: window.location.origin + '/api',
            token: localStorage.getItem('dfo_token'),

            async request(endpoint, options = {}) {
                const url = `${this.baseUrl}${endpoint}`;
                const headers = {
                    'Content-Type': 'application/json',
                    ...options.headers
                };

                if (this.token) {
                    headers['Authorization'] = `Bearer ${this.token}`;
                }

                try {
                    const response = await fetch(url, {
                        ...options,
                        headers
                    });

                    if (!response.ok) {
                        if (response.status === 401) {
                            this.logout();
                            throw new Error('Session expired');
                        }
                        throw new Error(`API Error: ${response.status}`);
                    }

                    return await response.json();
                } catch (error) {
                    console.error(`API Error [${endpoint}]:`, error);
                    throw error;
                }
            },

            // Auth
            async login(username, password) {
                const data = await this.request('/auth/login', {
                    method: 'POST',
                    body: JSON.stringify({ username, password })
                });
                if (data.token) {
                    this.token = data.token;
                    localStorage.setItem('dfo_token', data.token);
                    localStorage.setItem('dfo_user', JSON.stringify(data.user));
                }
                return data;
            },

            logout() {
                this.token = null;
                localStorage.removeItem('dfo_token');
                localStorage.removeItem('dfo_user');
            },

            isAuthenticated() {
                return !!this.token;
            },

            getUser() {
                const user = localStorage.getItem('dfo_user');
                return user ? JSON.parse(user) : null;
            },

            // Projects (Public - no auth required)
            async getProjects() {
                return this.request('/public/projects');
            },

            async getProject(id) {
                return this.request(`/projects/${id}`);
            },

            async updateProject(id, data) {
                return this.request(`/projects/${id}`, {
                    method: 'PUT',
                    body: JSON.stringify(data)
                });
            },

            // Businesses (Public - no auth required)
            async getBusinesses() {
                return this.request('/public/businesses');
            },

            async getBusiness(id) {
                return this.request(`/businesses/${id}`);
            },

            async updateBusiness(id, data) {
                return this.request(`/businesses/${id}`, {
                    method: 'PUT',
                    body: JSON.stringify(data)
                });
            },

            // Tasks (Public - no auth required)
            async getTasks(projectId = null) {
                const endpoint = projectId ? `/public/tasks?project_id=${projectId}` : '/public/tasks';
                return this.request(endpoint);
            },

            async getTask(id) {
                return this.request(`/tasks/${id}`);
            },

            async createTask(data) {
                return this.request('/tasks', {
                    method: 'POST',
                    body: JSON.stringify(data)
                });
            },

            async updateTask(id, data) {
                return this.request(`/tasks/${id}`, {
                    method: 'PUT',
                    body: JSON.stringify(data)
                });
            },

            // Dashboard (uses public endpoint - no auth required)
            async getDashboard() {
                return this.request('/public/dashboard/overview');
            },

            // Recent completed tasks (global - public endpoint)
            async getRecentCompletedTasks(limit = 20) {
                return this.request(`/public/tasks/recent-completed?limit=${limit}`);
            },

            // Recent tasks by project (for New Tasks widget - public endpoint)
            async getRecentTasksByProject(limit = 30, days = 7) {
                return this.request(`/public/tasks/recent-by-project?limit=${limit}&days=${days}`);
            },

            // C-Suite
            async getCEODashboard() {
                return this.request('/csuite/ceo');
            },

            // Health check
            async health() {
                return this.request('/health');
            },

            // Task Tags (DFO-036)
            async getTags() {
                return this.request('/tags');
            },

            async getTaskTags(taskId) {
                return this.request(`/tasks/${taskId}/tags`);
            },

            async addTaskTag(taskId, tagName) {
                return this.request(`/tasks/${taskId}/tags`, {
                    method: 'POST',
                    body: JSON.stringify({ tag_name: tagName })
                });
            },

            async removeTaskTag(taskId, tagId) {
                return this.request(`/tasks/${taskId}/tags/${tagId}`, {
                    method: 'DELETE'
                });
            },

            // Task Items (Checklist) - DFO-043
            async getTaskItems(taskId) {
                return this.request(`/tasks/${taskId}/items`);
            },

            async createTaskItem(taskId, data) {
                return this.request(`/tasks/${taskId}/items`, {
                    method: 'POST',
                    body: JSON.stringify(data)
                });
            },

            async updateTaskItem(taskId, itemId, data) {
                return this.request(`/tasks/${taskId}/items/${itemId}`, {
                    method: 'PUT',
                    body: JSON.stringify(data)
                });
            },

            async completeTaskItem(taskId, itemId, notes = null, actualMinutes = null) {
                return this.request(`/tasks/${taskId}/items/${itemId}/complete`, {
                    method: 'POST',
                    body: JSON.stringify({ notes, actual_minutes: actualMinutes })
                });
            }
        };

        // Data containers (populated from API)
        let PROJECTS_DATA = [];
        let BUSINESSES_DATA = [];
        let TASKS_DATA = [];
        let TASK_TAGS_DATA = []; // DFO-036: Available task tags
        let API_CONNECTED = false;

        /*
         * TAG CATEGORIES (3 fixed categories):
         * 1. TYPE (Tipo de Proyecto): WEBSITE, SAAS, ECOMM, DESIGN, PORTAL, API, APP
         * 2. TECH (Tecnologa): REACT, NEXT, NODE, WP, VUE, TS, PYTHON
         * 3. BIZ (Modelo de Negocio): MULTI, B2B, B2C, INTERN, AGENCY, STARTUP
         *
         * Colors: blue=TYPE, green=TECH, purple=BIZ
         */
        // FALLBACK DATA - Used when API is unavailable (offline mode)
        const PROJECTS_DATA_FALLBACK = [
            {
                id: 1,
                name: 'Akademate.com',
                description: 'Plataforma SaaS Multi-tenant para Academias de Formacion Profesional',
                icon: 'fa-graduation-cap',
                tags: [
                    { label: 'SAAS', color: 'blue' },      // TYPE
                    { label: 'REACT', color: 'green' },   // TECH
                    { label: 'MULTI', color: 'purple' }   // BIZ
                ],
                phase: 'testing',
                stats: {
                    tasks: 25,
                    pending: 6,
                    completed: 19,
                    budget: 150000,
                    client: 'SOLARIA',
                    deadline: '2025-02-15'
                },
                board: { backlog: 3, todo: 4, doing: 2, done: 16 },
                // Extended data
                client: {
                    name: 'SOLARIA AGENCY',
                    website: 'https://solaria.agency',
                    address: 'Av. Reforma 123, Col. Centro, CDMX, Mexico',
                    fiscalName: 'SOLARIA AGENCY S.A. de C.V.',
                    rfc: 'SOL240101XXX',
                    contactName: 'Carlos J. Perez',
                    contactEmail: 'carlos@solaria.agency',
                    contactPhone: '+52 55 1234 5678'
                },
                urls: {
                    production: 'https://akademate.com',
                    staging: 'https://staging.akademate.com',
                    local: 'http://localhost:3000',
                    repository: 'https://github.com/SOLARIA-AGENCY/akademate',
                    projectPortal: 'https://dfo.solaria.agency/projects/1'
                },
                documents: [
                    { name: 'Especificacion Tecnica', url: '#', type: 'spec', date: '2024-10-15' },
                    { name: 'Contrato de Desarrollo', url: '#', type: 'contract', date: '2024-09-01' },
                    { name: 'Manual de Usuario', url: '#', type: 'manual', date: '2024-12-01' },
                    { name: 'Diseo UI/UX Figma', url: '#', type: 'design', date: '2024-10-20' }
                ],
                requests: [
                    { id: 1, text: 'Agregar soporte para pagos con Stripe', status: 'approved', priority: 'high', date: '2024-12-10' },
                    { id: 2, text: 'Implementar notificaciones push', status: 'pending', priority: 'medium', date: '2024-12-08' },
                    { id: 3, text: 'Dashboard de analiticas para administradores', status: 'in_review', priority: 'high', date: '2024-12-05' }
                ],
                manualTodos: [
                    { id: 1, text: 'Revisar diseo del dashboard de tenants', done: false, createdAt: '2024-12-12' },
                    { id: 2, text: 'Aprobar paleta de colores final', done: true, createdAt: '2024-12-08' },
                    { id: 3, text: 'Validar flujo de registro de academias', done: false, createdAt: '2024-12-10' }
                ]
            },
            {
                id: 2,
                name: 'PRILABSA Website',
                description: 'Website corporativo con CMS WordPress y API REST personalizada',
                icon: 'fa-globe',
                tags: [
                    { label: 'WEB', color: 'blue' },      // TYPE
                    { label: 'WP', color: 'green' },      // TECH
                    { label: 'B2B', color: 'purple' }     // BIZ
                ],
                phase: 'production',
                stats: {
                    tasks: 18,
                    pending: 1,
                    completed: 17,
                    budget: 45000,
                    client: 'PRILABSA',
                    deadline: '2025-01-10'
                },
                board: { backlog: 0, todo: 1, doing: 0, done: 17 },
                client: {
                    name: 'PRILABSA S.A.',
                    website: 'https://prilabsa.com',
                    address: 'Zona Industrial Norte, Monterrey, NL',
                    fiscalName: 'PRILABSA S.A. de C.V.',
                    rfc: 'PRI980515ABC',
                    contactName: 'Roberto Martinez',
                    contactEmail: 'rmartinez@prilabsa.com',
                    contactPhone: '+52 81 8765 4321'
                },
                urls: {
                    production: 'https://prilabsa.com',
                    staging: 'https://staging.prilabsa.solaria.agency',
                    local: 'http://localhost:8080',
                    repository: 'https://github.com/SOLARIA-AGENCY/prilabsa-website',
                    projectPortal: 'https://dfo.solaria.agency/projects/2'
                },
                documents: [
                    { name: 'Brief Creativo', url: '#', type: 'spec', date: '2024-11-01' },
                    { name: 'Contrato', url: '#', type: 'contract', date: '2024-10-15' }
                ],
                requests: [
                    { id: 1, text: 'Seccion de catalogo de productos', status: 'completed', priority: 'high', date: '2024-11-20' }
                ],
                manualTodos: [
                    { id: 1, text: 'Optimizar imagenes de productos', done: false, createdAt: '2024-12-14' }
                ]
            },
            {
                id: 3,
                name: 'SOLARIA DFO',
                description: 'Oficina Digital de Construccion en Campo con dashboards ejecutivos',
                icon: 'fa-building',
                tags: [
                    { label: 'APP', color: 'blue' },      // TYPE
                    { label: 'NODE', color: 'green' },    // TECH
                    { label: 'INTERN', color: 'purple' }  // BIZ
                ],
                phase: 'testing',
                stats: {
                    tasks: 32,
                    pending: 5,
                    completed: 27,
                    budget: 80000,
                    client: 'SOLARIA',
                    deadline: '2025-01-30'
                },
                board: { backlog: 2, todo: 2, doing: 1, done: 27 },
                client: {
                    name: 'SOLARIA AGENCY (Internal)',
                    website: 'https://solaria.agency',
                    address: 'Av. Reforma 123, Col. Centro, CDMX',
                    fiscalName: 'SOLARIA AGENCY S.A. de C.V.',
                    rfc: 'SOL240101XXX',
                    contactName: 'Carlos J. Perez',
                    contactEmail: 'carlos@solaria.agency',
                    contactPhone: '+52 55 1234 5678'
                },
                urls: {
                    production: 'https://dfo.solaria.agency',
                    staging: 'https://staging-dfo.solaria.agency',
                    local: 'http://localhost:3030',
                    repository: 'https://github.com/SOLARIA-AGENCY/solaria-digital-field--operations',
                    projectPortal: 'https://dfo.solaria.agency/projects/3'
                },
                documents: [
                    { name: 'Arquitectura v3.0', url: '#', type: 'spec', date: '2024-12-10' },
                    { name: 'CLAUDE.md', url: '#', type: 'manual', date: '2024-12-13' }
                ],
                requests: [
                    { id: 1, text: 'Vista Kanban fullscreen para iPad', status: 'in_progress', priority: 'high', date: '2024-12-14' },
                    { id: 2, text: 'Integracion MCP remota', status: 'completed', priority: 'high', date: '2024-12-01' }
                ],
                manualTodos: [
                    { id: 1, text: 'Implementar pagina de detalle de proyecto', done: false, createdAt: '2024-12-14' },
                    { id: 2, text: 'Agregar graficos de presupuesto', done: false, createdAt: '2024-12-13' }
                ]
            },
            {
                id: 4,
                name: 'CEP Comunicacion',
                description: 'Portal de comunicaciones internas con gestion de contenido multimedia',
                icon: 'fa-comments',
                tags: [
                    { label: 'PORTAL', color: 'blue' },   // TYPE
                    { label: 'NEXT', color: 'green' },    // TECH
                    { label: 'B2B', color: 'purple' }     // BIZ
                ],
                phase: 'development',
                stats: {
                    tasks: 40,
                    pending: 22,
                    completed: 18,
                    budget: 120000,
                    client: 'CEP',
                    deadline: '2025-03-20'
                },
                board: { backlog: 8, todo: 10, doing: 4, done: 18 },
                client: {
                    name: 'CEP Comunicaciones',
                    website: 'https://cepcomunicacion.com',
                    address: 'Polanco, CDMX, Mexico',
                    fiscalName: 'CEP Comunicaciones S.A. de C.V.',
                    rfc: 'CEP200301XYZ',
                    contactName: 'Ana Garcia',
                    contactEmail: 'agarcia@cepcomunicacion.com',
                    contactPhone: '+52 55 9876 5432'
                },
                urls: {
                    production: 'https://cepcomunicacion.com',
                    staging: 'https://staging.cepcomunicacion.com',
                    local: 'http://localhost:3001',
                    repository: 'https://github.com/SOLARIA-AGENCY/cep-comunicacion',
                    projectPortal: 'https://dfo.solaria.agency/projects/4'
                },
                documents: [
                    { name: 'Propuesta Tecnica', url: '#', type: 'spec' },
                    { name: 'Wireframes v2', url: '#', type: 'design' },
                    { name: 'Contrato', url: '#', type: 'contract' }
                ],
                manualTodos: [
                    { id: 1, text: 'Definir estructura de navegacion', done: true, createdAt: '2024-12-05' },
                    { id: 2, text: 'Revisar prototipo de video player', done: false, createdAt: '2024-12-11' }
                ]
            },
            {
                id: 5,
                name: 'Luxe Boutique',
                description: 'E-commerce de lujo con experiencia de compra premium personalizada',
                icon: 'fa-gem',
                tags: [
                    { label: 'ECOMM', color: 'blue' },    // TYPE
                    { label: 'REACT', color: 'green' },   // TECH
                    { label: 'B2C', color: 'purple' }     // BIZ
                ],
                phase: 'planning',
                stats: {
                    tasks: 50,
                    pending: 35,
                    completed: 15,
                    budget: 200000,
                    client: 'Luxe Inc',
                    deadline: '2025-06-01'
                },
                board: { backlog: 20, todo: 12, doing: 3, done: 15 },
                client: {
                    name: 'Luxe Inc.',
                    website: 'https://luxe.mx',
                    address: 'Santa Fe, CDMX, Mexico',
                    fiscalName: 'Luxe Fashion Inc. S.A. de C.V.',
                    rfc: 'LUX190815QRS',
                    contactName: 'Sofia Hernandez',
                    contactEmail: 'sofia@luxe.mx',
                    contactPhone: '+52 55 5555 1234'
                },
                urls: {
                    production: null,
                    staging: 'https://staging.luxe.mx',
                    local: 'http://localhost:3002',
                    repository: 'https://github.com/SOLARIA-AGENCY/luxe-boutique',
                    projectPortal: 'https://dfo.solaria.agency/projects/5'
                },
                documents: [
                    { name: 'Brief E-commerce', url: '#', type: 'spec' },
                    { name: 'Catalogo de Productos', url: '#', type: 'design' }
                ],
                manualTodos: [
                    { id: 1, text: 'Revisar catalogo de productos inicial', done: false, createdAt: '2024-12-13' },
                    { id: 2, text: 'Definir pasarelas de pago', done: false, createdAt: '2024-12-10' },
                    { id: 3, text: 'Aprobar moodboard visual', done: true, createdAt: '2024-12-01' }
                ]
            },
            {
                id: 6,
                name: 'BRIK-64 Design',
                description: 'Sistema de diseno modular con componentes reutilizables',
                icon: 'fa-cubes',
                tags: [
                    { label: 'DESIGN', color: 'blue' },   // TYPE
                    { label: 'TS', color: 'green' },      // TECH
                    { label: 'AGENCY', color: 'purple' }  // BIZ
                ],
                phase: 'development',
                stats: {
                    tasks: 28,
                    pending: 11,
                    completed: 17,
                    budget: 35000,
                    client: 'SOLARIA',
                    deadline: '2025-02-28'
                },
                board: { backlog: 5, todo: 4, doing: 2, done: 17 },
                client: {
                    name: 'SOLARIA AGENCY (Internal)',
                    website: 'https://solaria.agency',
                    address: 'Av. Reforma 123, Col. Centro, CDMX',
                    fiscalName: 'SOLARIA AGENCY S.A. de C.V.',
                    rfc: 'SOL240101XXX',
                    contactName: 'Carlos J. Perez',
                    contactEmail: 'carlos@solaria.agency',
                    contactPhone: '+52 55 1234 5678'
                },
                urls: {
                    production: null,
                    staging: 'https://brik64.solaria.agency',
                    local: 'http://localhost:6006',
                    repository: 'https://github.com/SOLARIA-AGENCY/brik-64',
                    projectPortal: 'https://dfo.solaria.agency/projects/6'
                },
                documents: [
                    { name: 'Design Tokens Spec', url: '#', type: 'spec' },
                    { name: 'Component Library', url: '#', type: 'manual' }
                ],
                manualTodos: [
                    { id: 1, text: 'Completar componentes de formulario', done: false, createdAt: '2024-12-12' },
                    { id: 2, text: 'Documentar design tokens', done: true, createdAt: '2024-12-08' }
                ]
            }
        ];

        /**
         * BUSINESSES_DATA_FALLBACK - Negocios operativos y generando ingresos
         * A diferencia de PROYECTOS (en desarrollo), estos son negocios consolidados
         * con metricas de facturacion, clientes activos, y gestiones de negocio.
         * FALLBACK DATA - Used when API is unavailable (offline mode)
         */
        const BUSINESSES_DATA_FALLBACK = [
            {
                id: 1,
                name: 'Akademate Platform',
                description: 'Plataforma SaaS para academias con 12 tenants activos pagando suscripcion',
                icon: 'fa-graduation-cap',
                category: 'SAAS',
                status: 'active', // active, paused, maintenance
                // Business metrics
                metrics: {
                    mrr: 48000,           // Monthly Recurring Revenue (MXN)
                    arr: 576000,          // Annual Recurring Revenue
                    clients: 12,          // Tenants/Clients activos
                    churnRate: 2.5,       // % mensual
                    avgTicket: 4000,      // Ticket promedio por cliente
                    growth: 15            // % crecimiento mensual
                },
                // Billing info
                billing: {
                    lastInvoice: '2024-12-01',
                    nextInvoice: '2025-01-01',
                    paymentMethod: 'Stripe Subscriptions',
                    currency: 'MXN'
                },
                // Management URLs
                management: {
                    admin: 'https://akademate.com/admin',
                    billing: 'https://dashboard.stripe.com/akademate',
                    analytics: 'https://analytics.google.com/akademate',
                    support: 'https://support.akademate.com'
                },
                // Client company
                owner: {
                    name: 'SOLARIA AGENCY',
                    type: 'Producto propio',
                    since: '2024-06-01'
                },
                // Tags for filtering
                tags: [
                    { label: 'SAAS', color: 'blue' },
                    { label: 'B2B', color: 'purple' },
                    { label: 'RECURRENTE', color: 'green' }
                ]
            },
            {
                id: 2,
                name: 'PRILABSA Digital',
                description: 'Website corporativo con mantenimiento mensual y actualizaciones de contenido',
                icon: 'fa-globe',
                category: 'MANTENIMIENTO',
                status: 'active',
                metrics: {
                    mrr: 8500,
                    arr: 102000,
                    clients: 1,
                    churnRate: 0,
                    avgTicket: 8500,
                    growth: 0
                },
                billing: {
                    lastInvoice: '2024-12-05',
                    nextInvoice: '2025-01-05',
                    paymentMethod: 'Transferencia bancaria',
                    currency: 'MXN'
                },
                management: {
                    admin: 'https://prilabsa.com/wp-admin',
                    billing: 'https://facturacion.solaria.agency/prilabsa',
                    analytics: 'https://analytics.google.com/prilabsa',
                    support: 'mailto:soporte@solaria.agency'
                },
                owner: {
                    name: 'PRILABSA S.A.',
                    type: 'Cliente externo',
                    since: '2024-01-15'
                },
                tags: [
                    { label: 'WEB', color: 'blue' },
                    { label: 'B2B', color: 'purple' },
                    { label: 'FIJO', color: 'green' }
                ]
            },
            {
                id: 3,
                name: 'CEP Media Portal',
                description: 'Portal de contenido multimedia con suscripcion anual y soporte premium',
                icon: 'fa-play-circle',
                category: 'LICENCIA',
                status: 'active',
                metrics: {
                    mrr: 25000,
                    arr: 300000,
                    clients: 1,
                    churnRate: 0,
                    avgTicket: 25000,
                    growth: 8
                },
                billing: {
                    lastInvoice: '2024-11-01',
                    nextInvoice: '2025-11-01',
                    paymentMethod: 'Factura anual',
                    currency: 'MXN'
                },
                management: {
                    admin: 'https://media.cepcomunicacion.com/admin',
                    billing: 'https://facturacion.solaria.agency/cep',
                    analytics: 'https://plausible.io/cepcomunicacion',
                    support: 'https://tickets.solaria.agency/cep'
                },
                owner: {
                    name: 'CEP Comunicaciones',
                    type: 'Cliente externo',
                    since: '2023-11-01'
                },
                tags: [
                    { label: 'MEDIA', color: 'blue' },
                    { label: 'B2B', color: 'purple' },
                    { label: 'ANUAL', color: 'green' }
                ]
            },
            {
                id: 4,
                name: 'SOLARIA Consulting',
                description: 'Servicios de consultoria tecnica con facturacion por horas',
                icon: 'fa-lightbulb',
                category: 'SERVICIOS',
                status: 'active',
                metrics: {
                    mrr: 65000,
                    arr: 780000,
                    clients: 4,
                    churnRate: 5,
                    avgTicket: 16250,
                    growth: 12
                },
                billing: {
                    lastInvoice: '2024-12-10',
                    nextInvoice: '2025-01-10',
                    paymentMethod: 'Factura mensual',
                    currency: 'MXN'
                },
                management: {
                    admin: 'https://consulting.solaria.agency/dashboard',
                    billing: 'https://facturacion.solaria.agency/consulting',
                    analytics: 'https://toggl.com/solaria',
                    support: 'https://calendar.google.com/solaria'
                },
                owner: {
                    name: 'SOLARIA AGENCY',
                    type: 'Servicio propio',
                    since: '2023-01-01'
                },
                tags: [
                    { label: 'CONSULTING', color: 'blue' },
                    { label: 'B2B', color: 'purple' },
                    { label: 'VARIABLE', color: 'green' }
                ]
            }
        ];

        // ============================================
        // INFRASTRUCTURE DATA
        // ============================================
        const INFRASTRUCTURE_DATA = {
            vps: [
                {
                    id: 1,
                    name: 'SOLARIA Production',
                    provider: 'Hetzner',
                    ip: '46.62.222.138',
                    hostname: 'srv943151',
                    os: 'Ubuntu 24.04 LTS',
                    status: 'online',
                    specs: { cpu: '4 vCPU', ram: '8GB', disk: '160GB NVMe' },
                    services: ['Apache 2.4', 'PHP 8.4', 'MariaDB 11.4', 'Node 22', 'PM2'],
                    ssh: 'ssh root@46.62.222.138',
                    urls: {
                        frontend: 'http://46.62.222.138/',
                        admin: 'http://46.62.222.138/admin',
                        api: 'http://46.62.222.138/api'
                    }
                },
                {
                    id: 2,
                    name: 'NEMESIS Server',
                    provider: 'Hostinger',
                    ip: '148.230.118.124',
                    hostname: 'nemesis-server',
                    os: 'Ubuntu 22.04 LTS',
                    status: 'online',
                    specs: { cpu: '2 vCPU', ram: '4GB', disk: '80GB SSD' },
                    services: ['Nginx', 'Docker', 'Node 20'],
                    ssh: 'ssh root@148.230.118.124'
                }
            ],
            nemesis: [
                { id: 1, name: 'origin-command01', ip: '100.122.193.83', os: 'macOS Sequoia', role: 'Centro de comando', status: 'active' },
                { id: 2, name: 'Mac-Mini-DRAKE', ip: '100.79.246.5', os: 'macOS (M2)', role: 'Servidor dev/prod', status: 'active' },
                { id: 3, name: 'DRAKE-COMMAND01', ip: '100.64.226.80', os: 'Linux', role: 'Automatizacion', status: 'config' },
                { id: 4, name: 'iPad-Drake-Command', ip: '100.87.12.24', os: 'iOS', role: 'Comando movil', status: 'active' },
                { id: 5, name: 'iPhone-400i', ip: '100.112.92.21', os: 'iOS', role: 'Comando movil', status: 'active' }
            ],
            cloudflare: [
                { id: 1, domain: 'solaria.agency', plan: 'Pro', ssl: 'Full Strict', status: 'active' },
                { id: 2, domain: 'akademate.com', plan: 'Free', ssl: 'Full', status: 'active' },
                { id: 3, domain: 'prilabsa.com', plan: 'Free', ssl: 'Full', status: 'active' }
            ],
            sshKeys: [
                { name: 'nemesis_cmdr_key', type: 'Ed25519', purpose: 'Acceso universal NEMESIS' },
                { name: 'id_ed25519', type: 'Ed25519', purpose: 'Clave personal' },
                { name: 'id_solaria_hetzner_prod', type: 'Ed25519', purpose: 'Servidor SOLARIA' }
            ],
            databases: [
                { id: 1, name: 'solaria_production', type: 'MariaDB 11.4', server: 'SOLARIA Production', size: '2.4GB' },
                { id: 2, name: 'akademate_db', type: 'PostgreSQL 16', server: 'SOLARIA Production', size: '850MB' },
                { id: 3, name: 'wordpress_cms', type: 'MariaDB 11.4', server: 'SOLARIA Production', size: '125MB' }
            ]
        };

        const App = {
            elements: {
                sidebar: document.getElementById('sidebar'),
                sidebarOverlay: document.getElementById('sidebarOverlay'),
                collapseBtn: document.getElementById('collapseBtn'),
                mobileMenuBtn: document.getElementById('mobileMenuBtn'),
                contentArea: document.getElementById('contentArea'),
                statusDot: document.getElementById('statusDot'),
                statusText: document.getElementById('statusText'),
                navItems: document.querySelectorAll('.nav-item'),
                // Notifications elements
                notificationsBtn: document.getElementById('notificationsBtn'),
                notificationBadge: document.getElementById('notificationBadge'),
                notificationsPanel: document.getElementById('notificationsPanel'),
                notificationsList: document.getElementById('notificationsList'),
                clearNotifications: document.getElementById('clearNotifications')
            },

            state: {
                sidebarCollapsed: localStorage.getItem('sidebarCollapsed') === 'true',
                currentPage: 'dashboard',
                isOnline: navigator.onLine,
                projectsView: localStorage.getItem('projectsView') || 'grid',
                currentProjectPage: 0,
                currentProjectId: null,
                currentProject: null,
                currentTasks: [],
                tasksView: 'kanban',
                darkMode: localStorage.getItem('theme') !== 'light',
                // Notifications state
                notifications: JSON.parse(localStorage.getItem('dfo_notifications') || '[]'),
                notificationsPanelOpen: false
            },

            socket: null,

            async init() {
                this.bindEvents();
                this.restoreSidebarState();
                this.restoreTheme();
                this.updateOnlineStatus();

                // Load data from API (with fallback to static data)
                await this.loadDataFromAPI();

                this.handleInitialRoute();

                // Initialize Socket.IO and notifications
                this.initSocket();
                this.initNotifications();

                // Prevent default touch behaviors that cause bounce - but allow scrolling in containers
                document.body.addEventListener('touchmove', (e) => {
                    // Allow scrolling in all these scrollable containers
                    const scrollableSelectors = [
                        '.scrollable',
                        '.projects-slider',
                        '.kanban-column-body',
                        '.modal-content',
                        '.edit-modal',
                        '.list-table',
                        '.gantt-container',
                        '.memories-container',
                        '[style*="overflow-y: auto"]',
                        '[style*="overflow-x: auto"]',
                        'select',
                        'input',
                        'textarea'
                    ];

                    // Check if target is inside any scrollable container
                    const isScrollable = scrollableSelectors.some(selector => e.target.closest(selector));
                    if (isScrollable) return;

                    // Also allow if the element has CSS overflow set to auto/scroll
                    let el = e.target;
                    while (el && el !== document.body) {
                        const style = getComputedStyle(el);
                        if (style.overflowY === 'auto' || style.overflowY === 'scroll' ||
                            style.overflowX === 'auto' || style.overflowX === 'scroll') {
                            return;
                        }
                        el = el.parentElement;
                    }

                    e.preventDefault();
                }, { passive: false });

                console.log('SOLARIA DFO PWA Dashboard initialized');
                console.log(`API Connected: ${API_CONNECTED}, Projects: ${PROJECTS_DATA.length}, Businesses: ${BUSINESSES_DATA.length}`);
            },

            async loadDataFromAPI() {
                try {
                    // Try to load from API (including task tags)
                    const [projectsRes, businessesRes, tasksRes, tagsRes] = await Promise.all([
                        API.getProjects().catch(e => null),
                        API.getBusinesses().catch(e => null),
                        API.getTasks().catch(e => null),
                        API.getTags().catch(e => null)
                    ]);

                    if (projectsRes && projectsRes.projects) {
                        PROJECTS_DATA = this.transformProjectsFromAPI(projectsRes.projects);
                        API_CONNECTED = true;
                        console.log(`Loaded ${PROJECTS_DATA.length} projects from API`);
                    } else {
                        PROJECTS_DATA = [...PROJECTS_DATA_FALLBACK];
                        console.warn('Using fallback projects data');
                    }

                    if (businessesRes && businessesRes.businesses) {
                        BUSINESSES_DATA = this.transformBusinessesFromAPI(businessesRes.businesses);
                        console.log(`Loaded ${BUSINESSES_DATA.length} businesses from API`);
                    } else {
                        BUSINESSES_DATA = [...BUSINESSES_DATA_FALLBACK];
                        console.warn('Using fallback businesses data');
                    }

                    if (tasksRes && tasksRes.tasks) {
                        TASKS_DATA = tasksRes.tasks;
                        console.log(`Loaded ${TASKS_DATA.length} tasks from API`);
                    }

                    // Load task tags (DFO-036)
                    if (tagsRes && tagsRes.tags) {
                        TASK_TAGS_DATA = tagsRes.tags;
                        console.log(`Loaded ${TASK_TAGS_DATA.length} task tags from API`);
                    }

                    this.updateConnectionStatus(API_CONNECTED);

                } catch (error) {
                    console.error('Error loading data from API:', error);
                    PROJECTS_DATA = [...PROJECTS_DATA_FALLBACK];
                    BUSINESSES_DATA = [...BUSINESSES_DATA_FALLBACK];
                    this.updateConnectionStatus(false);
                }
            },

            transformProjectsFromAPI(apiProjects) {
                return apiProjects.map(p => {
                    // Calculate phase dynamically based on task completion
                    const totalTasks = p.task_count || 0;
                    const completedTasks = p.completed_tasks || 0;
                    const inProgressTasks = p.in_progress_tasks || 0;
                    const completionPct = totalTasks > 0 ? (completedTasks / totalTasks) * 100 : 0;

                    let calculatedPhase = p.status || 'planning';
                    if (completionPct >= 90) {
                        calculatedPhase = 'production';
                    } else if (completionPct >= 60) {
                        calculatedPhase = 'testing';
                    } else if (inProgressTasks > 0 || completedTasks > 0) {
                        calculatedPhase = 'development';
                    }

                    return {
                    id: p.id,
                    name: p.name,
                    description: p.description || '',
                    icon: this.getProjectIcon(p.name),
                    tags: this.generateProjectTags(p),
                    phase: calculatedPhase,
                    stats: {
                        tasks: totalTasks,
                        pending: p.pending_tasks || 0,
                        inProgress: inProgressTasks,
                        completed: completedTasks,
                        review: p.review_tasks || 0,
                        blocked: p.blocked_tasks || 0,
                        budget: parseFloat(p.budget) || 0,
                        client: p.client || '',
                        deadline: p.end_date || ''
                    },
                    board: {
                        backlog: p.blocked_tasks || 0,
                        todo: p.pending_tasks || 0,
                        doing: inProgressTasks + (p.review_tasks || 0),
                        done: completedTasks
                    },
                    client: {
                        name: p.client || '',
                        website: '',
                        address: '',
                        fiscalName: '',
                        rfc: '',
                        contactName: '',
                        contactEmail: '',
                        contactPhone: ''
                    },
                    urls: {
                        production: '',
                        staging: '',
                        local: '',
                        repository: '',
                        projectPortal: `https://dfo.solaria.agency/projects/${p.id}`
                    },
                    documents: [],
                    requests: [],
                    manualTodos: []
                };});
            },

            transformBusinessesFromAPI(apiBusinesses) {
                return apiBusinesses.map(b => ({
                    id: b.id,
                    name: b.name,
                    description: b.description || '',
                    icon: this.getBusinessIcon(b.name),
                    category: 'GENERAL',
                    status: b.status || 'inactive',
                    metrics: {
                        mrr: parseFloat(b.revenue) || 0,
                        arr: (parseFloat(b.revenue) || 0) * 12,
                        clients: 0,
                        churnRate: 0,
                        avgTicket: 0,
                        growth: 0
                    },
                    billing: {
                        lastInvoice: '',
                        nextInvoice: '',
                        paymentMethod: '',
                        currency: 'MXN'
                    },
                    management: {
                        admin: b.website || '',
                        billing: '',
                        analytics: '',
                        support: ''
                    },
                    owner: {
                        name: b.name,
                        type: 'Producto propio',
                        since: ''
                    },
                    tags: [
                        { label: 'NEGOCIO', color: 'blue' }
                    ]
                }));
            },

            getProjectIcon(name) {
                const iconMap = {
                    'akademate': 'fa-graduation-cap',
                    'inmobiliaria': 'fa-building',
                    'adepac': 'fa-users',
                    'solaria': 'fa-sun',
                    'prilabsa': 'fa-globe',
                    'default': 'fa-folder'
                };
                const key = Object.keys(iconMap).find(k => name.toLowerCase().includes(k));
                return iconMap[key] || iconMap.default;
            },

            getBusinessIcon(name) {
                const iconMap = {
                    'akademate': 'fa-graduation-cap',
                    'inscouter': 'fa-search',
                    'nazcatrade': 'fa-chart-line',
                    'solaria': 'fa-sun',
                    'default': 'fa-briefcase'
                };
                const key = Object.keys(iconMap).find(k => name.toLowerCase().includes(k));
                return iconMap[key] || iconMap.default;
            },

            generateProjectTags(project) {
                const tags = [];
                // TYPE tag
                if (project.name.toLowerCase().includes('web')) {
                    tags.push({ label: 'WEB', color: 'blue' });
                } else if (project.name.toLowerCase().includes('saas') || project.name.toLowerCase().includes('akademate')) {
                    tags.push({ label: 'SAAS', color: 'blue' });
                } else {
                    tags.push({ label: 'APP', color: 'blue' });
                }
                // TECH tag
                tags.push({ label: 'REACT', color: 'green' });
                // BIZ tag
                tags.push({ label: 'B2B', color: 'purple' });
                return tags;
            },

            updateConnectionStatus(connected) {
                const statusDot = document.getElementById('statusDot');
                const statusText = document.getElementById('statusText');
                if (connected) {
                    statusDot.classList.remove('offline');
                    statusDot.classList.add('online');
                    statusText.textContent = 'API Conectada';
                } else {
                    statusDot.classList.add('offline');
                    statusText.textContent = 'Modo Offline';
                }
            },

            bindEvents() {
                // Sidebar collapse
                this.elements.collapseBtn.addEventListener('click', () => this.toggleSidebar());

                // Mobile menu
                this.elements.mobileMenuBtn.addEventListener('click', () => this.toggleMobileSidebar());
                this.elements.sidebarOverlay.addEventListener('click', () => this.closeMobileSidebar());

                // Navigation
                this.elements.navItems.forEach(item => {
                    item.addEventListener('click', (e) => this.handleNavClick(e, item));
                });

                // Theme toggle
                document.getElementById('modeToggle').addEventListener('click', () => this.toggleTheme());

                // Online/offline status
                window.addEventListener('online', () => this.updateOnlineStatus());
                window.addEventListener('offline', () => this.updateOnlineStatus());

                // Handle back button
                window.addEventListener('popstate', () => this.handleInitialRoute());
            },

            // ============================================
            // Theme Toggle
            // ============================================

            toggleTheme() {
                this.state.darkMode = !this.state.darkMode;
                this.applyTheme();
                localStorage.setItem('theme', this.state.darkMode ? 'dark' : 'light');
            },

            restoreTheme() {
                const savedTheme = localStorage.getItem('theme');
                if (savedTheme) {
                    this.state.darkMode = savedTheme !== 'light';
                } else {
                    // Check system preference
                    this.state.darkMode = window.matchMedia('(prefers-color-scheme: dark)').matches;
                }
                this.applyTheme();
            },

            applyTheme() {
                const icon = document.getElementById('modeIcon');
                if (this.state.darkMode) {
                    document.documentElement.removeAttribute('data-theme');
                    icon.className = 'fas fa-moon';
                } else {
                    document.documentElement.setAttribute('data-theme', 'light');
                    icon.className = 'fas fa-sun';
                }
            },

            toggleSidebar() {
                this.state.sidebarCollapsed = !this.state.sidebarCollapsed;
                this.elements.sidebar.classList.toggle('collapsed', this.state.sidebarCollapsed);
                localStorage.setItem('sidebarCollapsed', this.state.sidebarCollapsed);
            },

            toggleMobileSidebar() {
                const isCollapsed = this.elements.sidebar.classList.contains('collapsed');
                this.elements.sidebar.classList.toggle('collapsed', !isCollapsed);
                this.elements.sidebarOverlay.classList.toggle('hidden', !isCollapsed);
            },

            closeMobileSidebar() {
                this.elements.sidebar.classList.add('collapsed');
                this.elements.sidebarOverlay.classList.add('hidden');
            },

            restoreSidebarState() {
                if (window.innerWidth > 768 && this.state.sidebarCollapsed) {
                    this.elements.sidebar.classList.add('collapsed');
                } else if (window.innerWidth <= 768) {
                    this.elements.sidebar.classList.add('collapsed');
                }
            },

            handleNavClick(e, item) {
                // Skip internal routing for external links
                if (item.classList.contains('nav-external')) {
                    // Let browser handle target="_blank" naturally
                    return;
                }

                e.preventDefault();
                const page = item.dataset.page;

                // Update active state
                this.elements.navItems.forEach(nav => nav.classList.remove('active'));
                item.classList.add('active');

                // Update page
                this.state.currentPage = page;

                // Update URL
                history.pushState({ page }, '', `#${page}`);

                // Close mobile sidebar
                if (window.innerWidth <= 768) {
                    this.closeMobileSidebar();
                }

                // Load page content
                this.loadPageContent(page);
            },

            // Programmatic navigation (used by onclick handlers in stat-cards)
            navigateTo(page) {
                const navItem = document.querySelector(`[data-page="${page}"]`);
                if (navItem) {
                    App.elements.navItems.forEach(nav => nav.classList.remove('active'));
                    navItem.classList.add('active');
                }
                App.state.currentPage = page;
                history.pushState({ page }, '', `#${page}`);
                App.loadPageContent(page);
            },

            handleInitialRoute() {
                const hash = window.location.hash.slice(1) || 'dashboard';
                const navItem = document.querySelector(`[data-page="${hash}"]`);
                if (navItem) {
                    this.elements.navItems.forEach(nav => nav.classList.remove('active'));
                    navItem.classList.add('active');
                    this.state.currentPage = hash;
                    this.loadPageContent(hash);
                }
            },

            getPageInfo(page) {
                const pages = {
                    'dashboard': { title: 'Dashboard', subtitle: 'Vista general de proyectos activos', icon: 'fa-chart-line' },
                    'proyectos': { title: 'Proyectos', subtitle: `${PROJECTS_DATA.length} proyectos en desarrollo`, icon: 'fa-folder-open' },
                    'negocios': { title: 'Negocios', subtitle: `${BUSINESSES_DATA.length} negocios operativos`, icon: 'fa-briefcase' },
                    'infraestructura': { title: 'Infraestructura', subtitle: 'VPS, SSH, Cloudflare y accesos de gestion', icon: 'fa-server' },
                    'design-hub': { title: 'Design Hub', subtitle: 'Componentes UI, tipografias y elementos graficos', icon: 'fa-palette' },
                    'memorias': { title: 'Memorias', subtitle: 'Memoria persistente a largo plazo de agentes IA', icon: 'fa-brain' }
                };
                return pages[page] || pages['dashboard'];
            },

            loadPageContent(page) {
                if (page === 'dashboard') {
                    this.renderDashboardPage();
                } else if (page === 'proyectos') {
                    this.renderProjectsPage();
                } else if (page === 'negocios') {
                    this.renderBusinessesPage();
                } else if (page === 'infraestructura') {
                    this.renderInfrastructurePage();
                } else if (page === 'design-hub') {
                    this.renderDesignHub();
                } else if (page === 'memorias') {
                    this.renderMemoriasPage();
                } else {
                    const pageInfo = this.getPageInfo(page);
                    this.elements.contentArea.innerHTML = `
                        <div class="section-header">
                            <div>
                                <h1 class="section-title">${pageInfo.title}</h1>
                                <p class="section-subtitle">${pageInfo.subtitle}</p>
                            </div>
                        </div>
                        <div class="content-placeholder">
                            <i class="fas ${pageInfo.icon}"></i>
                            <p>Contenido pendiente</p>
                        </div>
                    `;
                }
            },

            // Deep link navigation methods
            // NOTE: Using App. instead of this. because these methods are called from onclick handlers
            async showTaskDetail(taskId) {
                console.log('Navigating to task:', taskId);

                // Try to find task in current state first
                let task = App.state.currentTasks?.find(t => t.id === taskId || t.id === parseInt(taskId));

                if (!task) {
                    // Fetch from API if not in state
                    try {
                        const response = await API.getTasks();
                        if (response && response.tasks) {
                            const rawTasks = response.tasks;
                            App.state.currentTasks = App.transformTasksFromAPI(rawTasks);
                            task = App.state.currentTasks.find(t => t.id === taskId || t.id === parseInt(taskId));
                        }
                    } catch (error) {
                        console.error('Failed to fetch task:', error);
                    }
                }

                if (task) {
                    // Open the task modal directly - tasks don't have a separate page
                    // They're viewed in context of projects or via modal from any page
                    App.openTaskModal(task.id);
                } else {
                    App.addNotification({
                        title: 'Tarea no encontrada',
                        message: `No se encontro la tarea #${taskId}`,
                        type: 'error'
                    });
                }
            },

            async showProjectDetail(projectId) {
                console.log('Navigating to project:', projectId);

                // Navigate to projects page
                // Update nav active state
                const navItem = document.querySelector('[data-page="proyectos"]');
                if (navItem) {
                    App.elements.navItems.forEach(nav => nav.classList.remove('active'));
                    navItem.classList.add('active');
                }
                App.state.currentPage = 'proyectos';
                await App.renderProjectsPage();

                // Find and scroll to the project card
                setTimeout(() => {
                    const projectCards = document.querySelectorAll('.project-card');
                    for (const card of projectCards) {
                        const cardId = card.getAttribute('data-project-id') || card.dataset.projectId;
                        if (cardId == projectId || card.querySelector(`[data-id="${projectId}"]`)) {
                            card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            card.style.animation = 'pulse-highlight 1.5s ease';
                            card.style.boxShadow = '0 0 0 3px var(--solaria-orange)';
                            setTimeout(() => {
                                card.style.boxShadow = '';
                            }, 2000);
                            break;
                        }
                    }
                }, 300);

                App.addNotification({
                    title: 'Proyecto',
                    message: `Navegando a proyecto #${projectId}`,
                    type: 'info'
                });
            },

            // ============================================
            // Dashboard Home View
            // ============================================

            async renderDashboardPage() {
                const pageInfo = this.getPageInfo('dashboard');

                // Render initial structure with loading state
                this.elements.contentArea.innerHTML = `
                    <div class="section-header">
                        <div>
                            <h1 class="section-title">${pageInfo.title}</h1>
                            <p class="section-subtitle">${pageInfo.subtitle}</p>
                        </div>
                    </div>

                    <!-- Stats Row -->
                    <div class="dashboard-stats-row" id="dashboardStats">
                        <div class="stat-card" onclick="App.navigateTo('proyectos')" style="cursor: pointer;" title="Ver todos los proyectos">
                            <div class="stat-icon projects"><i class="fas fa-folder-open"></i></div>
                            <div class="stat-content">
                                <div class="stat-label">Proyectos Activos</div>
                                <div class="stat-value" id="statProjects">-</div>
                            </div>
                        </div>
                        <div class="stat-card" onclick="App.navigateTo('proyectos')" style="cursor: pointer;" title="Ver tareas completadas">
                            <div class="stat-icon tasks"><i class="fas fa-check-circle"></i></div>
                            <div class="stat-content">
                                <div class="stat-label">Tareas Completadas</div>
                                <div class="stat-value" id="statCompleted">-</div>
                            </div>
                        </div>
                        <div class="stat-card" onclick="App.navigateTo('proyectos')" style="cursor: pointer;" title="Ver tareas en progreso">
                            <div class="stat-icon active"><i class="fas fa-clock"></i></div>
                            <div class="stat-content">
                                <div class="stat-label">En Progreso</div>
                                <div class="stat-value" id="statInProgress">-</div>
                            </div>
                        </div>
                        <div class="stat-card" onclick="App.navigateTo('agentes')" style="cursor: pointer;" title="Ver agentes activos">
                            <div class="stat-icon agents"><i class="fas fa-robot"></i></div>
                            <div class="stat-content">
                                <div class="stat-label">Agentes Activos</div>
                                <div class="stat-value" id="statAgents">-</div>
                            </div>
                        </div>
                    </div>

                    <!-- Widgets Grid -->
                    <div class="dashboard-grid">
                        <!-- Completed Tasks Feed -->
                        <div class="completed-tasks-widget">
                            <div class="widget-header">
                                <div class="widget-header-left">
                                    <div class="widget-icon success">
                                        <i class="fas fa-check-double"></i>
                                    </div>
                                    <div>
                                        <div class="widget-title">Tareas Completadas</div>
                                        <div class="widget-subtitle">Feed global en tiempo real</div>
                                    </div>
                                </div>
                                <div class="widget-badge" id="completedTasksCount">0</div>
                            </div>
                            <div class="completed-tasks-feed" id="completedTasksFeed">
                                <div class="feed-loading">
                                    <i class="fas fa-spinner"></i>
                                    <p>Cargando tareas...</p>
                                </div>
                            </div>
                        </div>

                        <!-- Quick Projects Overview -->
                        <div class="completed-tasks-widget">
                            <div class="widget-header">
                                <div class="widget-header-left">
                                    <div class="widget-icon info">
                                        <i class="fas fa-folder-open"></i>
                                    </div>
                                    <div>
                                        <div class="widget-title">Proyectos Recientes</div>
                                        <div class="widget-subtitle">Actividad de proyectos</div>
                                    </div>
                                </div>
                            </div>
                            <div class="completed-tasks-feed" id="recentProjectsFeed">
                                <div class="feed-loading">
                                    <i class="fas fa-spinner"></i>
                                    <p>Cargando proyectos...</p>
                                </div>
                            </div>
                        </div>

                        <!-- New Tasks by Project Widget -->
                        <div class="completed-tasks-widget">
                            <div class="widget-header">
                                <div class="widget-header-left">
                                    <div class="widget-icon warning">
                                        <i class="fas fa-plus-circle"></i>
                                    </div>
                                    <div>
                                        <div class="widget-title">Nuevas Tareas por Proyecto</div>
                                        <div class="widget-subtitle">Ultimos 7 dias</div>
                                    </div>
                                </div>
                                <div class="widget-badge" id="newTasksCount">0</div>
                            </div>
                            <div class="completed-tasks-feed" id="newTasksByProjectFeed">
                                <div class="feed-loading">
                                    <i class="fas fa-spinner"></i>
                                    <p>Cargando tareas...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                // Load dashboard stats (includes recent projects), completed tasks, and new tasks
                this.loadDashboardStats();
                this.loadCompletedTasksFeed();
                this.loadNewTasksByProject();
            },

            async loadDashboardStats() {
                try {
                    const dashboard = await API.getDashboard();
                    if (dashboard) {
                        document.getElementById('statProjects').textContent = dashboard.projects?.active_projects || dashboard.projects?.total_projects || PROJECTS_DATA.length;
                        document.getElementById('statCompleted').textContent = dashboard.tasks?.completed_tasks || 0;
                        document.getElementById('statInProgress').textContent = dashboard.tasks?.in_progress_tasks || 0;
                        document.getElementById('statAgents').textContent = dashboard.agents?.active_agents || 0;
                    }

                    // Also load recent projects feed (integrated here for reliability)
                    this.loadRecentProjectsFeed();
                } catch (error) {
                    console.warn('Failed to load dashboard stats:', error);
                    // Use fallback data
                    document.getElementById('statProjects').textContent = PROJECTS_DATA.length;
                    this.loadRecentProjectsFeed();
                }
            },

            async loadRecentProjectsFeed() {
                const feedContainer = document.getElementById('recentProjectsFeed');
                if (!feedContainer) return;

                try {
                    if (PROJECTS_DATA.length === 0) {
                        const response = await API.getProjects();
                        if (response && response.projects) {
                            PROJECTS_DATA = this.transformProjectsFromAPI(response.projects);
                        }
                    }

                    if (PROJECTS_DATA.length > 0) {
                        feedContainer.innerHTML = PROJECTS_DATA.slice(0, 5).map(p => `
                            <div class="completed-task-item" onclick="App.showProjectDetail('${p.slug || p.id}')" style="cursor: pointer;">
                                <div class="task-check-icon" style="background: rgba(59, 130, 246, 0.15); color: #60a5fa;">
                                    <i class="fas fa-folder"></i>
                                </div>
                                <div class="task-content">
                                    <div class="task-title-row">
                                        <span class="task-title">${this.escapeHtml(p.name)}</span>
                                        <span class="task-priority-badge ${p.phase === 'production' ? 'low' : p.phase === 'development' ? 'high' : 'medium'}">${p.phase || 'activo'}</span>
                                    </div>
                                    <div class="task-meta">
                                        <span class="task-meta-item"><i class="fas fa-tasks"></i> ${p.stats?.tasks || 0} tareas</span>
                                        <span class="task-meta-item"><i class="fas fa-percentage"></i> ${p.stats?.tasks > 0 ? Math.round((p.stats?.completed || 0) / p.stats.tasks * 100) : 0}%</span>
                                    </div>
                                </div>
                            </div>
                        `).join('');
                    } else {
                        feedContainer.innerHTML = '<div class="feed-empty"><i class="fas fa-folder-open"></i><p>No hay proyectos</p></div>';
                    }
                } catch (error) {
                    console.error('Failed to load recent projects:', error);
                    feedContainer.innerHTML = '<div class="feed-empty"><i class="fas fa-exclamation-triangle"></i><p>Error cargando proyectos</p></div>';
                }
            },

            async loadCompletedTasksFeed() {
                const feedContainer = document.getElementById('completedTasksFeed');
                const countBadge = document.getElementById('completedTasksCount');

                try {
                    const tasks = await API.getRecentCompletedTasks(15);

                    if (tasks && tasks.length > 0) {
                        countBadge.textContent = tasks.length;
                        feedContainer.innerHTML = tasks.map(task => this.renderCompletedTaskItem(task)).join('');

                        // Store for real-time updates
                        this.state.completedTasks = tasks;
                    } else {
                        countBadge.textContent = '0';
                        feedContainer.innerHTML = `
                            <div class="feed-empty">
                                <i class="fas fa-check-circle"></i>
                                <p>No hay tareas completadas todavia</p>
                            </div>
                        `;
                    }
                } catch (error) {
                    console.error('Failed to load completed tasks:', error);
                    feedContainer.innerHTML = `
                        <div class="feed-empty">
                            <i class="fas fa-exclamation-triangle"></i>
                            <p>Error cargando tareas</p>
                        </div>
                    `;
                }
            },

            renderCompletedTaskItem(task, isNew = false) {
                const timeStr = this.formatRelativeTime(task.completed_at || task.updated_at);
                return `
                    <div class="completed-task-item ${isNew ? 'new' : ''}" onclick="App.showTaskDetail(${task.id})" style="cursor: pointer;">
                        <div class="task-check-icon">
                            <i class="fas fa-check"></i>
                        </div>
                        <div class="task-content">
                            <div class="task-title-row">
                                <span class="task-title">${task.task_code ? `<span style="color: var(--solaria-orange); font-weight: 600; margin-right: 6px;">${task.task_code}</span>` : ''}${this.escapeHtml(task.title)}</span>
                                <span class="task-priority-badge ${task.priority || 'medium'}">${task.priority || 'medium'}</span>
                            </div>
                            <div class="task-meta">
                                <span class="task-meta-item"><i class="fas fa-folder"></i> ${this.escapeHtml(task.project_name || 'Sin proyecto')}</span>
                                ${task.agent_name ? `<span class="task-meta-item"><i class="fas fa-robot"></i> ${this.escapeHtml(task.agent_name)}</span>` : ''}
                            </div>
                        </div>
                        <span class="task-time">${timeStr}</span>
                    </div>
                `;
            },

            // New Tasks by Project Widget
            async loadNewTasksByProject() {
                const feedContainer = document.getElementById('newTasksByProjectFeed');
                const countBadge = document.getElementById('newTasksCount');

                if (!feedContainer) return;

                try {
                    const data = await API.getRecentTasksByProject(30, 7);

                    if (data && data.projects && data.projects.length > 0) {
                        countBadge.textContent = data.total_tasks;
                        feedContainer.innerHTML = data.projects.map(project => this.renderProjectTasksGroup(project)).join('');
                    } else {
                        countBadge.textContent = '0';
                        feedContainer.innerHTML = `
                            <div class="feed-empty">
                                <i class="fas fa-inbox"></i>
                                <p>No hay tareas nuevas en los ultimos 7 dias</p>
                            </div>
                        `;
                    }
                } catch (error) {
                    console.error('Failed to load new tasks by project:', error);
                    feedContainer.innerHTML = `
                        <div class="feed-empty">
                            <i class="fas fa-exclamation-triangle"></i>
                            <p>Error cargando tareas</p>
                        </div>
                    `;
                }
            },

            renderProjectTasksGroup(project) {
                const statusColors = {
                    pending: 'warning',
                    in_progress: 'info',
                    completed: 'success'
                };
                return `
                    <div class="project-tasks-group" style="margin-bottom: 12px; padding: 12px; background: var(--bg-tertiary); border-radius: 10px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-folder" style="color: var(--solaria-orange);"></i>
                                <span style="font-weight: 600; color: var(--text-primary);">${this.escapeHtml(project.project_name)}</span>
                            </div>
                            <div style="display: flex; gap: 6px;">
                                <span class="task-priority-badge low" style="font-size: 10px;">${project.completed} completadas</span>
                                <span class="task-priority-badge medium" style="font-size: 10px;">${project.in_progress} en progreso</span>
                                <span class="task-priority-badge high" style="font-size: 10px;">${project.pending} pendientes</span>
                            </div>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 4px;">
                            ${project.tasks.slice(0, 3).map(task => `
                                <div style="display: flex; align-items: center; gap: 8px; padding: 6px 8px; background: var(--bg-secondary); border-radius: 6px; cursor: pointer;" onclick="App.showTaskDetail(${task.id})">
                                    <span class="status-dot ${statusColors[task.status] || 'warning'}" style="width: 6px; height: 6px;"></span>
                                    <span style="flex: 1; font-size: 12px; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${task.task_code ? `<span style="color: var(--solaria-orange); font-weight: 600; margin-right: 4px;">${task.task_code}</span>` : ''}${this.escapeHtml(task.title)}</span>
                                    ${task.agent_name ? `<span style="font-size: 9px; background: rgba(139, 92, 246, 0.15); color: #a78bfa; padding: 2px 6px; border-radius: 4px; white-space: nowrap;"><i class="fas fa-robot" style="margin-right: 3px;"></i>${task.agent_name.length > 12 ? task.agent_name.substring(0, 12) + '...' : task.agent_name}</span>` : ''}
                                    <span style="font-size: 10px; color: var(--text-muted);">${this.formatRelativeTime(task.created_at)}</span>
                                </div>
                            `).join('')}
                            ${project.tasks.length > 3 ? `<span style="font-size: 11px; color: var(--text-muted); text-align: center; padding-top: 4px;">+${project.tasks.length - 3} mas</span>` : ''}
                        </div>
                    </div>
                `;
            },

            formatRelativeTime(dateStr) {
                if (!dateStr) return 'reciente';
                const date = new Date(dateStr);
                const now = new Date();
                const diffMs = now - date;
                const diffMins = Math.floor(diffMs / 60000);
                const diffHours = Math.floor(diffMs / 3600000);
                const diffDays = Math.floor(diffMs / 86400000);

                if (diffMins < 1) return 'ahora';
                if (diffMins < 60) return `${diffMins}m`;
                if (diffHours < 24) return `${diffHours}h`;
                if (diffDays < 7) return `${diffDays}d`;
                return date.toLocaleDateString('es-ES', { day: 'numeric', month: 'short' });
            },

            addCompletedTaskToFeed(task) {
                // Only update if on dashboard page
                if (this.state.currentPage !== 'dashboard') return;

                const feedContainer = document.getElementById('completedTasksFeed');
                const countBadge = document.getElementById('completedTasksCount');

                if (!feedContainer) return;

                // Check if empty state
                const emptyState = feedContainer.querySelector('.feed-empty');
                if (emptyState) {
                    feedContainer.innerHTML = '';
                }

                // Add new task at the top
                const newTaskHtml = this.renderCompletedTaskItem(task, true);
                feedContainer.insertAdjacentHTML('afterbegin', newTaskHtml);

                // Update count
                const currentCount = parseInt(countBadge.textContent) || 0;
                countBadge.textContent = currentCount + 1;

                // Remove 'new' class after animation
                setTimeout(() => {
                    const newItem = feedContainer.querySelector('.completed-task-item.new');
                    if (newItem) newItem.classList.remove('new');
                }, 3000);

                // Limit items in feed
                const items = feedContainer.querySelectorAll('.completed-task-item');
                if (items.length > 20) {
                    items[items.length - 1].remove();
                }
            },

            // ============================================
            // Projects View
            // ============================================

            renderProjectsPage() {
                const isGrid = this.state.projectsView === 'grid';
                const sortBy = this.state.sortBy || 'name';
                const pageInfo = this.getPageInfo('proyectos');

                this.elements.contentArea.innerHTML = `
                    <div class="section-header">
                        <div>
                            <h1 class="section-title">${pageInfo.title}</h1>
                            <p class="section-subtitle">${pageInfo.subtitle}</p>
                        </div>
                        <div class="section-actions" style="display: flex; gap: 12px; align-items: center;">
                            <div class="sort-buttons">
                                <button class="sort-btn ${sortBy === 'name' ? 'active' : ''}" onclick="App.setSortBy('name')">NOMBRE</button>
                                <button class="sort-btn ${sortBy === 'deadline' ? 'active' : ''}" onclick="App.setSortBy('deadline')">FECHA</button>
                                <button class="sort-btn ${sortBy === 'budget' ? 'active' : ''}" onclick="App.setSortBy('budget')">$$$</button>
                                <button class="sort-btn ${sortBy === 'completion' ? 'active' : ''}" onclick="App.setSortBy('completion')">%</button>
                                <button class="sort-btn ${sortBy === 'phase' ? 'active' : ''}" onclick="App.setSortBy('phase')">FASE</button>
                                <button class="sort-btn ${sortBy === 'type' ? 'active' : ''}" onclick="App.setSortBy('type')">TIPO</button>
                            </div>
                            <div class="view-toggle">
                                <button class="view-toggle-btn ${isGrid ? 'active' : ''}" onclick="App.setProjectsView('grid')">
                                    <i class="fas fa-th-large"></i>
                                </button>
                                <button class="view-toggle-btn ${!isGrid ? 'active' : ''}" onclick="App.setProjectsView('list')">
                                    <i class="fas fa-bars"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div id="projectsContainer" style="flex: 1; display: flex; flex-direction: column; overflow: hidden;"></div>
                `;

                if (isGrid) {
                    this.renderProjectsGrid();
                } else {
                    this.renderProjectsList();
                }
            },

            getSortedProjects() {
                const sortBy = this.state.sortBy || 'name';
                const phaseOrder = { planning: 1, development: 2, testing: 3, production: 4 };

                return [...PROJECTS_DATA].sort((a, b) => {
                    switch (sortBy) {
                        case 'name':
                            return a.name.localeCompare(b.name);
                        case 'deadline':
                            return new Date(a.stats.deadline) - new Date(b.stats.deadline);
                        case 'budget':
                            return b.stats.budget - a.stats.budget;
                        case 'completion':
                            const compA = a.stats.completed / a.stats.tasks;
                            const compB = b.stats.completed / b.stats.tasks;
                            return compB - compA;
                        case 'phase':
                            return phaseOrder[b.phase] - phaseOrder[a.phase];
                        case 'type':
                            return a.tags[0].label.localeCompare(b.tags[0].label);
                        case 'tasks':
                            return b.stats.tasks - a.stats.tasks;
                        default:
                            return 0;
                    }
                });
            },

            setSortBy(sortBy) {
                this.state.sortBy = sortBy;
                localStorage.setItem('projectsSortBy', sortBy);
                this.renderProjectsPage();
            },

            setProjectsView(view) {
                this.state.projectsView = view;
                localStorage.setItem('projectsView', view);
                this.renderProjectsPage();
            },

            renderProjectsGrid() {
                const container = document.getElementById('projectsContainer');
                const sortedProjects = this.getSortedProjects();
                const projectsPerPage = 4;
                const totalPages = Math.ceil(sortedProjects.length / projectsPerPage);

                let pagesHTML = '';
                for (let page = 0; page < totalPages; page++) {
                    const pageProjects = sortedProjects.slice(page * projectsPerPage, (page + 1) * projectsPerPage);
                    pagesHTML += `
                        <div class="projects-page" data-page="${page}">
                            ${pageProjects.map(p => this.renderProjectCard(p, false)).join('')}
                        </div>
                    `;
                }

                let dotsHTML = '';
                for (let i = 0; i < totalPages; i++) {
                    dotsHTML += `<button class="page-dot ${i === 0 ? 'active' : ''}" onclick="App.goToProjectPage(${i})"></button>`;
                }

                container.innerHTML = `
                    <div class="projects-slider scrollable" id="projectsSlider">
                        ${pagesHTML}
                    </div>
                    ${totalPages > 1 ? `<div class="page-indicators" id="pageIndicators">${dotsHTML}</div>` : ''}
                `;

                // Add scroll listener for page indicators
                const slider = document.getElementById('projectsSlider');
                if (slider) {
                    slider.addEventListener('scroll', () => this.updatePageIndicators());
                }
            },

            renderProjectsList() {
                const container = document.getElementById('projectsContainer');
                const sortedProjects = this.getSortedProjects();
                container.innerHTML = `
                    <div class="list-header">
                        <span class="list-header-col" style="grid-area: header;">PROYECTO</span>
                        <span class="list-header-col" style="grid-area: tags;">TIPO</span>
                        <span class="list-header-col" style="grid-area: progress;">FASE</span>
                        <span class="list-header-col" style="grid-area: tasks;">TAR</span>
                        <span class="list-header-col" style="grid-area: pend;">PEN</span>
                        <span class="list-header-col" style="grid-area: done;">OK</span>
                        <span class="list-header-col" style="grid-area: budget;">$$$</span>
                        <span class="list-header-col" style="grid-area: client;">CLIENTE</span>
                        <span class="list-header-col" style="grid-area: date;">ENTREGA</span>
                    </div>
                    <div class="scrollable" style="flex: 1; overflow-y: auto; padding-right: 8px;">
                        ${sortedProjects.map(p => this.renderProjectCard(p, 'compact')).join('')}
                    </div>
                `;
            },

            renderProjectCard(project, mode = 'grid') {
                // mode: 'grid', 'full-width', 'compact'
                const { id, name, description, icon, tags, phase, stats, board } = project;
                const phaseInfo = PROJECT_PHASES[phase];
                const phaseValue = phaseInfo.value;

                const isCompact = mode === 'compact';
                const isFullWidth = mode === 'full-width';
                const isGrid = mode === 'grid';

                // Only show first 3 tags always
                const displayTags = tags.slice(0, 3);
                const tagsHTML = displayTags.map(t => `<span class="project-tag ${t.color}">${t.label}</span>`).join('');

                // Format deadline with year - UPPERCASE
                const deadline = new Date(stats.deadline);
                const deadlineStr = deadline.toLocaleDateString('es-ES', { day: '2-digit', month: 'short', year: '2-digit' }).toUpperCase();

                // Format budget
                const budgetStr = stats.budget >= 1000 ? `$${(stats.budget / 1000).toFixed(0)}K` : `$${stats.budget}`;

                // Generate mini-Trello equalizer style (fixed 8 slots per column)
                const totalSlots = 8;
                const generateSlots = (count) => {
                    const filledCount = Math.min(count, totalSlots);
                    let slots = '';
                    for (let i = 0; i < totalSlots; i++) {
                        const isFilled = i < filledCount;
                        slots += `<div class="trello-slot ${isFilled ? 'filled' : ''}"></div>`;
                    }
                    return slots;
                };

                const miniTrelloHTML = `
                    <div class="mini-trello">
                        <div class="trello-column backlog">
                            <div class="trello-column-header">BACKLOG</div>
                            <div class="trello-slots">${generateSlots(board.backlog)}</div>
                        </div>
                        <div class="trello-column todo">
                            <div class="trello-column-header">TODO</div>
                            <div class="trello-slots">${generateSlots(board.todo)}</div>
                        </div>
                        <div class="trello-column doing">
                            <div class="trello-column-header">DOING</div>
                            <div class="trello-slots">${generateSlots(board.doing)}</div>
                        </div>
                        <div class="trello-column done">
                            <div class="trello-column-header">DONE</div>
                            <div class="trello-slots">${generateSlots(board.done)}</div>
                        </div>
                    </div>
                `;

                // Phase segments - determine which are active based on current phase
                const phaseOrder = ['planning', 'development', 'testing', 'production'];
                const currentPhaseIndex = phaseOrder.indexOf(phase);

                const segmentsHTML = phaseOrder.map((p, index) => {
                    const isActive = index <= currentPhaseIndex;
                    const segmentClass = isActive ? p : 'inactive';
                    return `<div class="progress-segment ${segmentClass}"></div>`;
                }).join('');

                const labelsHTML = phaseOrder.map((p, index) => {
                    const isActive = index === currentPhaseIndex;
                    const isCompleted = index < currentPhaseIndex;
                    const labelClass = isActive ? 'active' : (isCompleted ? 'completed' : '');
                    const labelText = { planning: 'PLAN', development: 'DEV', testing: 'TEST', production: 'PROD' }[p];
                    return `<span class="progress-label-item ${labelClass}">${labelText}</span>`;
                }).join('');

                // Stats HTML based on mode - Using Design Hub metrics-row component
                let statsHTML;
                const completionRate = stats.tasks > 0 ? Math.round((stats.completed / stats.tasks) * 100) : 0;

                if (isCompact) {
                    // Compact: metrics-row for list view (no labels, just values)
                    statsHTML = `
                        <div class="metrics-row compact" style="margin-top: 8px;">
                            <div class="metric-cell">
                                <div class="metric-value" style="font-size: 14px; color: var(--color-info);">${stats.tasks}</div>
                            </div>
                            <div class="metric-cell">
                                <div class="metric-value" style="font-size: 14px; color: var(--color-warning);">${stats.pending}</div>
                            </div>
                            <div class="metric-cell">
                                <div class="metric-value" style="font-size: 14px; color: var(--color-positive);">${stats.completed}</div>
                            </div>
                            <div class="metric-cell">
                                <div class="metric-value" style="font-size: 14px; color: var(--solaria-orange);">${budgetStr}</div>
                            </div>
                            <div class="metric-cell">
                                <div class="metric-value" style="font-size: 14px; color: #a855f7;">${stats.client}</div>
                            </div>
                            <div class="metric-cell">
                                <div class="metric-value" style="font-size: 14px; color: #818cf8;">${deadlineStr}</div>
                            </div>
                        </div>
                    `;
                } else if (isFullWidth) {
                    // Full-width: metrics-row with labels and change indicators
                    statsHTML = `
                        <div class="metrics-row" style="margin-top: 12px;">
                            <div class="metric-cell highlight">
                                <div class="metric-label">Tareas</div>
                                <div class="metric-value">${stats.tasks}</div>
                                <span class="metric-change ${stats.pending > 0 ? 'neutral' : 'positive'}">${stats.pending} pendientes</span>
                            </div>
                            <div class="metric-cell">
                                <div class="metric-label">Pendientes</div>
                                <div class="metric-value" style="color: var(--color-warning);">${stats.pending}</div>
                            </div>
                            <div class="metric-cell">
                                <div class="metric-label">Completadas</div>
                                <div class="metric-value" style="color: var(--color-positive);">${stats.completed}</div>
                                <span class="metric-change positive">${completionRate}%</span>
                            </div>
                            <div class="metric-cell">
                                <div class="metric-label">Presupuesto</div>
                                <div class="metric-value" style="color: var(--solaria-orange);">${budgetStr}</div>
                            </div>
                            <div class="metric-cell">
                                <div class="metric-label">Cliente</div>
                                <div class="metric-value" style="color: #a855f7; font-size: 16px;">${stats.client}</div>
                            </div>
                            <div class="metric-cell">
                                <div class="metric-label">Entrega</div>
                                <div class="metric-value" style="color: #818cf8; font-size: 14px;">${deadlineStr}</div>
                            </div>
                        </div>
                    `;
                } else {
                    // Grid view: metrics-row compact with labels
                    statsHTML = `
                        <div class="metrics-row compact" style="margin-top: 8px;">
                            <div class="metric-cell highlight">
                                <div class="metric-label">Tareas</div>
                                <div class="metric-value" style="font-size: 18px;">${stats.tasks}</div>
                            </div>
                            <div class="metric-cell">
                                <div class="metric-label">Pend</div>
                                <div class="metric-value" style="font-size: 18px; color: var(--color-warning);">${stats.pending}</div>
                            </div>
                            <div class="metric-cell">
                                <div class="metric-label">OK</div>
                                <div class="metric-value" style="font-size: 18px; color: var(--color-positive);">${stats.completed}</div>
                            </div>
                        </div>
                        <div class="metrics-row compact" style="margin-top: 4px;">
                            <div class="metric-cell">
                                <div class="metric-label">Budget</div>
                                <div class="metric-value" style="font-size: 16px; color: var(--solaria-orange);">${budgetStr}</div>
                            </div>
                            <div class="metric-cell">
                                <div class="metric-label">Cliente</div>
                                <div class="metric-value" style="font-size: 14px; color: #a855f7;">${stats.client}</div>
                            </div>
                            <div class="metric-cell">
                                <div class="metric-label">Entrega</div>
                                <div class="metric-value" style="font-size: 12px; color: #818cf8;">${deadlineStr}</div>
                            </div>
                        </div>
                    `;
                }

                // Card class based on mode
                const cardClass = isCompact ? 'compact' : (isFullWidth ? 'full-width' : '');

                return `
                    <div class="project-card ${cardClass}" data-id="${id}" onclick="App.openProject(${id})" style="${isCompact ? 'margin-bottom: 8px;' : (isFullWidth ? 'margin-bottom: 16px;' : '')}; cursor: pointer;">
                        <div class="project-card-header">
                            <div class="project-icon">
                                <i class="fas ${icon}"></i>
                            </div>
                            <div class="project-info">
                                <h3 class="project-name">${name}</h3>
                                <p class="project-description">${description}</p>
                            </div>
                            ${isFullWidth ? '<button class="project-edit-btn" onclick="event.stopPropagation(); App.editProject(' + id + ')"><i class="fas fa-edit"></i> EDITAR</button>' : ''}
                        </div>
                        <div class="project-tags">${tagsHTML}</div>
                        <div class="project-progress">
                            <div class="progress-header">
                                <span class="progress-label">FASE</span>
                                <span class="progress-phase-badge ${phase}">${phaseInfo.label.toUpperCase()}</span>
                            </div>
                            <div class="progress-segments">
                                ${segmentsHTML}
                            </div>
                            <div class="progress-labels">
                                ${labelsHTML}
                            </div>
                        </div>
                        ${miniTrelloHTML}
                        ${statsHTML}
                    </div>
                `;
            },

            goToProjectPage(pageIndex) {
                const slider = document.getElementById('projectsSlider');
                if (slider) {
                    const pageWidth = slider.offsetWidth;
                    slider.scrollTo({ left: pageIndex * pageWidth, behavior: 'smooth' });
                }
            },

            updatePageIndicators() {
                const slider = document.getElementById('projectsSlider');
                const dots = document.querySelectorAll('.page-dot');
                if (slider && dots.length > 0) {
                    const pageWidth = slider.offsetWidth;
                    const currentPage = Math.round(slider.scrollLeft / pageWidth);
                    dots.forEach((dot, i) => {
                        dot.classList.toggle('active', i === currentPage);
                    });
                }
            },

            openProject(id) {
                const project = PROJECTS_DATA.find(p => p.id === id);
                if (!project) return;

                this.state.currentProjectId = id;
                this.state.currentProject = project;
                this.renderProjectDetail(project);
            },

            // ============================================
            // Businesses View (NEGOCIOS)
            // ============================================

            renderBusinessesPage() {
                const pageInfo = this.getPageInfo('negocios');
                const isGrid = this.state.businessesView !== 'list';

                // Calculate totals
                const totalMRR = BUSINESSES_DATA.reduce((sum, b) => sum + b.metrics.mrr, 0);
                const totalClients = BUSINESSES_DATA.reduce((sum, b) => sum + b.metrics.clients, 0);
                const avgGrowth = Math.round(BUSINESSES_DATA.reduce((sum, b) => sum + b.metrics.growth, 0) / BUSINESSES_DATA.length);
                const activeCount = BUSINESSES_DATA.filter(b => b.status === 'active').length;

                const formatCurrency = (val) => new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN', maximumFractionDigits: 0 }).format(val);

                this.elements.contentArea.innerHTML = `
                    <div class="section-header">
                        <div>
                            <h1 class="section-title">${pageInfo.title}</h1>
                            <p class="section-subtitle">${pageInfo.subtitle}</p>
                        </div>
                        <div class="section-actions" style="display: flex; gap: 12px; align-items: center;">
                            <div class="view-toggle">
                                <button class="view-toggle-btn ${isGrid ? 'active' : ''}" onclick="App.setBusinessesView('grid')">
                                    <i class="fas fa-th-large"></i>
                                </button>
                                <button class="view-toggle-btn ${!isGrid ? 'active' : ''}" onclick="App.setBusinessesView('list')">
                                    <i class="fas fa-bars"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="scrollable" style="flex: 1; overflow-y: auto; padding-right: 8px;">
                        <!-- MRR Summary - Metrics Row Style -->
                        <div class="metrics-row" style="margin-bottom: 16px;">
                            <div class="metric-cell highlight">
                                <div class="metric-label">MRR Total</div>
                                <div class="metric-value">${formatCurrency(totalMRR)}</div>
                                <span class="metric-change positive"><i class="fas fa-arrow-up"></i> ${avgGrowth}%</span>
                            </div>
                            <div class="metric-cell">
                                <div class="metric-label">ARR Proyectado</div>
                                <div class="metric-value">${formatCurrency(totalMRR * 12)}</div>
                            </div>
                            <div class="metric-cell">
                                <div class="metric-label">Negocios Activos</div>
                                <div class="metric-value">${activeCount}</div>
                            </div>
                            <div class="metric-cell">
                                <div class="metric-label">Clientes Totales</div>
                                <div class="metric-value">${totalClients}</div>
                            </div>
                            <div class="metric-cell">
                                <div class="metric-label">Crecimiento Prom</div>
                                <div class="metric-value">${avgGrowth}%</div>
                                <span class="metric-change ${avgGrowth > 0 ? 'positive' : avgGrowth < 0 ? 'negative' : 'neutral'}">
                                    <i class="fas fa-arrow-${avgGrowth > 0 ? 'up' : avgGrowth < 0 ? 'down' : 'right'}"></i> mensual
                                </span>
                            </div>
                        </div>

                        <!-- Businesses Grid/List -->
                        <div id="businessesContainer"></div>
                    </div>
                `;

                if (isGrid) {
                    this.renderBusinessesGrid();
                } else {
                    this.renderBusinessesList();
                }
            },

            setBusinessesView(view) {
                this.state.businessesView = view;
                this.renderBusinessesPage();
            },

            renderBusinessesGrid() {
                const container = document.getElementById('businessesContainer');
                const formatCurrency = (val) => new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN', maximumFractionDigits: 0 }).format(val);

                container.innerHTML = `
                    <div class="businesses-grid">
                        ${BUSINESSES_DATA.map(business => `
                            <div class="business-card" onclick="App.openBusiness(${business.id})">
                                <!-- Header -->
                                <div class="business-card-header">
                                    <div class="business-card-icon">
                                        <i class="fas ${business.icon}"></i>
                                    </div>
                                    <div class="business-card-title">
                                        <div class="business-card-name">${business.name}</div>
                                        <div class="business-card-category">${business.category}</div>
                                    </div>
                                    <span class="business-status ${business.status}">${business.status}</span>
                                </div>

                                <!-- Description -->
                                <div class="business-card-desc">${business.description}</div>

                                <!-- Metrics Row (Design Hub Linked) -->
                                <div class="metrics-row compact">
                                    <div class="metric-cell highlight">
                                        <div class="metric-label">MRR</div>
                                        <div class="metric-value" style="font-size: 18px;">${formatCurrency(business.metrics.mrr)}</div>
                                        <span class="metric-change ${business.metrics.growth > 0 ? 'positive' : business.metrics.growth < 0 ? 'negative' : 'neutral'}">
                                            <i class="fas fa-arrow-${business.metrics.growth > 0 ? 'up' : business.metrics.growth < 0 ? 'down' : 'right'}"></i> ${Math.abs(business.metrics.growth)}%
                                        </span>
                                    </div>
                                    <div class="metric-cell">
                                        <div class="metric-label">Clientes</div>
                                        <div class="metric-value" style="font-size: 18px;">${business.metrics.clients}</div>
                                    </div>
                                    <div class="metric-cell">
                                        <div class="metric-label">Ticket</div>
                                        <div class="metric-value" style="font-size: 18px;">${formatCurrency(business.metrics.avgTicket)}</div>
                                    </div>
                                    <div class="metric-cell">
                                        <div class="metric-label">Churn</div>
                                        <div class="metric-value" style="font-size: 18px; color: ${business.metrics.churnRate > 5 ? 'var(--color-negative)' : 'var(--text-primary)'};">${business.metrics.churnRate}%</div>
                                    </div>
                                </div>

                                <!-- Tags -->
                                <div class="business-tags">
                                    ${business.tags.map(tag => `
                                        <span class="project-tag ${tag.color}">${tag.label}</span>
                                    `).join('')}
                                </div>

                                <!-- Management Links -->
                                <div class="business-links">
                                    <a href="${business.management.admin}" target="_blank" class="business-link" onclick="event.stopPropagation()">
                                        <i class="fas fa-cog"></i> Admin
                                    </a>
                                    <a href="${business.management.billing}" target="_blank" class="business-link" onclick="event.stopPropagation()">
                                        <i class="fas fa-file-invoice-dollar"></i> Facturacion
                                    </a>
                                    <a href="${business.management.analytics}" target="_blank" class="business-link" onclick="event.stopPropagation()">
                                        <i class="fas fa-chart-bar"></i> Analytics
                                    </a>
                                    <a href="${business.management.support}" target="_blank" class="business-link" onclick="event.stopPropagation()">
                                        <i class="fas fa-headset"></i> Soporte
                                    </a>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            },

            renderBusinessesList() {
                const container = document.getElementById('businessesContainer');
                const formatCurrency = (val) => new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN', maximumFractionDigits: 0 }).format(val);

                container.innerHTML = `
                    <div style="display: flex; flex-direction: column; gap: 8px;">
                        ${BUSINESSES_DATA.map(business => `
                            <div class="business-list-item" onclick="App.openBusiness(${business.id})">
                                <div class="business-card-icon" style="width: 40px; height: 40px; font-size: 16px;">
                                    <i class="fas ${business.icon}"></i>
                                </div>
                                <div>
                                    <div style="font-weight: 600; margin-bottom: 2px;">${business.name}</div>
                                    <div style="font-size: 11px; color: var(--text-muted);">${business.category} | ${business.owner.name}</div>
                                </div>
                                <div class="business-list-mrr">
                                    <div style="font-weight: 600; color: #4ade80;">${formatCurrency(business.metrics.mrr)}</div>
                                    <div style="font-size: 10px; color: var(--text-muted);">MRR</div>
                                </div>
                                <div class="business-list-clients">
                                    <div style="font-weight: 600;">${business.metrics.clients}</div>
                                    <div style="font-size: 10px; color: var(--text-muted);">Clientes</div>
                                </div>
                                <span class="business-status ${business.status}">${business.status}</span>
                            </div>
                        `).join('')}
                    </div>
                `;
            },

            openBusiness(id) {
                const business = BUSINESSES_DATA.find(b => b.id === id);
                if (!business) return;

                this.state.currentBusinessId = id;
                this.renderBusinessDetail(business);
            },

            renderBusinessDetail(business) {
                const formatCurrency = (val) => new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN', maximumFractionDigits: 0 }).format(val);
                const formatDate = (dateStr) => {
                    const date = new Date(dateStr);
                    return date.toLocaleDateString('es-ES', { day: '2-digit', month: 'short', year: 'numeric' });
                };

                this.elements.contentArea.innerHTML = `
                    <div class="section-header">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <button class="icon-btn" onclick="App.renderBusinessesPage()" style="width: 36px; height: 36px;">
                                <i class="fas fa-arrow-left"></i>
                            </button>
                            <div>
                                <h1 class="section-title">${business.name}</h1>
                                <p class="section-subtitle">${business.category} | ${business.owner.type}</p>
                            </div>
                        </div>
                        <span class="business-status ${business.status}" style="font-size: 12px; padding: 6px 14px;">${business.status}</span>
                    </div>

                    <div class="scrollable" style="flex: 1; overflow-y: auto; padding-right: 8px;">
                        <!-- Metrics Summary Row (Design Hub Linked) -->
                        <div class="metrics-row" style="margin-bottom: 12px;">
                            <div class="metric-cell highlight">
                                <div class="metric-label">MRR</div>
                                <div class="metric-value">${formatCurrency(business.metrics.mrr)}</div>
                                <span class="metric-change ${business.metrics.growth > 0 ? 'positive' : 'neutral'}">
                                    <i class="fas fa-arrow-${business.metrics.growth > 0 ? 'up' : 'right'}"></i> ${business.metrics.growth}%
                                </span>
                            </div>
                            <div class="metric-cell">
                                <div class="metric-label">ARR</div>
                                <div class="metric-value">${formatCurrency(business.metrics.arr)}</div>
                            </div>
                            <div class="metric-cell">
                                <div class="metric-label">Clientes</div>
                                <div class="metric-value">${business.metrics.clients}</div>
                            </div>
                            <div class="metric-cell">
                                <div class="metric-label">Ticket Prom</div>
                                <div class="metric-value">${formatCurrency(business.metrics.avgTicket)}</div>
                            </div>
                            <div class="metric-cell ${business.metrics.churnRate > 5 ? 'warning' : ''}">
                                <div class="metric-label">Churn</div>
                                <div class="metric-value">${business.metrics.churnRate}%</div>
                            </div>
                        </div>

                        <!-- Header Card -->
                        <div class="project-card" style="padding: 16px; margin-bottom: 12px;">
                            <div style="display: flex; gap: 16px; align-items: flex-start;">
                                <div class="business-card-icon" style="width: 56px; height: 56px; font-size: 24px;">
                                    <i class="fas ${business.icon}"></i>
                                </div>
                                <div style="flex: 1;">
                                    <p style="color: var(--text-secondary); font-size: 13px; line-height: 1.5; margin-bottom: 12px;">
                                        ${business.description}
                                    </p>
                                    <div class="business-tags">
                                        ${business.tags.map(tag => `<span class="project-tag ${tag.color}">${tag.label}</span>`).join('')}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Info Cards Grid (2 columns) -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
                            <!-- Billing Card -->
                            <div class="project-card" style="padding: 14px;">
                                <h4 style="font-size: 13px; font-weight: 600; margin-bottom: 12px;">
                                    <i class="fas fa-file-invoice" style="color: var(--solaria-orange);"></i> FACTURACION
                                </h4>
                                <div style="display: flex; flex-direction: column; gap: 8px;">
                                    <div class="url-item" style="cursor: default;">
                                        <div class="url-item-icon" style="background: rgba(34, 197, 94, 0.2); color: #4ade80;">
                                            <i class="fas fa-check-circle"></i>
                                        </div>
                                        <div class="url-item-text">
                                            <div class="url-item-label">Ultima Factura</div>
                                            <div class="url-item-url">${formatDate(business.billing.lastInvoice)}</div>
                                        </div>
                                    </div>
                                    <div class="url-item" style="cursor: default;">
                                        <div class="url-item-icon" style="background: rgba(99, 102, 241, 0.2); color: #818cf8;">
                                            <i class="fas fa-calendar-alt"></i>
                                        </div>
                                        <div class="url-item-text">
                                            <div class="url-item-label">Proxima Factura</div>
                                            <div class="url-item-url">${formatDate(business.billing.nextInvoice)}</div>
                                        </div>
                                    </div>
                                    <div class="url-item" style="cursor: default;">
                                        <div class="url-item-icon" style="background: rgba(246, 146, 29, 0.2); color: var(--solaria-orange);">
                                            <i class="fas fa-credit-card"></i>
                                        </div>
                                        <div class="url-item-text">
                                            <div class="url-item-label">Metodo de Pago</div>
                                            <div class="url-item-url">${business.billing.paymentMethod}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Owner Info -->
                            <div class="project-card" style="padding: 14px;">
                                <h4 style="font-size: 13px; font-weight: 600; margin-bottom: 12px;">
                                    <i class="fas fa-building" style="color: #60a5fa;"></i> PROPIETARIO
                                </h4>
                                <div style="display: flex; flex-direction: column; gap: 8px;">
                                    <div class="url-item" style="cursor: default;">
                                        <div class="url-item-icon" style="background: rgba(59, 130, 246, 0.2); color: #60a5fa;">
                                            <i class="fas fa-building"></i>
                                        </div>
                                        <div class="url-item-text">
                                            <div class="url-item-label">Empresa</div>
                                            <div class="url-item-url">${business.owner.name}</div>
                                        </div>
                                    </div>
                                    <div class="url-item" style="cursor: default;">
                                        <div class="url-item-icon" style="background: rgba(168, 85, 247, 0.2); color: #c084fc;">
                                            <i class="fas fa-tag"></i>
                                        </div>
                                        <div class="url-item-text">
                                            <div class="url-item-label">Tipo</div>
                                            <div class="url-item-url">${business.owner.type}</div>
                                        </div>
                                    </div>
                                    <div class="url-item" style="cursor: default;">
                                        <div class="url-item-icon" style="background: rgba(34, 197, 94, 0.2); color: #4ade80;">
                                            <i class="fas fa-calendar-check"></i>
                                        </div>
                                        <div class="url-item-text">
                                            <div class="url-item-label">Cliente Desde</div>
                                            <div class="url-item-url">${formatDate(business.owner.since)}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Management Links -->
                        <div class="project-card" style="padding: 14px;">
                            <h4 style="font-size: 13px; font-weight: 600; margin-bottom: 12px;">
                                <i class="fas fa-external-link-alt" style="color: #c084fc;"></i> ENLACES DE GESTION
                            </h4>
                            <div class="metrics-row compact">
                                <a href="${business.management.admin}" target="_blank" class="metric-cell" style="text-decoration: none; cursor: pointer;" onclick="event.stopPropagation()">
                                    <div class="metric-label"><i class="fas fa-cog"></i> Admin</div>
                                    <div class="metric-value" style="font-size: 12px; color: var(--color-info);">Abrir <i class="fas fa-external-link-alt" style="font-size: 9px;"></i></div>
                                </a>
                                <a href="${business.management.billing}" target="_blank" class="metric-cell" style="text-decoration: none; cursor: pointer;" onclick="event.stopPropagation()">
                                    <div class="metric-label"><i class="fas fa-file-invoice-dollar"></i> Facturacion</div>
                                    <div class="metric-value" style="font-size: 12px; color: var(--color-positive);">Abrir <i class="fas fa-external-link-alt" style="font-size: 9px;"></i></div>
                                </a>
                                <a href="${business.management.analytics}" target="_blank" class="metric-cell" style="text-decoration: none; cursor: pointer;" onclick="event.stopPropagation()">
                                    <div class="metric-label"><i class="fas fa-chart-bar"></i> Analytics</div>
                                    <div class="metric-value" style="font-size: 12px; color: var(--color-warning);">Abrir <i class="fas fa-external-link-alt" style="font-size: 9px;"></i></div>
                                </a>
                                <a href="${business.management.support}" target="_blank" class="metric-cell" style="text-decoration: none; cursor: pointer;" onclick="event.stopPropagation()">
                                    <div class="metric-label"><i class="fas fa-headset"></i> Soporte</div>
                                    <div class="metric-value" style="font-size: 12px; color: #c084fc;">Abrir <i class="fas fa-external-link-alt" style="font-size: 9px;"></i></div>
                                </a>
                            </div>
                        </div>
                    </div>
                `;
            },

            // ============================================
            // Infrastructure Page - VPS, SSH, Cloudflare
            // ============================================

            renderInfrastructurePage() {
                const pageInfo = this.getPageInfo('infraestructura');
                const { vps, nemesis, cloudflare, sshKeys, databases } = INFRASTRUCTURE_DATA;

                // Count totals
                const totalVPS = vps.length;
                const totalOnline = vps.filter(v => v.status === 'online').length;
                const totalNemesis = nemesis.filter(n => n.status === 'active').length;
                const totalDomains = cloudflare.length;

                this.elements.contentArea.innerHTML = `
                    <div class="section-header">
                        <div>
                            <h1 class="section-title">${pageInfo.title}</h1>
                            <p class="section-subtitle">${pageInfo.subtitle}</p>
                        </div>
                    </div>

                    <div class="scrollable" style="flex: 1; overflow-y: auto; padding-right: 8px;">
                        <!-- Summary Metrics -->
                        <div class="metrics-row" style="margin-bottom: 20px;">
                            <div class="metric-cell highlight">
                                <div class="metric-label">VPS Servers</div>
                                <div class="metric-value">${totalVPS}</div>
                                <span class="metric-change positive">${totalOnline} online</span>
                            </div>
                            <div class="metric-cell">
                                <div class="metric-label">NEMESIS Network</div>
                                <div class="metric-value">${totalNemesis}</div>
                                <span class="metric-change positive">activos</span>
                            </div>
                            <div class="metric-cell">
                                <div class="metric-label">Dominios CF</div>
                                <div class="metric-value">${totalDomains}</div>
                            </div>
                            <div class="metric-cell">
                                <div class="metric-label">SSH Keys</div>
                                <div class="metric-value">${sshKeys.length}</div>
                            </div>
                            <div class="metric-cell">
                                <div class="metric-label">Databases</div>
                                <div class="metric-value">${databases.length}</div>
                            </div>
                        </div>

                        <!-- VPS Servers -->
                        <div class="project-card" style="padding: 20px; margin-bottom: 16px;">
                            <h3 style="font-size: 14px; font-weight: 600; margin-bottom: 16px;">
                                <i class="fas fa-server" style="color: var(--solaria-orange);"></i> SERVIDORES VPS
                            </h3>
                            <div style="display: flex; flex-direction: column; gap: 12px;">
                                ${vps.map(server => `
                                    <div class="metrics-row" style="background: var(--bg-tertiary);">
                                        <div class="metric-cell" style="flex: 2;">
                                            <div class="metric-label">${server.provider}</div>
                                            <div class="metric-value" style="font-size: 16px;">${server.name}</div>
                                            <span style="font-size: 11px; color: var(--text-muted);">${server.hostname}</span>
                                        </div>
                                        <div class="metric-cell">
                                            <div class="metric-label">IP</div>
                                            <div class="metric-value" style="font-size: 14px; font-family: monospace;">${server.ip}</div>
                                        </div>
                                        <div class="metric-cell">
                                            <div class="metric-label">OS</div>
                                            <div class="metric-value" style="font-size: 12px;">${server.os}</div>
                                        </div>
                                        <div class="metric-cell">
                                            <div class="metric-label">Specs</div>
                                            <div style="font-size: 11px; color: var(--text-secondary);">
                                                ${server.specs.cpu} | ${server.specs.ram} | ${server.specs.disk}
                                            </div>
                                        </div>
                                        <div class="metric-cell">
                                            <div class="metric-label">Estado</div>
                                            <span class="metric-change ${server.status === 'online' ? 'positive' : 'negative'}">
                                                <i class="fas fa-circle" style="font-size: 8px;"></i> ${server.status.toUpperCase()}
                                            </span>
                                        </div>
                                        <div class="metric-cell" style="flex: 0.5;">
                                            <button class="btn-primary" style="padding: 6px 12px; font-size: 11px;"
                                                onclick="navigator.clipboard.writeText('${server.ssh}'); alert('SSH copiado!')">
                                                <i class="fas fa-terminal"></i> SSH
                                            </button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <!-- NEMESIS Network -->
                        <div class="project-card" style="padding: 20px; margin-bottom: 16px;">
                            <h3 style="font-size: 14px; font-weight: 600; margin-bottom: 16px;">
                                <i class="fas fa-network-wired" style="color: #a855f7;"></i> RED NEMESIS (Tailscale VPN)
                            </h3>
                            <div class="metrics-grid cols-5" style="gap: 8px;">
                                ${nemesis.map(device => `
                                    <div class="stat-card" style="padding: 12px;">
                                        <div class="stat-icon ${device.status === 'active' ? 'green' : 'orange'}" style="width: 28px; height: 28px; font-size: 11px;">
                                            <i class="fas ${device.os.includes('macOS') ? 'fa-apple' : (device.os.includes('iOS') ? 'fa-mobile-alt' : 'fa-linux')}"></i>
                                        </div>
                                        <div class="stat-value" style="font-size: 13px;">${device.name}</div>
                                        <div class="stat-label" style="font-size: 9px;">${device.ip}</div>
                                        <span style="font-size: 9px; color: ${device.status === 'active' ? 'var(--color-positive)' : 'var(--color-warning)'};">
                                            ${device.role}
                                        </span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <!-- Two columns: Cloudflare + SSH Keys -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                            <!-- Cloudflare Domains -->
                            <div class="project-card" style="padding: 20px;">
                                <h3 style="font-size: 14px; font-weight: 600; margin-bottom: 16px;">
                                    <i class="fas fa-cloud" style="color: #f6821f;"></i> CLOUDFLARE
                                </h3>
                                <div style="display: flex; flex-direction: column; gap: 8px;">
                                    ${cloudflare.map(cf => `
                                        <div class="metrics-row compact" style="background: var(--bg-tertiary);">
                                            <div class="metric-cell">
                                                <div class="metric-label">Dominio</div>
                                                <div class="metric-value" style="font-size: 13px;">${cf.domain}</div>
                                            </div>
                                            <div class="metric-cell">
                                                <div class="metric-label">Plan</div>
                                                <div class="metric-value" style="font-size: 12px; color: ${cf.plan === 'Pro' ? 'var(--solaria-orange)' : 'var(--text-secondary)'};">${cf.plan}</div>
                                            </div>
                                            <div class="metric-cell">
                                                <div class="metric-label">SSL</div>
                                                <div class="metric-value" style="font-size: 11px;">${cf.ssl}</div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>

                            <!-- SSH Keys -->
                            <div class="project-card" style="padding: 20px;">
                                <h3 style="font-size: 14px; font-weight: 600; margin-bottom: 16px;">
                                    <i class="fas fa-key" style="color: var(--color-warning);"></i> SSH KEYS
                                </h3>
                                <div style="display: flex; flex-direction: column; gap: 8px;">
                                    ${sshKeys.map(key => `
                                        <div class="metrics-row compact" style="background: var(--bg-tertiary);">
                                            <div class="metric-cell">
                                                <div class="metric-label">Nombre</div>
                                                <div class="metric-value" style="font-size: 12px; font-family: monospace;">${key.name}</div>
                                            </div>
                                            <div class="metric-cell">
                                                <div class="metric-label">Tipo</div>
                                                <div class="metric-value" style="font-size: 11px;">${key.type}</div>
                                            </div>
                                            <div class="metric-cell">
                                                <div class="metric-label">Proposito</div>
                                                <div style="font-size: 10px; color: var(--text-muted);">${key.purpose}</div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>

                        <!-- Databases -->
                        <div class="project-card" style="padding: 20px; margin-bottom: 16px;">
                            <h3 style="font-size: 14px; font-weight: 600; margin-bottom: 16px;">
                                <i class="fas fa-database" style="color: var(--color-info);"></i> BASES DE DATOS
                            </h3>
                            <div class="metrics-row">
                                ${databases.map(db => `
                                    <div class="metric-cell">
                                        <div class="metric-label">${db.type}</div>
                                        <div class="metric-value" style="font-size: 14px;">${db.name}</div>
                                        <span class="metric-change neutral">${db.size}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <!-- Quick Commands -->
                        <div class="project-card" style="padding: 20px;">
                            <h3 style="font-size: 14px; font-weight: 600; margin-bottom: 16px;">
                                <i class="fas fa-terminal" style="color: var(--color-positive);"></i> COMANDOS RAPIDOS
                            </h3>
                            <div class="metrics-grid cols-4" style="gap: 8px;">
                                <button class="btn-secondary" onclick="navigator.clipboard.writeText('ssh root@46.62.222.138'); alert('Copiado!')">
                                    <i class="fas fa-copy"></i> SSH SOLARIA
                                </button>
                                <button class="btn-secondary" onclick="navigator.clipboard.writeText('ssh root@148.230.118.124'); alert('Copiado!')">
                                    <i class="fas fa-copy"></i> SSH NEMESIS
                                </button>
                                <button class="btn-secondary" onclick="navigator.clipboard.writeText('tailscale status'); alert('Copiado!')">
                                    <i class="fas fa-copy"></i> Tailscale Status
                                </button>
                                <button class="btn-secondary" onclick="navigator.clipboard.writeText('pm2 status'); alert('Copiado!')">
                                    <i class="fas fa-copy"></i> PM2 Status
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            },

            // ============================================
            // Design Hub - Graphic Design Reference
            // ============================================

            renderDesignHub() {
                const pageInfo = this.getPageInfo('design-hub');

                this.elements.contentArea.innerHTML = `
                    <div class="section-header">
                        <div>
                            <h1 class="section-title">${pageInfo.title}</h1>
                            <p class="section-subtitle">${pageInfo.subtitle}</p>
                        </div>
                    </div>
                    <div class="scrollable" style="flex: 1; overflow-y: auto; padding-right: 8px;">

                        <!-- BRAND IDENTITY -->
                        <div class="design-section">
                            <h2 class="design-section-title"><i class="fas fa-star"></i> Brand Identity</h2>
                            <div class="design-grid cols-3">
                                <div class="design-card">
                                    <h3>Logo</h3>
                                    <div style="text-align: center; padding: 20px; background: var(--bg-tertiary); border-radius: 8px;">
                                        <img src="/solaria-logo.png" alt="SOLARIA Logo" style="width: 80px; height: 80px;">
                                    </div>
                                </div>
                                <div class="design-card">
                                    <h3>Brand Colors</h3>
                                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                        <div style="width: 50px; height: 50px; background: #f6921d; border-radius: 8px;" title="SOLARIA Orange"></div>
                                        <div style="width: 50px; height: 50px; background: #d97706; border-radius: 8px;" title="Orange Dark"></div>
                                        <div style="width: 50px; height: 50px; background: #0a0a0a; border-radius: 8px;" title="Background"></div>
                                        <div style="width: 50px; height: 50px; background: #141414; border-radius: 8px;" title="Secondary BG"></div>
                                    </div>
                                </div>
                                <div class="design-card">
                                    <h3>Phase Colors</h3>
                                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                        <div style="width: 50px; height: 50px; background: #a855f7; border-radius: 8px;" title="Planning"></div>
                                        <div style="width: 50px; height: 50px; background: #22d3ee; border-radius: 8px;" title="Development"></div>
                                        <div style="width: 50px; height: 50px; background: #14b8a6; border-radius: 8px;" title="Testing"></div>
                                        <div style="width: 50px; height: 50px; background: #22c55e; border-radius: 8px;" title="Production"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- TYPOGRAPHY -->
                        <div class="design-section">
                            <h2 class="design-section-title"><i class="fas fa-font"></i> Typography</h2>
                            <div class="design-card" style="padding: 20px;">
                                <div style="margin-bottom: 16px;">
                                    <span style="font-size: 10px; color: var(--text-muted); text-transform: uppercase;">Font Family</span>
                                    <div style="font-size: 24px; font-weight: 600;">Inter</div>
                                </div>
                                <div style="display: grid; gap: 12px;">
                                    <div><span style="font-size: 32px; font-weight: 700;">Heading H1</span> <span style="color: var(--text-muted); font-size: 12px;">32px / 700</span></div>
                                    <div><span style="font-size: 24px; font-weight: 600;">Heading H2</span> <span style="color: var(--text-muted); font-size: 12px;">24px / 600</span></div>
                                    <div><span style="font-size: 18px; font-weight: 600;">Heading H3</span> <span style="color: var(--text-muted); font-size: 12px;">18px / 600</span></div>
                                    <div><span style="font-size: 14px; font-weight: 500;">Body Text</span> <span style="color: var(--text-muted); font-size: 12px;">14px / 500</span></div>
                                    <div><span style="font-size: 12px; color: var(--text-muted);">Small / Muted</span> <span style="color: var(--text-muted); font-size: 12px;">12px / 400</span></div>
                                    <div><span style="font-size: 10px; text-transform: uppercase; font-weight: 600; letter-spacing: 0.5px;">LABEL UPPERCASE</span> <span style="color: var(--text-muted); font-size: 12px;">10px / 600 / Uppercase</span></div>
                                </div>
                            </div>
                        </div>

                        <!-- TAGS -->
                        <div class="design-section">
                            <h2 class="design-section-title"><i class="fas fa-tags"></i> Tags / Badges</h2>
                            <div class="design-card" style="padding: 20px;">
                                <div style="margin-bottom: 16px;">
                                    <span style="font-size: 10px; color: var(--text-muted); text-transform: uppercase; margin-bottom: 8px; display: block;">Project Tags (3 Categories)</span>
                                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                        <span class="project-tag blue">SaaS</span>
                                        <span class="project-tag blue">Platform</span>
                                        <span class="project-tag green">React</span>
                                        <span class="project-tag green">Node.js</span>
                                        <span class="project-tag purple">Enterprise</span>
                                        <span class="project-tag purple">B2B</span>
                                    </div>
                                </div>
                                <div style="margin-bottom: 16px;">
                                    <span style="font-size: 10px; color: var(--text-muted); text-transform: uppercase; margin-bottom: 8px; display: block;">Phase Badges</span>
                                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                        <span class="progress-phase-badge planning">Planificacion</span>
                                        <span class="progress-phase-badge development">Desarrollo</span>
                                        <span class="progress-phase-badge testing">Testing</span>
                                        <span class="progress-phase-badge production">Produccion</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- PROGRESS BARS -->
                        <div class="design-section">
                            <h2 class="design-section-title"><i class="fas fa-chart-bar"></i> Progress Bars</h2>
                            <div class="design-card" style="padding: 20px;">
                                <span style="font-size: 10px; color: var(--text-muted); text-transform: uppercase; margin-bottom: 12px; display: block;">Segmented Phase Progress</span>
                                <div class="progress-segments" style="height: 14px; gap: 6px; margin-bottom: 8px;">
                                    <div class="progress-segment planning"></div>
                                    <div class="progress-segment development"></div>
                                    <div class="progress-segment testing"></div>
                                    <div class="progress-segment inactive"></div>
                                </div>
                                <div class="progress-labels">
                                    <span class="progress-label-item completed">Planificacion</span>
                                    <span class="progress-label-item completed">Desarrollo</span>
                                    <span class="progress-label-item active">Testing</span>
                                    <span class="progress-label-item">Produccion</span>
                                </div>
                            </div>
                        </div>

                        <!-- MINI TRELLO -->
                        <div class="design-section">
                            <h2 class="design-section-title"><i class="fas fa-columns"></i> Mini Trello (Equalizer)</h2>
                            <div class="design-card" style="padding: 20px;">
                                <div class="mini-trello" style="background: transparent;">
                                    <div class="trello-column">
                                        <span class="trello-label">BL</span>
                                        <div class="trello-slots">
                                            <div class="trello-slot filled" style="background: #64748b; border-color: transparent;"></div>
                                            <div class="trello-slot filled" style="background: #64748b; border-color: transparent;"></div>
                                            <div class="trello-slot filled" style="background: #64748b; border-color: transparent;"></div>
                                            <div class="trello-slot"></div>
                                            <div class="trello-slot"></div>
                                            <div class="trello-slot"></div>
                                            <div class="trello-slot"></div>
                                            <div class="trello-slot"></div>
                                        </div>
                                        <span class="trello-count">3</span>
                                    </div>
                                    <div class="trello-column">
                                        <span class="trello-label">TD</span>
                                        <div class="trello-slots">
                                            <div class="trello-slot filled" style="background: #f59e0b; border-color: transparent;"></div>
                                            <div class="trello-slot filled" style="background: #f59e0b; border-color: transparent;"></div>
                                            <div class="trello-slot filled" style="background: #f59e0b; border-color: transparent;"></div>
                                            <div class="trello-slot filled" style="background: #f59e0b; border-color: transparent;"></div>
                                            <div class="trello-slot filled" style="background: #f59e0b; border-color: transparent;"></div>
                                            <div class="trello-slot"></div>
                                            <div class="trello-slot"></div>
                                            <div class="trello-slot"></div>
                                        </div>
                                        <span class="trello-count">5</span>
                                    </div>
                                    <div class="trello-column">
                                        <span class="trello-label">DO</span>
                                        <div class="trello-slots">
                                            <div class="trello-slot filled" style="background: #3b82f6; border-color: transparent;"></div>
                                            <div class="trello-slot filled" style="background: #3b82f6; border-color: transparent;"></div>
                                            <div class="trello-slot"></div>
                                            <div class="trello-slot"></div>
                                            <div class="trello-slot"></div>
                                            <div class="trello-slot"></div>
                                            <div class="trello-slot"></div>
                                            <div class="trello-slot"></div>
                                        </div>
                                        <span class="trello-count">2</span>
                                    </div>
                                    <div class="trello-column">
                                        <span class="trello-label">DN</span>
                                        <div class="trello-slots">
                                            <div class="trello-slot filled" style="background: #22c55e; border-color: transparent;"></div>
                                            <div class="trello-slot filled" style="background: #22c55e; border-color: transparent;"></div>
                                            <div class="trello-slot filled" style="background: #22c55e; border-color: transparent;"></div>
                                            <div class="trello-slot filled" style="background: #22c55e; border-color: transparent;"></div>
                                            <div class="trello-slot filled" style="background: #22c55e; border-color: transparent;"></div>
                                            <div class="trello-slot filled" style="background: #22c55e; border-color: transparent;"></div>
                                            <div class="trello-slot filled" style="background: #22c55e; border-color: transparent;"></div>
                                            <div class="trello-slot"></div>
                                        </div>
                                        <span class="trello-count">7</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- CARDS -->
                        <div class="design-section">
                            <h2 class="design-section-title"><i class="fas fa-square"></i> Cards</h2>
                            <div class="design-grid cols-3">
                                <div class="design-card">
                                    <h3>Project Card (Mini)</h3>
                                    <div class="project-card" style="max-width: 280px;">
                                        <div class="project-card-header">
                                            <div class="project-icon">
                                                <i class="fas fa-graduation-cap"></i>
                                            </div>
                                            <div class="project-info">
                                                <h3 class="project-name">Akademate.com</h3>
                                                <div class="project-tags">
                                                    <span class="project-tag blue">SaaS</span>
                                                    <span class="project-tag green">React</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="design-card">
                                    <h3>Stats Card</h3>
                                    <div class="tasks-summary" style="max-width: 220px;">
                                        <div class="tasks-summary-item">
                                            <div class="tasks-summary-value" style="color: #60a5fa;">25</div>
                                            <div class="tasks-summary-label">Total</div>
                                        </div>
                                        <div class="tasks-summary-item">
                                            <div class="tasks-summary-value" style="color: #fbbf24;">6</div>
                                            <div class="tasks-summary-label">Pend</div>
                                        </div>
                                        <div class="tasks-summary-item">
                                            <div class="tasks-summary-value" style="color: #4ade80;">19</div>
                                            <div class="tasks-summary-label">Comp</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="design-card">
                                    <h3>Budget Graph</h3>
                                    <div class="budget-graph" style="max-width: 200px;">
                                        <div class="budget-bar" style="height: 25%;"></div>
                                        <div class="budget-bar" style="height: 40%;"></div>
                                        <div class="budget-bar" style="height: 55%;"></div>
                                        <div class="budget-bar" style="height: 70%;"></div>
                                        <div class="budget-bar" style="height: 60%;"></div>
                                        <div class="budget-bar" style="height: 85%;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- BUTTONS -->
                        <div class="design-section">
                            <h2 class="design-section-title"><i class="fas fa-hand-pointer"></i> Buttons</h2>
                            <div class="design-card" style="padding: 20px;">
                                <div style="display: flex; gap: 12px; flex-wrap: wrap; align-items: center;">
                                    <button class="btn-primary">Primary</button>
                                    <button class="btn-secondary">Secondary</button>
                                    <button class="header-btn"><i class="fas fa-bell"></i></button>
                                    <button class="project-edit-btn"><i class="fas fa-edit"></i> Editar</button>
                                    <button class="todo-add-btn"><i class="fas fa-plus"></i></button>
                                    <button class="todo-convert-btn"> Task</button>
                                </div>
                            </div>
                        </div>

                        <!-- URL ITEMS -->
                        <div class="design-section">
                            <h2 class="design-section-title"><i class="fas fa-link"></i> URL Items</h2>
                            <div class="design-card" style="padding: 20px;">
                                <div class="url-list" style="max-width: 300px;">
                                    <a href="#" class="url-item" onclick="event.preventDefault()">
                                        <div class="url-item-icon prod"><i class="fas fa-globe"></i></div>
                                        <div class="url-item-text">
                                            <div class="url-item-label">Prod</div>
                                            <div class="url-item-url">https://example.com</div>
                                        </div>
                                        <i class="fas fa-external-link-alt" style="color: var(--text-muted); font-size: 9px;"></i>
                                    </a>
                                    <a href="#" class="url-item" onclick="event.preventDefault()">
                                        <div class="url-item-icon staging"><i class="fas fa-flask"></i></div>
                                        <div class="url-item-text">
                                            <div class="url-item-label">Staging</div>
                                            <div class="url-item-url">https://staging.example.com</div>
                                        </div>
                                        <i class="fas fa-external-link-alt" style="color: var(--text-muted); font-size: 9px;"></i>
                                    </a>
                                    <a href="#" class="url-item" onclick="event.preventDefault()">
                                        <div class="url-item-icon local"><i class="fas fa-laptop-code"></i></div>
                                        <div class="url-item-text">
                                            <div class="url-item-label">Local</div>
                                            <div class="url-item-url">http://localhost:3000</div>
                                        </div>
                                        <i class="fas fa-external-link-alt" style="color: var(--text-muted); font-size: 9px;"></i>
                                    </a>
                                    <a href="#" class="url-item" onclick="event.preventDefault()">
                                        <div class="url-item-icon repo"><i class="fas fa-code-branch"></i></div>
                                        <div class="url-item-text">
                                            <div class="url-item-label">Repo</div>
                                            <div class="url-item-url">github.com/user/repo</div>
                                        </div>
                                        <i class="fas fa-external-link-alt" style="color: var(--text-muted); font-size: 9px;"></i>
                                    </a>
                                </div>
                            </div>
                        </div>

                        <!-- TODO ITEMS -->
                        <div class="design-section">
                            <h2 class="design-section-title"><i class="fas fa-check-square"></i> TODO Items</h2>
                            <div class="design-card" style="padding: 20px;">
                                <div class="todo-input-wrapper" style="max-width: 300px; margin-bottom: 12px;">
                                    <input type="text" class="todo-input" placeholder="Escribe una nota...">
                                    <button class="todo-add-btn"><i class="fas fa-plus"></i></button>
                                </div>
                                <div class="todo-list" style="max-width: 300px;">
                                    <div class="todo-item">
                                        <div class="todo-checkbox"></div>
                                        <span class="todo-text" style="font-size: 11px;">Revisar diseo del dashboard</span>
                                        <span class="todo-date" style="font-size: 9px;">12 dic</span>
                                        <button class="todo-convert-btn"></button>
                                    </div>
                                    <div class="todo-item done">
                                        <div class="todo-checkbox checked"><i class="fas fa-check" style="font-size: 8px; color: white;"></i></div>
                                        <span class="todo-text" style="font-size: 11px;">Aprobar colores del tema</span>
                                        <span class="todo-date" style="font-size: 9px;">08 dic</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ACTIVITY ITEMS -->
                        <div class="design-section">
                            <h2 class="design-section-title"><i class="fas fa-clock-rotate-left"></i> Activity Items</h2>
                            <div class="design-card" style="padding: 20px;">
                                <div style="display: flex; flex-direction: column; gap: 6px; max-width: 300px;">
                                    <div style="display: flex; align-items: flex-start; gap: 8px; padding: 8px; background: var(--bg-tertiary); border-radius: 6px;">
                                        <div style="width: 22px; height: 22px; border-radius: 50%; background: rgba(34, 197, 94, 0.2); display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                            <i class="fas fa-check" style="font-size: 8px; color: #4ade80;"></i>
                                        </div>
                                        <div style="flex: 1; min-width: 0;">
                                            <div style="font-size: 11px; font-weight: 500;">Tarea completada</div>
                                            <div style="font-size: 9px; color: var(--text-muted);">Hace 2h</div>
                                        </div>
                                    </div>
                                    <div style="display: flex; align-items: flex-start; gap: 8px; padding: 8px; background: var(--bg-tertiary); border-radius: 6px;">
                                        <div style="width: 22px; height: 22px; border-radius: 50%; background: rgba(59, 130, 246, 0.2); display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                            <i class="fas fa-code" style="font-size: 8px; color: #60a5fa;"></i>
                                        </div>
                                        <div style="flex: 1; min-width: 0;">
                                            <div style="font-size: 11px; font-weight: 500;">Nuevo commit</div>
                                            <div style="font-size: 9px; color: var(--text-muted);">Hace 5h</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- FORM ELEMENTS -->
                        <div class="design-section">
                            <h2 class="design-section-title"><i class="fas fa-edit"></i> Form Elements</h2>
                            <div class="design-card" style="padding: 20px;">
                                <div class="form-grid" style="max-width: 500px;">
                                    <div class="form-group">
                                        <label class="form-label">Input Label</label>
                                        <input type="text" class="form-input" value="Input value">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Select</label>
                                        <select class="form-select">
                                            <option>Option 1</option>
                                            <option>Option 2</option>
                                        </select>
                                    </div>
                                    <div class="form-group full-width">
                                        <label class="form-label">Textarea</label>
                                        <textarea class="form-textarea" style="height: 60px;">Textarea content</textarea>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ================================================
                             METRICS ROW - CORE COMPONENT (Twitter/X Style)
                             Linked to CSS Variables for global updates
                             ================================================ -->
                        <div class="design-section" style="background: linear-gradient(135deg, rgba(246, 146, 29, 0.1) 0%, transparent 100%); padding: 20px; border-radius: 12px; border: 1px dashed var(--solaria-orange);">
                            <h2 class="design-section-title"><i class="fas fa-chart-line" style="color: var(--solaria-orange);"></i> METRICS ROW (Core Component)</h2>
                            <p style="font-size: 12px; color: var(--text-secondary); margin-bottom: 16px;">
                                Componente central del sistema. Los cambios en CSS Variables se aplican automaticamente a todo el dashboard.
                            </p>

                            <!-- Full Width Example -->
                            <div style="margin-bottom: 20px;">
                                <span style="font-size: 10px; color: var(--text-muted); text-transform: uppercase; margin-bottom: 8px; display: block;">5 Columns - Full Width</span>
                                <div class="metrics-row">
                                    <div class="metric-cell">
                                        <div class="metric-label">Seguidores <i class="fas fa-check-circle verified"></i></div>
                                        <div class="metric-value">1K <span class="secondary">/ 4.2K</span></div>
                                    </div>
                                    <div class="metric-cell">
                                        <div class="metric-label">Impresiones</div>
                                        <div class="metric-value">4.9M</div>
                                        <span class="metric-change positive"><i class="fas fa-arrow-up"></i> 334%</span>
                                    </div>
                                    <div class="metric-cell">
                                        <div class="metric-label">Engagement</div>
                                        <div class="metric-value">4.2%</div>
                                        <span class="metric-change negative"><i class="fas fa-arrow-down"></i> 19%</span>
                                    </div>
                                    <div class="metric-cell">
                                        <div class="metric-label">Engagements</div>
                                        <div class="metric-value">209.2K</div>
                                        <span class="metric-change positive"><i class="fas fa-arrow-up"></i> 248%</span>
                                    </div>
                                    <div class="metric-cell">
                                        <div class="metric-label">Profile Visits</div>
                                        <div class="metric-value">18.2K</div>
                                        <span class="metric-change positive"><i class="fas fa-arrow-up"></i> 88%</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Two Rows Example -->
                            <div style="margin-bottom: 20px;">
                                <span style="font-size: 10px; color: var(--text-muted); text-transform: uppercase; margin-bottom: 8px; display: block;">Two Rows (10 Metrics)</span>
                                <div class="metrics-row two-rows">
                                    <div class="metric-cell">
                                        <div class="metric-label">MRR</div>
                                        <div class="metric-value">$48K</div>
                                        <span class="metric-change positive"><i class="fas fa-arrow-up"></i> 15%</span>
                                    </div>
                                    <div class="metric-cell">
                                        <div class="metric-label">ARR</div>
                                        <div class="metric-value">$576K</div>
                                        <span class="metric-change positive"><i class="fas fa-arrow-up"></i> 12%</span>
                                    </div>
                                    <div class="metric-cell">
                                        <div class="metric-label">Clientes</div>
                                        <div class="metric-value">12</div>
                                        <span class="metric-change positive"><i class="fas fa-arrow-up"></i> 3</span>
                                    </div>
                                    <div class="metric-cell">
                                        <div class="metric-label">Churn</div>
                                        <div class="metric-value">2.5%</div>
                                        <span class="metric-change negative"><i class="fas fa-arrow-up"></i> 0.5%</span>
                                    </div>
                                    <div class="metric-cell">
                                        <div class="metric-label">Ticket Prom</div>
                                        <div class="metric-value">$4K</div>
                                        <span class="metric-change neutral">-</span>
                                    </div>
                                    <div class="metric-cell">
                                        <div class="metric-label">Replies</div>
                                        <div class="metric-value">8.3K</div>
                                        <span class="metric-change positive"><i class="fas fa-arrow-up"></i> 380%</span>
                                    </div>
                                    <div class="metric-cell">
                                        <div class="metric-label">Likes</div>
                                        <div class="metric-value">46.5K</div>
                                        <span class="metric-change positive"><i class="fas fa-arrow-up"></i> 271%</span>
                                    </div>
                                    <div class="metric-cell">
                                        <div class="metric-label">Reposts</div>
                                        <div class="metric-value">1.1K</div>
                                        <span class="metric-change positive"><i class="fas fa-arrow-up"></i> 252%</span>
                                    </div>
                                    <div class="metric-cell">
                                        <div class="metric-label">Bookmarks</div>
                                        <div class="metric-value">12.6K</div>
                                        <span class="metric-change positive"><i class="fas fa-arrow-up"></i> 186%</span>
                                    </div>
                                    <div class="metric-cell">
                                        <div class="metric-label">Shares</div>
                                        <div class="metric-value">809</div>
                                        <span class="metric-change positive"><i class="fas fa-arrow-up"></i> 256%</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Compact Variant -->
                            <div style="margin-bottom: 20px;">
                                <span style="font-size: 10px; color: var(--text-muted); text-transform: uppercase; margin-bottom: 8px; display: block;">Compact Variant (3 Columns)</span>
                                <div class="metrics-row compact" style="max-width: 400px;">
                                    <div class="metric-cell">
                                        <div class="metric-label">Total</div>
                                        <div class="metric-value">25</div>
                                    </div>
                                    <div class="metric-cell">
                                        <div class="metric-label">Pending</div>
                                        <div class="metric-value" style="color: var(--color-warning);">6</div>
                                    </div>
                                    <div class="metric-cell highlight">
                                        <div class="metric-label">Completed</div>
                                        <div class="metric-value">19</div>
                                    </div>
                                </div>
                            </div>

                            <!-- With Highlights -->
                            <div>
                                <span style="font-size: 10px; color: var(--text-muted); text-transform: uppercase; margin-bottom: 8px; display: block;">With Cell Highlights</span>
                                <div class="metrics-row compact" style="max-width: 500px;">
                                    <div class="metric-cell highlight">
                                        <div class="metric-label">Revenue</div>
                                        <div class="metric-value">$146K</div>
                                        <span class="metric-change positive"><i class="fas fa-arrow-up"></i> 12%</span>
                                    </div>
                                    <div class="metric-cell">
                                        <div class="metric-label">Expenses</div>
                                        <div class="metric-value">$89K</div>
                                        <span class="metric-change negative"><i class="fas fa-arrow-up"></i> 5%</span>
                                    </div>
                                    <div class="metric-cell warning">
                                        <div class="metric-label">Pending</div>
                                        <div class="metric-value">$23K</div>
                                        <span class="metric-change neutral">-</span>
                                    </div>
                                    <div class="metric-cell highlight">
                                        <div class="metric-label">Profit</div>
                                        <div class="metric-value">$34K</div>
                                        <span class="metric-change positive"><i class="fas fa-arrow-up"></i> 28%</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- STAT CARDS -->
                        <div class="design-section">
                            <h2 class="design-section-title"><i class="fas fa-cube"></i> Stat Cards (Individual)</h2>
                            <p style="font-size: 12px; color: var(--text-muted); margin-bottom: 12px;">
                                Layout: Icon (top-left)  Value  Label | Change indicator (top-right)
                            </p>
                            <div class="metrics-grid cols-4" style="margin-bottom: 16px;">
                                <div class="stat-card">
                                    <div class="stat-icon green"><i class="fas fa-dollar-sign"></i></div>
                                    <span class="metric-change positive"><i class="fas fa-arrow-up"></i> 12%</span>
                                    <div class="stat-value">$146.5K</div>
                                    <div class="stat-label">Revenue</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-icon blue"><i class="fas fa-users"></i></div>
                                    <span class="metric-change positive"><i class="fas fa-arrow-up"></i> 8</span>
                                    <div class="stat-value">18</div>
                                    <div class="stat-label">Clientes</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-icon orange"><i class="fas fa-tasks"></i></div>
                                    <span class="metric-change neutral">-</span>
                                    <div class="stat-value">42</div>
                                    <div class="stat-label">Tasks</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-icon red"><i class="fas fa-exclamation-triangle"></i></div>
                                    <span class="metric-change negative"><i class="fas fa-arrow-up"></i> 2</span>
                                    <div class="stat-value">5</div>
                                    <div class="stat-label">Alertas</div>
                                </div>
                            </div>
                        </div>

                        <!-- CSS VARIABLES REFERENCE -->
                        <div class="design-section">
                            <h2 class="design-section-title"><i class="fas fa-code"></i> CSS Variables (Editable)</h2>
                            <div class="design-card" style="padding: 20px; font-family: monospace; font-size: 12px;">
                                <div style="display: grid; gap: 8px;">
                                    <div><span style="color: var(--color-info);">--metric-card-bg:</span> var(--bg-card)</div>
                                    <div><span style="color: var(--color-info);">--metric-card-border:</span> var(--border-color)</div>
                                    <div><span style="color: var(--color-info);">--metric-card-radius:</span> 12px</div>
                                    <div><span style="color: var(--color-info);">--metric-card-padding:</span> 16px</div>
                                    <div><span style="color: var(--color-info);">--metric-label-size:</span> 11px</div>
                                    <div><span style="color: var(--color-info);">--metric-value-size:</span> 24px</div>
                                    <div><span style="color: var(--color-info);">--metric-value-weight:</span> 700</div>
                                    <div><span style="color: var(--color-info);">--metric-change-size:</span> 12px</div>
                                    <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border-color);">
                                        <span style="color: var(--color-positive);">--color-positive:</span> #22c55e (Verde)</div>
                                    <div><span style="color: var(--color-negative);">--color-negative:</span> #ef4444 (Rojo)</div>
                                    <div><span style="color: var(--color-warning);">--color-warning:</span> #f59e0b (Amarillo)</div>
                                    <div><span style="color: var(--color-info);">--color-info:</span> #3b82f6 (Azul)</div>
                                </div>
                            </div>
                        </div>

                    </div>
                `;
            },

            // ============================================
            // Memorias Page
            // ============================================

            async renderMemoriasPage() {
                const pageInfo = this.getPageInfo('memorias');

                this.elements.contentArea.innerHTML = `
                    <div class="section-header">
                        <div>
                            <h1 class="section-title">${pageInfo.title}</h1>
                            <p class="section-subtitle">${pageInfo.subtitle}</p>
                        </div>
                        <div class="section-actions" style="display: flex; gap: 12px; align-items: center;">
                            <select id="memoryTagFilter" class="sort-btn" style="padding: 6px 12px; background: var(--bg-tertiary); border: 1px solid var(--border); color: var(--text-primary);">
                                <option value="">Todos los tags</option>
                            </select>
                            <button class="btn-primary" onclick="App.showCreateMemoryModal()">
                                <i class="fas fa-plus"></i> Nueva Memoria
                            </button>
                        </div>
                    </div>
                    <div id="memoriesStats" class="stats-row" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 20px;"></div>
                    <div id="memoriesContainer" class="scrollable" style="flex: 1; overflow-y: auto; padding-right: 8px;">
                        <div class="loading-indicator" style="text-align: center; padding: 40px;">
                            <i class="fas fa-spinner fa-spin" style="font-size: 24px; color: var(--color-primary);"></i>
                            <p style="color: var(--text-muted); margin-top: 12px;">Cargando memorias...</p>
                        </div>
                    </div>
                `;

                await this.loadMemories();
            },

            async loadMemories() {
                try {
                    // Fetch stats
                    const statsRes = await fetch('/api/memories/stats', {
                        headers: { 'Authorization': `Bearer ${this.state.token}` }
                    });
                    const stats = await statsRes.json();

                    // Render stats
                    document.getElementById('memoriesStats').innerHTML = `
                        <div class="stat-card" style="background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 12px; padding: 16px;">
                            <div style="font-size: 10px; text-transform: uppercase; color: var(--text-muted); margin-bottom: 4px;">Total Memorias</div>
                            <div style="font-size: 28px; font-weight: 700; color: var(--color-primary);">${stats.total || 0}</div>
                        </div>
                        <div class="stat-card" style="background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 12px; padding: 16px;">
                            <div style="font-size: 10px; text-transform: uppercase; color: var(--text-muted); margin-bottom: 4px;">Tags Unicos</div>
                            <div style="font-size: 28px; font-weight: 700; color: #a855f7;">${stats.tags_count || 0}</div>
                        </div>
                        <div class="stat-card" style="background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 12px; padding: 16px;">
                            <div style="font-size: 10px; text-transform: uppercase; color: var(--text-muted); margin-bottom: 4px;">Importancia Promedio</div>
                            <div style="font-size: 28px; font-weight: 700; color: #22c55e;">${((stats.avg_importance || 0) * 100).toFixed(0)}%</div>
                        </div>
                        <div class="stat-card" style="background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 12px; padding: 16px;">
                            <div style="font-size: 10px; text-transform: uppercase; color: var(--text-muted); margin-bottom: 4px;">Referencias Cruzadas</div>
                            <div style="font-size: 28px; font-weight: 700; color: #3b82f6;">${stats.crossrefs_count || 0}</div>
                        </div>
                    `;

                    // Fetch tags for filter
                    const tagsRes = await fetch('/api/memories/tags', {
                        headers: { 'Authorization': `Bearer ${this.state.token}` }
                    });
                    const tags = await tagsRes.json();

                    const tagFilter = document.getElementById('memoryTagFilter');
                    if (tagFilter && Array.isArray(tags)) {
                        tagFilter.innerHTML = `<option value="">Todos los tags</option>` +
                            tags.map(t => `<option value="${t.tag}">${t.tag} (${t.count})</option>`).join('');
                        tagFilter.onchange = () => this.filterMemories(tagFilter.value);
                    }

                    // Fetch memories
                    await this.filterMemories('');

                } catch (error) {
                    console.error('Error loading memories:', error);
                    document.getElementById('memoriesContainer').innerHTML = `
                        <div style="text-align: center; padding: 40px; color: var(--text-muted);">
                            <i class="fas fa-exclamation-triangle" style="font-size: 32px; color: var(--color-warning);"></i>
                            <p style="margin-top: 12px;">Error al cargar memorias: ${error.message}</p>
                        </div>
                    `;
                }
            },

            async filterMemories(tag) {
                const container = document.getElementById('memoriesContainer');
                container.innerHTML = `<div class="loading-indicator" style="text-align: center; padding: 40px;"><i class="fas fa-spinner fa-spin"></i></div>`;

                try {
                    const url = tag ? `/api/memories?tags=${tag}&limit=100` : '/api/memories?limit=100';
                    const res = await fetch(url, {
                        headers: { 'Authorization': `Bearer ${this.state.token}` }
                    });
                    const memories = await res.json();

                    if (!Array.isArray(memories) || memories.length === 0) {
                        container.innerHTML = `
                            <div style="text-align: center; padding: 40px; color: var(--text-muted);">
                                <i class="fas fa-brain" style="font-size: 48px; opacity: 0.3;"></i>
                                <p style="margin-top: 12px;">No hay memorias ${tag ? `con tag "${tag}"` : ''}</p>
                            </div>
                        `;
                        return;
                    }

                    container.innerHTML = `
                        <div class="memories-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 16px;">
                            ${memories.map(m => this.renderMemoryCard(m)).join('')}
                        </div>
                    `;
                } catch (error) {
                    container.innerHTML = `<div style="color: var(--color-error);">Error: ${error.message}</div>`;
                }
            },

            renderMemoryCard(memory) {
                const importanceColor = memory.importance >= 0.8 ? '#ef4444' :
                                        memory.importance >= 0.5 ? '#f59e0b' : '#22c55e';
                const tags = memory.tags ? (typeof memory.tags === 'string' ? JSON.parse(memory.tags) : memory.tags) : [];
                const createdDate = new Date(memory.created_at).toLocaleDateString('es-ES', {
                    day: '2-digit', month: 'short', year: '2-digit'
                });
                const contentPreview = memory.content.length > 200 ? memory.content.substring(0, 200) + '...' : memory.content;

                return `
                    <div class="memory-card" style="background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 12px; padding: 16px; cursor: pointer;" onclick="App.viewMemoryDetail(${memory.id})">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                            <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                                ${tags.map(t => `<span class="project-tag purple" style="font-size: 10px;">${t}</span>`).join('')}
                            </div>
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <div style="width: 8px; height: 8px; border-radius: 50%; background: ${importanceColor};"></div>
                                <span style="font-size: 10px; color: var(--text-muted);">${(memory.importance * 100).toFixed(0)}%</span>
                            </div>
                        </div>
                        <div style="font-size: 13px; color: var(--text-secondary); line-height: 1.5; margin-bottom: 12px;">
                            ${contentPreview}
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; font-size: 10px; color: var(--text-muted);">
                            <span><i class="fas fa-calendar-alt"></i> ${createdDate}</span>
                            <span><i class="fas fa-eye"></i> ${memory.access_count || 0} accesos</span>
                        </div>
                    </div>
                `;
            },

            async viewMemoryDetail(id) {
                try {
                    const res = await fetch(`/api/memories/${id}`, {
                        headers: { 'Authorization': `Bearer ${this.state.token}` }
                    });
                    const memory = await res.json();

                    // Fetch related memories
                    const relatedRes = await fetch(`/api/memories/${id}/related`, {
                        headers: { 'Authorization': `Bearer ${this.state.token}` }
                    });
                    const related = await relatedRes.json();

                    const tags = memory.tags ? (typeof memory.tags === 'string' ? JSON.parse(memory.tags) : memory.tags) : [];
                    const importanceColor = memory.importance >= 0.8 ? '#ef4444' :
                                            memory.importance >= 0.5 ? '#f59e0b' : '#22c55e';

                    const modal = document.createElement('div');
                    modal.className = 'modal-overlay';
                    modal.id = 'memoryDetailModal';
                    modal.innerHTML = `
                        <div class="modal-content" style="max-width: 700px; max-height: 80vh; overflow-y: auto;">
                            <div class="modal-header">
                                <h2><i class="fas fa-brain" style="color: var(--color-primary);"></i> Memoria #${memory.id}</h2>
                                <button class="modal-close" onclick="App.closeMemoryModal()">&times;</button>
                            </div>
                            <div class="modal-body" style="padding: 20px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 16px;">
                                    <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                                        ${tags.map(t => `<span class="project-tag purple">${t}</span>`).join('')}
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <span style="font-size: 12px; color: var(--text-muted);">Importancia:</span>
                                        <div style="background: var(--bg-tertiary); border-radius: 20px; padding: 4px 12px; display: flex; align-items: center; gap: 6px;">
                                            <div style="width: 10px; height: 10px; border-radius: 50%; background: ${importanceColor};"></div>
                                            <span style="font-weight: 600;">${(memory.importance * 100).toFixed(0)}%</span>
                                        </div>
                                    </div>
                                </div>
                                <div style="background: var(--bg-tertiary); border-radius: 8px; padding: 16px; margin-bottom: 16px; white-space: pre-wrap; font-size: 14px; line-height: 1.6;">
                                    ${memory.content}
                                </div>
                                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; font-size: 12px; color: var(--text-muted); margin-bottom: 16px;">
                                    <div><i class="fas fa-calendar-plus"></i> Creado: ${new Date(memory.created_at).toLocaleString('es-ES')}</div>
                                    <div><i class="fas fa-eye"></i> Accesos: ${memory.access_count || 0}</div>
                                    <div><i class="fas fa-folder"></i> Proyecto: ${memory.project_id || 'Global'}</div>
                                </div>
                                ${related && related.length > 0 ? `
                                    <div style="border-top: 1px solid var(--border); padding-top: 16px;">
                                        <h3 style="font-size: 14px; margin-bottom: 12px;"><i class="fas fa-link"></i> Memorias Relacionadas</h3>
                                        <div style="display: flex; flex-direction: column; gap: 8px;">
                                            ${related.map(r => `
                                                <div style="background: var(--bg-tertiary); padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 12px;" onclick="App.viewMemoryDetail(${r.id})">
                                                    ${r.content.substring(0, 100)}...
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                            <div class="modal-footer" style="padding: 16px; border-top: 1px solid var(--border); display: flex; justify-content: space-between;">
                                <button class="btn-secondary" onclick="App.boostMemory(${memory.id})">
                                    <i class="fas fa-arrow-up"></i> Boost Importancia
                                </button>
                                <button class="btn-danger" onclick="App.deleteMemory(${memory.id})">
                                    <i class="fas fa-trash"></i> Eliminar
                                </button>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(modal);
                } catch (error) {
                    alert('Error al cargar memoria: ' + error.message);
                }
            },

            closeMemoryModal() {
                const modal = document.getElementById('memoryDetailModal');
                if (modal) modal.remove();
                const createModal = document.getElementById('createMemoryModal');
                if (createModal) createModal.remove();
            },

            showCreateMemoryModal() {
                const modal = document.createElement('div');
                modal.className = 'modal-overlay';
                modal.id = 'createMemoryModal';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 600px;">
                        <div class="modal-header">
                            <h2><i class="fas fa-plus-circle" style="color: var(--color-primary);"></i> Nueva Memoria</h2>
                            <button class="modal-close" onclick="App.closeMemoryModal()">&times;</button>
                        </div>
                        <div class="modal-body" style="padding: 20px;">
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; font-size: 12px; color: var(--text-muted); margin-bottom: 6px;">Contenido</label>
                                <textarea id="memoryContent" style="width: 100%; min-height: 120px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 8px; padding: 12px; color: var(--text-primary); font-size: 14px; resize: vertical;" placeholder="Escribe el contenido de la memoria..."></textarea>
                            </div>
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; font-size: 12px; color: var(--text-muted); margin-bottom: 6px;">Tags (separados por coma)</label>
                                <input type="text" id="memoryTags" style="width: 100%; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 8px; padding: 10px 12px; color: var(--text-primary);" placeholder="decision, architecture, config">
                            </div>
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; font-size: 12px; color: var(--text-muted); margin-bottom: 6px;">Importancia (0-1)</label>
                                <input type="range" id="memoryImportance" min="0" max="1" step="0.1" value="0.5" style="width: 100%;">
                                <div style="display: flex; justify-content: space-between; font-size: 10px; color: var(--text-muted);">
                                    <span>Baja</span>
                                    <span id="importanceValue">50%</span>
                                    <span>Alta</span>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer" style="padding: 16px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 12px;">
                            <button class="btn-secondary" onclick="App.closeMemoryModal()">Cancelar</button>
                            <button class="btn-primary" onclick="App.createMemory()">
                                <i class="fas fa-save"></i> Guardar
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);

                // Update importance display
                document.getElementById('memoryImportance').oninput = (e) => {
                    document.getElementById('importanceValue').textContent = (e.target.value * 100).toFixed(0) + '%';
                };
            },

            async createMemory() {
                const content = document.getElementById('memoryContent').value;
                const tagsStr = document.getElementById('memoryTags').value;
                const importance = parseFloat(document.getElementById('memoryImportance').value);

                if (!content.trim()) {
                    alert('El contenido es requerido');
                    return;
                }

                const tags = tagsStr.split(',').map(t => t.trim()).filter(t => t);

                try {
                    const res = await fetch('/api/memories', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${this.state.token}`
                        },
                        body: JSON.stringify({ content, tags, importance })
                    });

                    if (!res.ok) throw new Error('Error al crear memoria');

                    this.closeMemoryModal();
                    await this.loadMemories();
                } catch (error) {
                    alert('Error: ' + error.message);
                }
            },

            async boostMemory(id) {
                try {
                    await fetch(`/api/memories/${id}/boost`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${this.state.token}` }
                    });
                    this.closeMemoryModal();
                    await this.loadMemories();
                } catch (error) {
                    alert('Error: ' + error.message);
                }
            },

            async deleteMemory(id) {
                if (!confirm('Ests seguro de eliminar esta memoria?')) return;

                try {
                    await fetch(`/api/memories/${id}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${this.state.token}` }
                    });
                    this.closeMemoryModal();
                    await this.loadMemories();
                } catch (error) {
                    alert('Error: ' + error.message);
                }
            },

            // ============================================
            // Project Detail - Helper Functions
            // ============================================

            renderTasksCard(stats, board) {
                const totalSlots = 8;
                const columns = [
                    { key: 'backlog', label: 'BL', color: '#64748b' },
                    { key: 'todo', label: 'TD', color: '#f59e0b' },
                    { key: 'doing', label: 'DO', color: '#3b82f6' },
                    { key: 'done', label: 'DN', color: '#22c55e' }
                ];

                const generateSlots = (count, color) => {
                    let slots = '';
                    for (let i = 0; i < totalSlots; i++) {
                        const isFilled = i < Math.min(count, totalSlots);
                        slots += `<div class="trello-slot ${isFilled ? 'filled' : ''}" style="${isFilled ? `background: ${color}; border-color: transparent;` : ''}"></div>`;
                    }
                    return slots;
                };

                const columnsHTML = columns.map(col => `
                    <div class="trello-column">
                        <span class="trello-label">${col.label}</span>
                        <div class="trello-slots">
                            ${generateSlots(board[col.key], col.color)}
                        </div>
                        <span class="trello-count">${board[col.key]}</span>
                    </div>
                `).join('');

                return `
                    <div class="project-card clickable-card" style="padding: 14px; cursor: pointer;" onclick="App.openTasksDetail()">
                        <h4 class="card-title">
                            <i class="fas fa-tasks" style="color: #60a5fa;"></i> TAREAS
                            <i class="fas fa-chevron-right" style="float: right; color: var(--text-muted); font-size: 10px;"></i>
                        </h4>
                        <div class="tasks-summary" style="grid-template-columns: repeat(4, 1fr);">
                            <div class="tasks-summary-item">
                                <div class="tasks-summary-value" style="color: #60a5fa;">${stats.tasks}</div>
                                <div class="tasks-summary-label">Total</div>
                            </div>
                            <div class="tasks-summary-item">
                                <div class="tasks-summary-value" style="color: #fbbf24;">${stats.pending}</div>
                                <div class="tasks-summary-label">Pend</div>
                            </div>
                            <div class="tasks-summary-item">
                                <div class="tasks-summary-value" style="color: #3b82f6;">${stats.inProgress || 0}</div>
                                <div class="tasks-summary-label">Doing</div>
                            </div>
                            <div class="tasks-summary-item">
                                <div class="tasks-summary-value" style="color: #4ade80;">${stats.completed}</div>
                                <div class="tasks-summary-label">Done</div>
                            </div>
                        </div>
                        <div class="mini-trello">
                            ${columnsHTML}
                        </div>
                    </div>
                `;
            },

            renderBudgetCard(stats) {
                const budgetStr = new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(stats.budget);
                const deadline = new Date(stats.deadline);
                const deadlineStr = deadline.toLocaleDateString('es-ES', { day: '2-digit', month: 'long', year: 'numeric' });
                const daysRemaining = Math.ceil((deadline - new Date()) / (1000 * 60 * 60 * 24));
                const completionPct = Math.round((stats.completed / stats.tasks) * 100);

                // Mock data for bar chart (6 months of budget execution)
                const barHeights = [25, 40, 55, 70, completionPct, Math.min(100, completionPct + 15)];

                return `
                    <div class="project-card clickable-card" style="padding: 14px; cursor: pointer;" onclick="App.openBudgetDetail()">
                        <h4 class="card-title">
                            <i class="fas fa-dollar-sign" style="color: var(--solaria-orange);"></i> PRESUPUESTO
                            <i class="fas fa-chevron-right" style="float: right; color: var(--text-muted); font-size: 10px;"></i>
                        </h4>
                        <div style="text-align: center; margin-bottom: 10px;">
                            <div class="stat-value" style="font-size: 22px; color: var(--solaria-orange);">${budgetStr}</div>
                            <div style="font-size: 10px; color: var(--text-muted); margin-top: 2px;">${completionPct}% ejecutado</div>
                        </div>
                        <div class="budget-graph">
                            ${barHeights.map(h => `<div class="budget-bar" style="height: ${h}%;"></div>`).join('')}
                        </div>
                        <div class="budget-deadline">
                            <div class="budget-deadline-icon">
                                <i class="fas fa-calendar-check"></i>
                            </div>
                            <div style="flex: 1;">
                                <div style="font-size: 9px; color: var(--text-muted); text-transform: uppercase;">Entrega</div>
                                <div style="font-size: 12px; font-weight: 600;">${deadlineStr}</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 18px; font-weight: 700; color: ${daysRemaining < 30 ? '#f87171' : '#4ade80'};">${daysRemaining}</div>
                                <div style="font-size: 8px; color: var(--text-muted);">DIAS</div>
                            </div>
                        </div>
                    </div>
                `;
            },

            renderUrlsCard(urls) {
                if (!urls) {
                    return `
                        <div class="project-card clickable-card" style="padding: 14px; cursor: pointer;" onclick="App.openUrlsDetail()">
                            <h4 class="card-title">
                                <i class="fas fa-link" style="color: #c084fc;"></i> DIRECCIONES
                                <i class="fas fa-chevron-right" style="float: right; color: var(--text-muted); font-size: 10px;"></i>
                            </h4>
                            <p style="color: var(--text-muted); font-size: 12px;">No hay URLs configuradas</p>
                        </div>
                    `;
                }

                const urlItems = [
                    { key: 'production', label: 'Prod', icon: 'fa-globe', class: 'prod' },
                    { key: 'staging', label: 'Staging', icon: 'fa-flask', class: 'staging' },
                    { key: 'local', label: 'Local', icon: 'fa-laptop-code', class: 'local' },
                    { key: 'repository', label: 'Repo', icon: 'fa-code-branch', class: 'repo' }
                ];

                const urlsHTML = urlItems.map(item => {
                    const url = urls[item.key];
                    if (!url) return '';
                    return `
                        <a href="${url}" target="_blank" class="url-item" onclick="event.stopPropagation()">
                            <div class="url-item-icon ${item.class}">
                                <i class="fas ${item.icon}"></i>
                            </div>
                            <div class="url-item-text">
                                <div class="url-item-label">${item.label}</div>
                                <div class="url-item-url">${url}</div>
                            </div>
                            <i class="fas fa-external-link-alt" style="color: var(--text-muted); font-size: 9px;"></i>
                        </a>
                    `;
                }).join('');

                return `
                    <div class="project-card clickable-card" style="padding: 14px; cursor: pointer;" onclick="App.openUrlsDetail()">
                        <h4 class="card-title">
                            <i class="fas fa-link" style="color: #c084fc;"></i> DIRECCIONES
                            <i class="fas fa-chevron-right" style="float: right; color: var(--text-muted); font-size: 10px;"></i>
                        </h4>
                        <div class="url-list">
                            ${urlsHTML || '<p style="color: var(--text-muted); font-size: 12px;">No hay URLs</p>'}
                        </div>
                    </div>
                `;
            },

            renderRecentActivity() {
                return `
                    <div class="project-card" style="padding: 14px;">
                        <h4 class="card-title">
                            <i class="fas fa-clock-rotate-left" style="color: var(--solaria-orange);"></i>
                            Actividad
                        </h4>
                        <div style="display: flex; flex-direction: column; gap: 6px;">
                            <div style="display: flex; align-items: flex-start; gap: 8px; padding: 8px; background: var(--bg-tertiary); border-radius: 6px;">
                                <div style="width: 22px; height: 22px; border-radius: 50%; background: rgba(34, 197, 94, 0.2); display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                    <i class="fas fa-check" style="font-size: 8px; color: #4ade80;"></i>
                                </div>
                                <div style="flex: 1; min-width: 0;">
                                    <div style="font-size: 11px; font-weight: 500;">Tarea: Setup inicial</div>
                                    <div style="font-size: 9px; color: var(--text-muted);">Hace 2h</div>
                                </div>
                            </div>
                            <div style="display: flex; align-items: flex-start; gap: 8px; padding: 8px; background: var(--bg-tertiary); border-radius: 6px;">
                                <div style="width: 22px; height: 22px; border-radius: 50%; background: rgba(59, 130, 246, 0.2); display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                    <i class="fas fa-code" style="font-size: 8px; color: #60a5fa;"></i>
                                </div>
                                <div style="flex: 1; min-width: 0;">
                                    <div style="font-size: 11px; font-weight: 500;">Commit: JWT auth</div>
                                    <div style="font-size: 9px; color: var(--text-muted);">Hace 5h</div>
                                </div>
                            </div>
                            <div style="display: flex; align-items: flex-start; gap: 8px; padding: 8px; background: var(--bg-tertiary); border-radius: 6px;">
                                <div style="width: 22px; height: 22px; border-radius: 50%; background: rgba(245, 158, 11, 0.2); display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                    <i class="fas fa-plus" style="font-size: 8px; color: #fbbf24;"></i>
                                </div>
                                <div style="flex: 1; min-width: 0;">
                                    <div style="font-size: 11px; font-weight: 500;">Nueva: Optimizar queries</div>
                                    <div style="font-size: 9px; color: var(--text-muted);">Ayer</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            },

            renderManualTodos(projectId, todos = []) {
                const todosHTML = todos.map(todo => this.renderTodoItem(projectId, todo)).join('');

                return `
                    <div class="project-card" style="padding: 14px;">
                        <h4 class="card-title">
                            <i class="fas fa-sticky-note" style="color: #fbbf24;"></i>
                            Notas
                            <span class="card-title-badge">(Agentes leen)</span>
                        </h4>
                        <div class="todo-input-wrapper">
                            <input type="text" class="todo-input" id="newTodoInput-${projectId}" placeholder="Escribe una nota..." onkeypress="if(event.key==='Enter')App.addManualTodo(${projectId})">
                            <button class="todo-add-btn" onclick="App.addManualTodo(${projectId})">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                        <div class="todo-list" id="todoList-${projectId}">
                            ${todosHTML || '<p style="color: var(--text-muted); font-size: 11px; text-align: center; padding: 12px 0;">Sin notas</p>'}
                        </div>
                    </div>
                `;
            },

            renderTodoItem(projectId, todo) {
                const date = new Date(todo.createdAt).toLocaleDateString('es-ES', { day: '2-digit', month: 'short' });
                return `
                    <div class="todo-item ${todo.done ? 'done' : ''}" data-id="${todo.id}">
                        <div class="todo-checkbox ${todo.done ? 'checked' : ''}" onclick="App.toggleTodo(${projectId}, ${todo.id})">
                            ${todo.done ? '<i class="fas fa-check" style="font-size: 8px; color: white;"></i>' : ''}
                        </div>
                        <span class="todo-text" style="font-size: 11px;">${todo.text}</span>
                        <span class="todo-date" style="font-size: 9px;">${date}</span>
                        ${!todo.done ? `<button class="todo-convert-btn" onclick="App.convertToTask(${projectId}, ${todo.id})"></button>` : ''}
                    </div>
                `;
            },

            addManualTodo(projectId) {
                const input = document.getElementById(`newTodoInput-${projectId}`);
                const text = input.value.trim();
                if (!text) return;

                const project = PROJECTS_DATA.find(p => p.id === projectId);
                if (!project.manualTodos) project.manualTodos = [];

                const newTodo = {
                    id: Date.now(),
                    text: text,
                    done: false,
                    createdAt: new Date().toISOString()
                };

                project.manualTodos.unshift(newTodo);

                const list = document.getElementById(`todoList-${projectId}`);
                list.innerHTML = project.manualTodos.map(t => this.renderTodoItem(projectId, t)).join('');
                input.value = '';
            },

            toggleTodo(projectId, todoId) {
                const project = PROJECTS_DATA.find(p => p.id === projectId);
                const todo = project.manualTodos.find(t => t.id === todoId);
                if (todo) {
                    todo.done = !todo.done;
                    const list = document.getElementById(`todoList-${projectId}`);
                    list.innerHTML = project.manualTodos.map(t => this.renderTodoItem(projectId, t)).join('');
                }
            },

            convertToTask(projectId, todoId) {
                const project = PROJECTS_DATA.find(p => p.id === projectId);
                const todo = project.manualTodos.find(t => t.id === todoId);
                if (todo) {
                    alert(`Convertir a tarea via API/MCP:\n\nProyecto: ${project.name}\nNota: "${todo.text}"\n\n(Esta funcionalidad se conectara con la API)`);
                }
            },

            // ============================================
            // Project Detail - Dashboard (Simplified)
            // ============================================

            renderProjectDetail(project) {
                const { id, name, description, icon, tags, phase, stats, board, urls, manualTodos, client } = project;
                const phaseInfo = PROJECT_PHASES[phase];

                // Phase segments
                const phaseOrder = ['planning', 'development', 'testing', 'production'];
                const currentPhaseIndex = phaseOrder.indexOf(phase);

                const segmentsHTML = phaseOrder.map((p, index) => {
                    const isActive = index <= currentPhaseIndex;
                    const segmentClass = isActive ? p : 'inactive';
                    return `<div class="progress-segment ${segmentClass}"></div>`;
                }).join('');

                const tagsHTML = tags.map(t => `<span class="project-tag ${t.color}">${t.label}</span>`).join('');

                // Format budget
                const budgetFormatted = new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(stats.budget);
                const deadlineDate = new Date(stats.deadline);
                const daysRemaining = Math.ceil((deadlineDate - new Date()) / (1000 * 60 * 60 * 24));

                // Render cards
                const tasksCardHTML = this.renderTasksCard(stats, board);
                const budgetCardHTML = this.renderBudgetCard(stats);
                const urlsCardHTML = this.renderUrlsCard(urls);

                this.elements.contentArea.innerHTML = `
                    <div class="section-header" style="flex-shrink: 0;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <button class="header-btn" onclick="App.goBackToProjects()" title="Volver a proyectos">
                                <i class="fas fa-arrow-left"></i>
                            </button>
                            <div style="min-width: 0;">
                                <h1 class="section-title" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${name}</h1>
                                <p class="section-subtitle" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${description}</p>
                            </div>
                        </div>
                        <div class="section-actions" style="display: flex; gap: 8px;">
                            <button class="btn-primary" onclick="App.openProjectFicha()">
                                <i class="fas fa-id-card"></i> Ficha
                            </button>
                            <button class="btn-secondary" onclick="App.editProject(${id})">
                                <i class="fas fa-edit"></i>
                            </button>
                        </div>
                    </div>

                    <div class="scrollable" style="flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch;">
                        <!-- PROJECT HEADER: Icon + Tags + Phase + Stats -->
                        <div class="project-card" style="padding: 16px; margin-bottom: 12px;">
                            <div style="display: flex; gap: 16px; align-items: flex-start;">
                                <div class="project-icon" style="width: 56px; height: 56px; flex-shrink: 0;">
                                    <i class="fas ${icon}" style="font-size: 24px;"></i>
                                </div>
                                <div style="flex: 1; min-width: 0;">
                                    <div class="project-tags" style="margin-bottom: 6px;">${tagsHTML}</div>
                                    <p style="font-size: 11px; color: var(--text-secondary); margin: 0; line-height: 1.4;">${description}</p>
                                    ${client ? `<div style="font-size: 10px; color: var(--text-muted); margin-top: 6px;"><i class="fas fa-building" style="margin-right: 4px;"></i>${client.name}</div>` : ''}
                                </div>
                            </div>

                            <!-- Phase Progress -->
                            <div style="margin-top: 12px; padding-top: 10px; border-top: 1px solid var(--border-color);">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                                    <span style="font-size: 10px; color: var(--text-muted); text-transform: uppercase;">Fase</span>
                                    <span class="progress-phase-badge ${phase}" style="font-size: 9px; padding: 2px 8px;">${phaseInfo.label}</span>
                                </div>
                                <div class="progress-segments" style="height: 6px; gap: 2px;">${segmentsHTML}</div>
                            </div>

                            <!-- Quick Stats Row -->
                            <div class="metrics-row compact" style="margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border-color);">
                                <div class="metric-cell">
                                    <div class="metric-value" style="font-size: 16px; color: var(--solaria-orange);">${budgetFormatted}</div>
                                    <div class="metric-label" style="font-size: 8px;">Presupuesto</div>
                                </div>
                                <div class="metric-divider"></div>
                                <div class="metric-cell">
                                    <div class="metric-value" style="font-size: 16px; color: #3b82f6;">${stats.tasks}</div>
                                    <div class="metric-label" style="font-size: 8px;">Tareas</div>
                                </div>
                                <div class="metric-divider"></div>
                                <div class="metric-cell">
                                    <div class="metric-value" style="font-size: 16px; color: #22c55e;">${Math.round((stats.completed / stats.tasks) * 100)}%</div>
                                    <div class="metric-label" style="font-size: 8px;">Completado</div>
                                </div>
                                <div class="metric-divider"></div>
                                <div class="metric-cell">
                                    <div class="metric-value" style="font-size: 16px; color: ${daysRemaining < 30 ? '#ef4444' : '#22c55e'};">${daysRemaining}d</div>
                                    <div class="metric-label" style="font-size: 8px;">Restantes</div>
                                </div>
                            </div>
                        </div>

                        <!-- QUICK ACCESS CARDS: Tasks, Budget, URLs -->
                        <div class="info-cards-grid" style="margin-bottom: 12px;">
                            ${tasksCardHTML}
                            ${budgetCardHTML}
                            ${urlsCardHTML}
                        </div>

                        <!-- ACTIVITY + MANUAL TODOS -->
                        <div class="activity-split">
                            ${this.renderRecentActivity()}
                            ${this.renderManualTodos(id, manualTodos)}
                        </div>
                    </div>
                `;
            },

            goBackToProjects() {
                this.renderProjectsPage();
            },

            // ============================================
            // Project Ficha Page - Full Detail View
            // ============================================

            openProjectFicha() {
                const project = this.state.currentProject;
                if (!project) {
                    console.warn('No project selected');
                    return;
                }

                const { id, name, description, icon, client, documents, requests } = project;

                // Client section HTML
                const clientHTML = client ? `
                    <div class="project-card" style="padding: 20px;">
                        <h4 style="font-size: 14px; font-weight: 600; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-building" style="color: var(--solaria-orange);"></i> CLIENTE
                        </h4>

                        <div class="ficha-client-header" style="display: flex; align-items: center; gap: 16px; margin-bottom: 16px; padding-bottom: 16px; border-bottom: 1px solid var(--border-color);">
                            <div class="ficha-client-avatar" style="width: 56px; height: 56px; border-radius: 12px; background: rgba(246, 146, 29, 0.15); display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                <i class="fas fa-building" style="font-size: 24px; color: var(--solaria-orange);"></i>
                            </div>
                            <div style="flex: 1; min-width: 0;">
                                <div style="font-size: 18px; font-weight: 700; color: var(--text-primary);">${client.name}</div>
                                ${client.fiscalName ? `<div style="font-size: 12px; color: var(--text-secondary);">${client.fiscalName}</div>` : ''}
                                ${client.rfc ? `<div style="font-size: 11px; color: var(--text-muted); font-family: monospace;">RFC: ${client.rfc}</div>` : ''}
                            </div>
                            ${client.website ? `<a href="${client.website}" target="_blank" style="padding: 8px 12px; background: var(--bg-tertiary); border-radius: 8px; color: var(--text-secondary); text-decoration: none; font-size: 12px; display: flex; align-items: center; gap: 6px;"><i class="fas fa-external-link-alt"></i> Web</a>` : ''}
                        </div>

                        <div class="ficha-client-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                            ${client.contactName ? `
                            <div class="ficha-field" style="padding: 12px; background: var(--bg-tertiary); border-radius: 8px;">
                                <div style="font-size: 10px; color: var(--text-muted); text-transform: uppercase; margin-bottom: 4px;">Contacto</div>
                                <div style="font-size: 13px; font-weight: 500; color: var(--text-primary);">${client.contactName}</div>
                            </div>` : ''}
                            ${client.contactEmail ? `
                            <div class="ficha-field" style="padding: 12px; background: var(--bg-tertiary); border-radius: 8px;">
                                <div style="font-size: 10px; color: var(--text-muted); text-transform: uppercase; margin-bottom: 4px;">Email</div>
                                <a href="mailto:${client.contactEmail}" style="font-size: 13px; color: #3b82f6; text-decoration: none;">${client.contactEmail}</a>
                            </div>` : ''}
                            ${client.contactPhone ? `
                            <div class="ficha-field" style="padding: 12px; background: var(--bg-tertiary); border-radius: 8px;">
                                <div style="font-size: 10px; color: var(--text-muted); text-transform: uppercase; margin-bottom: 4px;">Telefono</div>
                                <a href="tel:${client.contactPhone}" style="font-size: 13px; color: #3b82f6; text-decoration: none;">${client.contactPhone}</a>
                            </div>` : ''}
                            ${client.address ? `
                            <div class="ficha-field" style="padding: 12px; background: var(--bg-tertiary); border-radius: 8px;">
                                <div style="font-size: 10px; color: var(--text-muted); text-transform: uppercase; margin-bottom: 4px;">Direccion</div>
                                <div style="font-size: 12px; color: var(--text-secondary);">${client.address}</div>
                            </div>` : ''}
                        </div>
                    </div>
                ` : '<div class="project-card" style="padding: 20px; text-align: center; color: var(--text-muted);">Sin informacion de cliente</div>';

                // Documents section HTML
                const docTypeIcons = {
                    spec: { icon: 'fa-file-alt', color: '#3b82f6', label: 'Especificacion' },
                    contract: { icon: 'fa-file-signature', color: '#22c55e', label: 'Contrato' },
                    manual: { icon: 'fa-book', color: '#8b5cf6', label: 'Manual' },
                    design: { icon: 'fa-palette', color: '#ec4899', label: 'Diseno' }
                };

                const documentsHTML = documents && documents.length > 0 ? `
                    <div class="project-card" style="padding: 20px;">
                        <h4 style="font-size: 14px; font-weight: 600; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-folder-open" style="color: #3b82f6;"></i> DOCUMENTOS
                            <span style="margin-left: auto; font-size: 11px; color: var(--text-muted); font-weight: 400;">${documents.length} archivos</span>
                        </h4>

                        <div class="ficha-docs-list" style="display: flex; flex-direction: column; gap: 8px;">
                            ${documents.map(doc => {
                                const typeInfo = docTypeIcons[doc.type] || { icon: 'fa-file', color: '#6b7280', label: 'Documento' };
                                const dateStr = doc.date ? new Date(doc.date).toLocaleDateString('es-ES', { day: '2-digit', month: 'short', year: 'numeric' }) : '';
                                return `
                                    <a href="${doc.url}" target="_blank" class="ficha-doc-item" style="display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--bg-tertiary); border-radius: 8px; text-decoration: none; transition: background 0.15s;">
                                        <div style="width: 36px; height: 36px; border-radius: 8px; background: ${typeInfo.color}20; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                            <i class="fas ${typeInfo.icon}" style="color: ${typeInfo.color}; font-size: 14px;"></i>
                                        </div>
                                        <div style="flex: 1; min-width: 0;">
                                            <div style="font-size: 13px; font-weight: 500; color: var(--text-primary);">${doc.name}</div>
                                            <div style="font-size: 10px; color: var(--text-muted);">${typeInfo.label}${dateStr ? '  ' + dateStr : ''}</div>
                                        </div>
                                        <i class="fas fa-download" style="color: var(--text-muted); font-size: 12px;"></i>
                                    </a>
                                `;
                            }).join('')}
                        </div>
                    </div>
                ` : '<div class="project-card" style="padding: 20px; text-align: center; color: var(--text-muted);">Sin documentos</div>';

                // Requests section HTML
                const requestStatusConfig = {
                    pending: { icon: 'fa-clock', color: '#f59e0b', bg: 'rgba(245, 158, 11, 0.15)', label: 'Pendiente' },
                    approved: { icon: 'fa-check-circle', color: '#22c55e', bg: 'rgba(34, 197, 94, 0.15)', label: 'Aprobada' },
                    in_review: { icon: 'fa-eye', color: '#3b82f6', bg: 'rgba(59, 130, 246, 0.15)', label: 'En Revision' },
                    in_progress: { icon: 'fa-spinner', color: '#8b5cf6', bg: 'rgba(139, 92, 246, 0.15)', label: 'En Progreso' },
                    completed: { icon: 'fa-check-double', color: '#10b981', bg: 'rgba(16, 185, 129, 0.15)', label: 'Completada' },
                    rejected: { icon: 'fa-times-circle', color: '#ef4444', bg: 'rgba(239, 68, 68, 0.15)', label: 'Rechazada' }
                };

                const priorityConfig = {
                    high: { color: '#ef4444', label: 'Alta' },
                    medium: { color: '#f59e0b', label: 'Media' },
                    low: { color: '#6b7280', label: 'Baja' }
                };

                const requestsHTML = requests && requests.length > 0 ? `
                    <div class="project-card" style="padding: 20px;">
                        <h4 style="font-size: 14px; font-weight: 600; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-inbox" style="color: #8b5cf6;"></i> PETICIONES DEL CLIENTE
                            <span style="margin-left: auto; font-size: 11px; color: var(--text-muted); font-weight: 400;">${requests.length} peticiones</span>
                        </h4>

                        <div class="ficha-requests-list" style="display: flex; flex-direction: column; gap: 10px;">
                            ${requests.map(req => {
                                const statusInfo = requestStatusConfig[req.status] || requestStatusConfig.pending;
                                const priorityInfo = priorityConfig[req.priority] || priorityConfig.medium;
                                const dateStr = req.date ? new Date(req.date).toLocaleDateString('es-ES', { day: '2-digit', month: 'short' }) : '';
                                return `
                                    <div class="ficha-request-item" style="padding: 14px; background: var(--bg-tertiary); border-radius: 10px; border-left: 3px solid ${priorityInfo.color};">
                                        <div style="display: flex; align-items: flex-start; gap: 12px;">
                                            <div style="width: 32px; height: 32px; border-radius: 8px; background: ${statusInfo.bg}; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                                <i class="fas ${statusInfo.icon}" style="color: ${statusInfo.color}; font-size: 12px;"></i>
                                            </div>
                                            <div style="flex: 1; min-width: 0;">
                                                <div style="font-size: 13px; font-weight: 500; color: var(--text-primary); margin-bottom: 6px;">${req.text}</div>
                                                <div style="display: flex; flex-wrap: wrap; gap: 8px; align-items: center;">
                                                    <span style="font-size: 10px; padding: 3px 8px; border-radius: 4px; background: ${statusInfo.bg}; color: ${statusInfo.color}; font-weight: 600;">${statusInfo.label}</span>
                                                    <span style="font-size: 10px; color: ${priorityInfo.color}; font-weight: 500;"><i class="fas fa-flag" style="margin-right: 3px;"></i>${priorityInfo.label}</span>
                                                    ${dateStr ? `<span style="font-size: 10px; color: var(--text-muted);"><i class="fas fa-calendar" style="margin-right: 3px;"></i>${dateStr}</span>` : ''}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                ` : '<div class="project-card" style="padding: 20px; text-align: center; color: var(--text-muted);">Sin peticiones registradas</div>';

                // Render the ficha page
                this.elements.contentArea.innerHTML = `
                    <div class="section-header" style="flex-shrink: 0;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <button class="header-btn" onclick="App.goBackToProjectDetail()" title="Volver al proyecto">
                                <i class="fas fa-arrow-left"></i>
                            </button>
                            <div style="min-width: 0;">
                                <h1 class="section-title" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">Ficha: ${name}</h1>
                                <p class="section-subtitle">Informacion completa del proyecto</p>
                            </div>
                        </div>
                        <div class="section-actions">
                            <button class="btn-secondary" onclick="App.editProject(${id})">
                                <i class="fas fa-edit"></i> Editar
                            </button>
                        </div>
                    </div>

                    <div class="scrollable" style="flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch;">
                        <!-- Project Header Mini -->
                        <div class="project-card" style="padding: 16px; margin-bottom: 12px;">
                            <div style="display: flex; align-items: center; gap: 14px;">
                                <div class="project-icon" style="width: 48px; height: 48px; flex-shrink: 0;">
                                    <i class="fas ${icon}" style="font-size: 20px;"></i>
                                </div>
                                <div style="flex: 1; min-width: 0;">
                                    <div style="font-size: 16px; font-weight: 600; color: var(--text-primary);">${name}</div>
                                    <div style="font-size: 12px; color: var(--text-secondary);">${description}</div>
                                </div>
                            </div>
                        </div>

                        <!-- Client Section -->
                        <div style="margin-bottom: 12px;">
                            ${clientHTML}
                        </div>

                        <!-- Documents & Requests Grid -->
                        <div class="ficha-split-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                            ${documentsHTML}
                            ${requestsHTML}
                        </div>
                    </div>
                `;
            },

            goBackToProjectDetail() {
                if (this.state.currentProject) {
                    this.renderProjectDetail(this.state.currentProject);
                } else {
                    this.renderProjectsPage();
                }
            },

            // ============================================
            // Edit Project Modal Functions
            // ============================================

            editProject(id) {
                const project = PROJECTS_DATA.find(p => p.id === id);
                if (!project) return;

                const modalHTML = `
                    <div class="edit-modal-overlay" id="editModalOverlay" onclick="App.closeEditModal(event)">
                        <div class="edit-modal" onclick="event.stopPropagation()">
                            <div class="edit-modal-header">
                                <h3 class="edit-modal-title">Editar: ${project.name}</h3>
                                <button class="edit-modal-close" onclick="App.closeEditModal()">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>

                            <div class="edit-modal-body">
                                <!-- Project Info Section -->
                                <div class="form-section">
                                    <h4 class="form-section-title"><i class="fas fa-folder"></i> Informacion del Proyecto</h4>
                                    <div class="form-grid">
                                        <div class="form-group">
                                            <label class="form-label">Nombre</label>
                                            <input type="text" class="form-input" id="edit-name" value="${project.name}">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Fase</label>
                                            <select class="form-select" id="edit-phase">
                                                <option value="planning" ${project.phase === 'planning' ? 'selected' : ''}>Planificacion</option>
                                                <option value="development" ${project.phase === 'development' ? 'selected' : ''}>Desarrollo</option>
                                                <option value="testing" ${project.phase === 'testing' ? 'selected' : ''}>Testing</option>
                                                <option value="production" ${project.phase === 'production' ? 'selected' : ''}>Produccion</option>
                                            </select>
                                        </div>
                                        <div class="form-group full-width">
                                            <label class="form-label">Descripcion</label>
                                            <textarea class="form-textarea" id="edit-description">${project.description}</textarea>
                                        </div>
                                    </div>
                                </div>

                                <!-- Budget & Deadline Section -->
                                <div class="form-section">
                                    <h4 class="form-section-title"><i class="fas fa-dollar-sign"></i> Presupuesto y Fechas</h4>
                                    <div class="form-grid">
                                        <div class="form-group">
                                            <label class="form-label">Presupuesto (USD)</label>
                                            <input type="number" class="form-input" id="edit-budget" value="${project.stats.budget}">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Fecha de Entrega</label>
                                            <input type="date" class="form-input" id="edit-deadline" value="${project.stats.deadline}">
                                        </div>
                                    </div>
                                </div>

                                <!-- Client Info Section -->
                                <div class="form-section">
                                    <h4 class="form-section-title"><i class="fas fa-building"></i> Datos del Cliente</h4>
                                    <div class="form-grid">
                                        <div class="form-group">
                                            <label class="form-label">Nombre Comercial</label>
                                            <input type="text" class="form-input" id="edit-client-name" value="${project.client?.name || ''}">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Sitio Web</label>
                                            <input type="url" class="form-input" id="edit-client-website" value="${project.client?.website || ''}">
                                        </div>
                                        <div class="form-group full-width">
                                            <label class="form-label">Direccion</label>
                                            <input type="text" class="form-input" id="edit-client-address" value="${project.client?.address || ''}">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Razon Social</label>
                                            <input type="text" class="form-input" id="edit-client-fiscal" value="${project.client?.fiscalName || ''}">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">RFC</label>
                                            <input type="text" class="form-input" id="edit-client-rfc" value="${project.client?.rfc || ''}">
                                        </div>
                                    </div>
                                </div>

                                <!-- URLs Section -->
                                <div class="form-section">
                                    <h4 class="form-section-title"><i class="fas fa-link"></i> Direcciones del Proyecto</h4>
                                    <div class="form-grid">
                                        <div class="form-group">
                                            <label class="form-label">URL Produccion</label>
                                            <input type="url" class="form-input" id="edit-url-prod" value="${project.urls?.production || ''}">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">URL Staging/Test</label>
                                            <input type="url" class="form-input" id="edit-url-staging" value="${project.urls?.staging || ''}">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">URL Local Dev</label>
                                            <input type="url" class="form-input" id="edit-url-local" value="${project.urls?.local || ''}">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Repositorio</label>
                                            <input type="url" class="form-input" id="edit-url-repo" value="${project.urls?.repository || ''}">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="edit-modal-footer">
                                <button class="btn-secondary" onclick="App.closeEditModal()">Cancelar</button>
                                <button class="btn-primary" onclick="App.saveProject(${id})">
                                    <i class="fas fa-save"></i> Guardar Cambios
                                </button>
                            </div>
                        </div>
                    </div>
                `;

                document.body.insertAdjacentHTML('beforeend', modalHTML);
            },

            closeEditModal(e) {
                if (e && e.target !== e.currentTarget) return;
                const overlay = document.getElementById('editModalOverlay');
                if (overlay) overlay.remove();
            },

            async saveProject(id) {
                const project = PROJECTS_DATA.find(p => p.id === id);
                if (!project) return;

                // Get form values
                const name = document.getElementById('edit-name').value;
                const description = document.getElementById('edit-description').value;
                const status = document.getElementById('edit-phase').value;
                const budget = parseInt(document.getElementById('edit-budget').value) || 0;
                const deadline = document.getElementById('edit-deadline').value || null;

                // Client data
                const clientName = document.getElementById('edit-client-name').value;
                const clientWebsite = document.getElementById('edit-client-website').value;
                const clientAddress = document.getElementById('edit-client-address').value;
                const clientFiscal = document.getElementById('edit-client-fiscal').value;
                const clientRfc = document.getElementById('edit-client-rfc').value;

                // URLs
                const urlProd = document.getElementById('edit-url-prod').value || null;
                const urlStaging = document.getElementById('edit-url-staging').value || null;
                const urlLocal = document.getElementById('edit-url-local').value || null;
                const urlRepo = document.getElementById('edit-url-repo').value || null;

                // Get auth token
                const token = localStorage.getItem('dfo_token');
                if (!token) {
                    this.showNotification('Error: No autenticado', 'error');
                    return;
                }

                try {
                    // Update main project fields via API
                    const projectRes = await fetch(`${API_BASE}/projects/${id}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            name,
                            description,
                            status,
                            budget,
                            deadline
                        })
                    });

                    if (!projectRes.ok) {
                        throw new Error('Error al actualizar proyecto');
                    }

                    // Update client info via API
                    if (clientName) {
                        await fetch(`${API_BASE}/projects/${id}/client`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify({
                                name: clientName,
                                website: clientWebsite,
                                address: clientAddress,
                                fiscal_name: clientFiscal,
                                rfc: clientRfc
                            })
                        });
                    }

                    // Update local state
                    project.name = name;
                    project.description = description;
                    project.phase = status;
                    project.stats.budget = budget;
                    project.stats.deadline = deadline;

                    if (!project.client) project.client = {};
                    project.client.name = clientName;
                    project.client.website = clientWebsite;
                    project.client.address = clientAddress;
                    project.client.fiscalName = clientFiscal;
                    project.client.rfc = clientRfc;

                    if (!project.urls) project.urls = {};
                    project.urls.production = urlProd;
                    project.urls.staging = urlStaging;
                    project.urls.local = urlLocal;
                    project.urls.repository = urlRepo;

                    // Close modal and re-render
                    this.closeEditModal();
                    this.renderProjectDetail(project);

                    // Show success feedback
                    this.showNotification('Proyecto actualizado correctamente', 'success');
                    console.log('Project saved to API:', { id, name, budget, deadline });

                } catch (error) {
                    console.error('Error saving project:', error);
                    this.showNotification('Error al guardar proyecto: ' + error.message, 'error');
                }
            },

            updateOnlineStatus() {
                this.state.isOnline = navigator.onLine;
                this.elements.statusDot.classList.toggle('offline', !this.state.isOnline);
                this.elements.statusText.textContent = this.state.isOnline ? 'Conectado' : 'Sin conexion';
            },

            // ============================================
            // TASKS DETAIL PAGE - Kanban & Gantt Views
            // ============================================

            async openTasksDetail() {
                const project = this.state.currentProject;
                if (!project) {
                    console.warn('No project selected');
                    return;
                }

                // Show loading state
                this.elements.contentArea.innerHTML = `
                    <div style="display: flex; justify-content: center; align-items: center; height: 300px;">
                        <i class="fas fa-spinner fa-spin" style="font-size: 24px; color: var(--solaria-orange);"></i>
                        <span style="margin-left: 12px;">Cargando tareas...</span>
                    </div>
                `;

                try {
                    // Fetch real tasks from API
                    const response = await fetch(`/api/public/tasks?project_id=${project.id}`);
                    const data = await response.json();

                    // Transform API tasks to UI format
                    const tasks = this.transformTasksFromAPI(data.tasks || []);
                    this.state.tasksView = 'kanban';
                    this.state.currentTasks = tasks;

                    this.renderTasksDetailPage(project, tasks);
                } catch (error) {
                    console.error('Error fetching tasks:', error);
                    // Fallback to mock data if API fails
                    const mockTasks = this.generateMockTasks(project);
                    this.state.tasksView = 'kanban';
                    this.state.currentTasks = mockTasks;
                    this.renderTasksDetailPage(project, mockTasks);
                }
            },

            // Transform API task status to UI board status
            mapTaskStatus(apiStatus) {
                const statusMap = {
                    'pending': 'todo',
                    'in_progress': 'doing',
                    'review': 'doing',
                    'completed': 'done',
                    'blocked': 'backlog',
                    'cancelled': 'backlog'
                };
                return statusMap[apiStatus] || 'todo';
            },

            // Transform API priority to display format
            formatPriority(priority) {
                const priorityMap = {
                    'critical': 'P0',
                    'high': 'P1',
                    'medium': 'P2',
                    'low': 'P3'
                };
                return priorityMap[priority] || 'P2';
            },

            // Get relative time string (e.g., "2h", "3d", "1w")
            getRelativeTime(date) {
                const now = new Date();
                const diffMs = now - date;
                const diffSecs = Math.floor(diffMs / 1000);
                const diffMins = Math.floor(diffSecs / 60);
                const diffHours = Math.floor(diffMins / 60);
                const diffDays = Math.floor(diffHours / 24);
                const diffWeeks = Math.floor(diffDays / 7);
                const diffMonths = Math.floor(diffDays / 30);

                if (diffMins < 1) return 'ahora';
                if (diffMins < 60) return `${diffMins}m`;
                if (diffHours < 24) return `${diffHours}h`;
                if (diffDays < 7) return `${diffDays}d`;
                if (diffWeeks < 4) return `${diffWeeks}sem`;
                return `${diffMonths}mes`;
            },

            transformTasksFromAPI(apiTasks) {
                return apiTasks.map(t => {
                    // Parse estimated_hours - can be string "16.00", number, or null
                    const parsedHours = t.estimated_hours
                        ? (typeof t.estimated_hours === 'string'
                            ? parseFloat(t.estimated_hours)
                            : t.estimated_hours)
                        : 0;

                    // Get assignee name - prioritize agent_name from JOIN, then assigned_agent
                    const assigneeName = t.agent_name || t.assigned_agent || t.assigned_to || null;

                    return {
                        id: t.id,
                        task_code: t.task_code || null, // Preserve task code (DFO-001, AKD-002, etc.)
                        task_number: t.task_number || null,
                        title: t.title,
                        description: t.description || '',
                        status: this.mapTaskStatus(t.status),
                        originalStatus: t.status, // Keep original for display
                        priority: t.priority,
                        priorityLabel: this.formatPriority(t.priority),
                        assignee: assigneeName || 'Sin asignar',
                        agent_name: assigneeName,
                        assigned_agent_id: t.assigned_agent_id || null,
                        project_id: t.project_id || null,
                        project_name: t.project_name || null,
                        project_code: t.project_code || null,
                        dueDate: t.deadline || t.due_date || '',
                        createdAt: t.created_at,
                        progress: t.progress || 0,
                        estimatedHours: parsedHours,
                        epic: t.epic || null,
                        sprint: t.sprint || null,
                        items: t.items || [] // Include task items if preloaded
                    };
                });
            },

            generateMockTasks(project) {
                const tasks = [];
                const statuses = ['backlog', 'todo', 'doing', 'done'];
                const priorities = ['low', 'medium', 'high', 'critical'];
                const assignees = ['SOLARIA-PM', 'SOLARIA-DEV-01', 'SOLARIA-DEV-02', 'SOLARIA-ARCH', 'Carlos J.'];

                const taskTitles = {
                    backlog: ['Investigar nuevas tecnologias', 'Documentar API endpoints', 'Revisar arquitectura', 'Analizar competencia', 'Definir roadmap Q2'],
                    todo: ['Implementar autenticacion JWT', 'Crear componente Dashboard', 'Disear base de datos', 'Configurar CI/CD', 'Optimizar queries SQL'],
                    doing: ['Desarrollar modulo de pagos', 'Testing unitario', 'Refactorizar servicios', 'Implementar cache Redis'],
                    done: ['Setup proyecto inicial', 'Configurar Docker', 'Crear estructura de carpetas', 'Implementar login', 'Disear UI principal', 'Deploy a staging', 'Crear tests E2E']
                };

                let id = 1;
                statuses.forEach(status => {
                    const count = project.board[status] || 0;
                    const availableTitles = taskTitles[status] || [];

                    for (let i = 0; i < count; i++) {
                        const daysOffset = Math.floor(Math.random() * 30) - 15;
                        const dueDate = new Date();
                        dueDate.setDate(dueDate.getDate() + daysOffset);
                        const priority = priorities[Math.floor(Math.random() * priorities.length)];

                        tasks.push({
                            id: id++,
                            title: availableTitles[i % availableTitles.length] || `Tarea ${id}`,
                            description: `Descripcion de la tarea para ${project.name}`,
                            status: status,
                            originalStatus: status,
                            priority: priority,
                            priorityLabel: this.formatPriority(priority),
                            assignee: assignees[Math.floor(Math.random() * assignees.length)],
                            dueDate: dueDate.toISOString().split('T')[0],
                            createdAt: new Date(Date.now() - Math.random() * 30 * 24 * 60 * 60 * 1000).toISOString(),
                            progress: Math.floor(Math.random() * 100),
                            estimatedHours: Math.floor(Math.random() * 40) + 8
                        });
                    }
                });

                return tasks;
            },

            renderTasksDetailPage(project, tasks) {
                const currentView = this.state.tasksView || 'kanban';

                // Group tasks by status
                const tasksByStatus = {
                    backlog: tasks.filter(t => t.status === 'backlog'),
                    todo: tasks.filter(t => t.status === 'todo'),
                    doing: tasks.filter(t => t.status === 'doing'),
                    done: tasks.filter(t => t.status === 'done')
                };

                // Render content based on view
                let viewContent;
                if (currentView === 'kanban') {
                    viewContent = this.renderKanbanView(tasksByStatus);
                } else if (currentView === 'gantt') {
                    viewContent = this.renderGanttView(tasks);
                } else {
                    viewContent = this.renderListView(tasks);
                }

                this.elements.contentArea.innerHTML = `
                    <div class="section-header">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <button class="header-btn" onclick="App.goBackToProjectDetail()" title="Volver al proyecto">
                                <i class="fas fa-arrow-left"></i>
                            </button>
                            <div>
                                <h1 class="section-title">Tareas - ${project.name}</h1>
                                <p class="section-subtitle">${tasks.length} tareas en total</p>
                            </div>
                        </div>
                        <div class="section-actions">
                            <div class="view-toggle">
                                <button class="view-toggle-btn ${currentView === 'kanban' ? 'active' : ''}" onclick="App.switchTasksView('kanban')">
                                    <i class="fas fa-columns"></i> Kanban
                                </button>
                                <button class="view-toggle-btn ${currentView === 'gantt' ? 'active' : ''}" onclick="App.switchTasksView('gantt')">
                                    <i class="fas fa-chart-gantt"></i> Gantt
                                </button>
                                <button class="view-toggle-btn ${currentView === 'list' ? 'active' : ''}" onclick="App.switchTasksView('list')">
                                    <i class="fas fa-list"></i> Lista
                                </button>
                            </div>
                            <button class="btn-primary" onclick="App.createNewTask()">
                                <i class="fas fa-plus"></i> Nueva Tarea
                            </button>
                        </div>
                    </div>

                    <!-- Summary Row (compact for Kanban) -->
                    <div class="metrics-row compact" style="margin-bottom: 12px; flex-shrink: 0;">
                        <div class="metric-cell">
                            <div class="metric-value" style="font-size: 16px; color: #64748b;">${tasksByStatus.backlog.length}</div>
                            <div class="metric-label" style="font-size: 9px;">Backlog</div>
                        </div>
                        <div class="metric-divider"></div>
                        <div class="metric-cell">
                            <div class="metric-value" style="font-size: 16px; color: #f59e0b;">${tasksByStatus.todo.length}</div>
                            <div class="metric-label" style="font-size: 9px;">Por Hacer</div>
                        </div>
                        <div class="metric-divider"></div>
                        <div class="metric-cell">
                            <div class="metric-value" style="font-size: 16px; color: #3b82f6;">${tasksByStatus.doing.length}</div>
                            <div class="metric-label" style="font-size: 9px;">En Progreso</div>
                        </div>
                        <div class="metric-divider"></div>
                        <div class="metric-cell">
                            <div class="metric-value" style="font-size: 16px; color: #22c55e;">${tasksByStatus.done.length}</div>
                            <div class="metric-label" style="font-size: 9px;">Completadas</div>
                        </div>
                    </div>

                    <!-- Kanban fills remaining space, List/Gantt scroll -->
                    <div style="flex: 1; min-height: 0; ${currentView === 'kanban' ? '' : 'overflow-y: auto;'}">
                        ${viewContent}
                    </div>
                `;
            },

            renderKanbanView(tasksByStatus) {
                const columns = [
                    { key: 'backlog', label: 'Backlog', color: '#64748b' },
                    { key: 'todo', label: 'Por Hacer', color: '#f59e0b' },
                    { key: 'doing', label: 'En Progreso', color: '#3b82f6' },
                    { key: 'done', label: 'Completadas', color: '#22c55e' }
                ];

                return `
                    <div class="kanban-board">
                        ${columns.map(col => `
                            <div class="kanban-column ${col.key}">
                                <div class="kanban-column-header">
                                    <span class="kanban-column-title">
                                        <span class="column-dot"></span>
                                        ${col.label}
                                    </span>
                                    <span class="kanban-column-count">${tasksByStatus[col.key].length}</span>
                                </div>
                                <div class="kanban-column-body">
                                    ${tasksByStatus[col.key].map(task => this.renderTaskCard(task)).join('')}
                                    <button class="kanban-add-btn" onclick="App.createNewTask('${col.key}')">
                                        <i class="fas fa-plus"></i> Agregar tarea
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            },

            renderTaskCard(task) {
                const priorityColors = {
                    low: '#64748b',
                    medium: '#3b82f6',
                    high: '#f59e0b',
                    critical: '#ef4444'
                };

                // P0-P3 notation for priority labels
                const priorityLabels = {
                    low: 'P3',
                    medium: 'P2',
                    high: 'P1',
                    critical: 'P0'
                };

                // Status labels for display
                const statusLabels = {
                    'pending': 'Pendiente',
                    'in_progress': 'En Progreso',
                    'review': 'En Revision',
                    'completed': 'Completada',
                    'blocked': 'Bloqueada',
                    'cancelled': 'Cancelada'
                };

                const dueDate = task.dueDate ? new Date(task.dueDate) : null;
                const today = new Date();
                const isOverdue = dueDate && dueDate < today && task.status !== 'done';
                const daysRemaining = dueDate ? Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24)) : null;

                // Use priorityLabel from transform if available, otherwise calculate
                const pLabel = task.priorityLabel || priorityLabels[task.priority] || 'P2';
                const pColor = priorityColors[task.priority] || '#3b82f6';

                // Progress bar with percentage text
                const progressBar = task.progress > 0 ? `
                    <div class="task-progress-container" style="display: flex; align-items: center; gap: 6px; margin-top: 6px;">
                        <div style="flex: 1; height: 3px; background: var(--bg-tertiary); border-radius: 2px; overflow: hidden;">
                            <div style="width: ${task.progress}%; height: 100%; background: ${pColor}; border-radius: 2px; transition: width 0.3s ease;"></div>
                        </div>
                        <span style="font-size: 9px; color: ${task.progress >= 100 ? '#22c55e' : 'var(--text-muted)'}; font-weight: 600; min-width: 28px;">${task.progress}%</span>
                    </div>
                ` : '';

                // Project badge (for cross-project views)
                const projectBadge = task.project_name ? `
                    <span class="task-project-badge" style="
                        display: inline-flex;
                        align-items: center;
                        gap: 3px;
                        font-size: 9px;
                        color: var(--solaria-orange);
                        background: rgba(246, 146, 29, 0.1);
                        padding: 2px 6px;
                        border-radius: 4px;
                        max-width: 120px;
                        overflow: hidden;
                        text-overflow: ellipsis;
                        white-space: nowrap;
                    ">
                        <i class="fas fa-folder"></i>
                        ${task.project_code || task.project_name.substring(0, 15)}
                    </span>
                ` : '';

                // Creation date (relative time)
                const createdDate = task.createdAt ? new Date(task.createdAt) : null;
                const createdAgo = createdDate ? this.getRelativeTime(createdDate) : '';
                const createdBadge = createdAgo ? `
                    <span class="task-created-badge" style="
                        display: inline-flex;
                        align-items: center;
                        gap: 3px;
                        font-size: 9px;
                        color: var(--text-muted);
                    ">
                        <i class="fas fa-clock"></i>
                        ${createdAgo}
                    </span>
                ` : '';

                // Estimated hours badge
                const hoursBadge = task.estimatedHours > 0 ? `
                    <span class="task-hours-badge" style="
                        display: inline-flex;
                        align-items: center;
                        gap: 3px;
                        font-size: 9px;
                        color: var(--text-muted);
                        background: var(--bg-tertiary);
                        padding: 2px 5px;
                        border-radius: 4px;
                    ">
                        <i class="fas fa-hourglass-half"></i>
                        ${task.estimatedHours}h
                    </span>
                ` : '';

                // Status chip for original status
                const statusChip = task.originalStatus ? `
                    <span style="font-size: 8px; padding: 1px 4px; background: var(--bg-tertiary); border-radius: 3px; color: var(--text-muted);">
                        ${statusLabels[task.originalStatus] || task.originalStatus}
                    </span>
                ` : '';

                // Checklist badge for task items
                const checklistBadge = (task.items_total && task.items_total > 0) ? `
                    <span class="checklist-badge" style="
                        display: inline-flex;
                        align-items: center;
                        gap: 4px;
                        font-size: 10px;
                        color: ${task.items_completed === task.items_total ? '#22c55e' : 'var(--text-muted)'};
                        background: ${task.items_completed === task.items_total ? 'rgba(34, 197, 94, 0.1)' : 'var(--bg-tertiary)'};
                        padding: 2px 6px;
                        border-radius: 8px;
                        margin-left: 6px;
                    ">
                        <i class="fas fa-check-square"></i>
                        ${task.items_completed}/${task.items_total}
                    </span>
                ` : '';

                return `
                    <div class="task-card" onclick="App.openTaskModal(${task.id})" data-task-id="${task.id}">
                        <div class="task-card-header">
                            <span class="task-card-title">${task.task_code ? `<span style="color: var(--solaria-orange); font-weight: 600; margin-right: 6px;">${task.task_code}</span>` : ''}${task.title}</span>
                            <div style="display: flex; align-items: center; gap: 4px; flex-wrap: wrap;">
                                <span class="priority-badge" style="background: ${pColor}20; color: ${pColor}; font-size: 9px; padding: 2px 6px; border-radius: 4px; font-weight: 700;">
                                    ${pLabel}
                                </span>
                                ${checklistBadge}
                                ${hoursBadge}
                            </div>
                        </div>
                        <p class="task-card-desc">${task.description || ''}</p>
                        ${progressBar}
                        <div class="task-card-info" style="display: flex; align-items: center; gap: 6px; flex-wrap: wrap; margin-top: 6px;">
                            ${projectBadge}
                            ${createdBadge}
                        </div>
                        <div class="task-card-footer">
                            <div class="task-card-meta">
                                <span class="task-card-assignee" style="display: flex; align-items: center; gap: 4px; font-size: 10px; color: var(--text-muted);">
                                    <i class="fas fa-user-circle"></i> ${task.assignee}
                                </span>
                                ${statusChip}
                            </div>
                            <div class="task-card-date ${isOverdue ? 'overdue' : ''}" style="${isOverdue ? 'color: #ef4444;' : ''}">
                                ${dueDate ? `
                                    <i class="fas fa-calendar"></i>
                                    ${isOverdue ? 'Vencida' : (daysRemaining <= 3 ? `${daysRemaining}d` : dueDate.toLocaleDateString('es-ES', { day: '2-digit', month: 'short' }))}
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            },

            // ============================================
            // Kanban Real-Time Update Methods
            // ============================================

            // Map API status to Kanban column
            getKanbanColumn(status) {
                const statusToColumn = {
                    'pending': 'backlog',
                    'blocked': 'backlog',
                    'in_progress': 'doing',
                    'review': 'doing',
                    'completed': 'done',
                    'cancelled': 'done'
                };
                return statusToColumn[status] || 'todo';
            },

            // Handle new task created via Socket.IO
            handleKanbanTaskCreated(data) {
                // Check if we're in tasks detail view with Kanban
                const kanbanBoard = document.querySelector('.kanban-board');
                if (!kanbanBoard) return;

                // Check if this task belongs to the current project view
                if (this.state.currentProjectId && data.project_id !== this.state.currentProjectId) {
                    return;
                }

                // Transform task data
                const task = this.transformTasksFromAPI([data])[0];
                if (!task) return;

                // Determine target column
                const columnKey = this.getKanbanColumn(data.status);
                const columnBody = kanbanBoard.querySelector(`.kanban-column.${columnKey} .kanban-column-body`);
                if (!columnBody) return;

                // Create task card HTML
                const taskCardHtml = this.renderTaskCard(task);

                // Insert before the "Add task" button
                const addBtn = columnBody.querySelector('.kanban-add-btn');
                if (addBtn) {
                    addBtn.insertAdjacentHTML('beforebegin', taskCardHtml);
                } else {
                    columnBody.insertAdjacentHTML('beforeend', taskCardHtml);
                }

                // Update column count
                const countBadge = kanbanBoard.querySelector(`.kanban-column.${columnKey} .kanban-column-count`);
                if (countBadge) {
                    countBadge.textContent = parseInt(countBadge.textContent || '0') + 1;
                }

                // Add highlight animation
                const newCard = columnBody.querySelector(`.task-card:last-of-type`);
                if (newCard) {
                    newCard.style.animation = 'fadeIn 0.3s ease';
                    newCard.style.boxShadow = '0 0 0 2px var(--solaria-orange)';
                    setTimeout(() => {
                        newCard.style.boxShadow = '';
                    }, 2000);
                }

                // Update state
                if (!this.state.currentTasks) this.state.currentTasks = [];
                this.state.currentTasks.push(task);

                console.log(` Kanban: Added task ${task.task_code || task.id} to ${columnKey}`);
            },

            // Handle task updated via Socket.IO
            handleKanbanTaskUpdated(data) {
                const kanbanBoard = document.querySelector('.kanban-board');
                if (!kanbanBoard) return;

                // Find existing card
                const existingCard = kanbanBoard.querySelector(`.task-card[onclick*="openTaskModal(${data.id})"]`);
                if (!existingCard) return;

                // Get current and new columns
                const currentColumn = existingCard.closest('.kanban-column');
                const newColumnKey = this.getKanbanColumn(data.status);
                const newColumn = kanbanBoard.querySelector(`.kanban-column.${newColumnKey}`);

                if (!currentColumn || !newColumn) return;

                // If column changed, move the card
                if (!currentColumn.classList.contains(newColumnKey)) {
                    // Remove from current column
                    existingCard.remove();

                    // Update old column count
                    const oldCount = currentColumn.querySelector('.kanban-column-count');
                    if (oldCount) {
                        oldCount.textContent = Math.max(0, parseInt(oldCount.textContent || '1') - 1);
                    }

                    // Transform and re-render task
                    const task = this.transformTasksFromAPI([data])[0];
                    if (task) {
                        const newCardHtml = this.renderTaskCard(task);
                        const newColumnBody = newColumn.querySelector('.kanban-column-body');
                        const addBtn = newColumnBody?.querySelector('.kanban-add-btn');

                        if (addBtn) {
                            addBtn.insertAdjacentHTML('beforebegin', newCardHtml);
                        } else if (newColumnBody) {
                            newColumnBody.insertAdjacentHTML('beforeend', newCardHtml);
                        }

                        // Update new column count
                        const newCount = newColumn.querySelector('.kanban-column-count');
                        if (newCount) {
                            newCount.textContent = parseInt(newCount.textContent || '0') + 1;
                        }

                        // Highlight moved card
                        const movedCard = newColumnBody?.querySelector(`.task-card:last-of-type`);
                        if (movedCard) {
                            movedCard.style.animation = 'slideIn 0.3s ease';
                            movedCard.style.boxShadow = '0 0 0 2px #3b82f6';
                            setTimeout(() => {
                                movedCard.style.boxShadow = '';
                            }, 2000);
                        }
                    }

                    console.log(` Kanban: Moved task ${data.id} to ${newColumnKey}`);
                } else {
                    // Just update the card content in place
                    const task = this.transformTasksFromAPI([data])[0];
                    if (task) {
                        existingCard.outerHTML = this.renderTaskCard(task);
                    }
                    console.log(` Kanban: Updated task ${data.id} in place`);
                }

                // Update state
                if (this.state.currentTasks) {
                    const idx = this.state.currentTasks.findIndex(t => t.id === data.id);
                    if (idx >= 0) {
                        this.state.currentTasks[idx] = { ...this.state.currentTasks[idx], ...data };
                    }
                }
            },

            // Handle task deleted via Socket.IO
            handleKanbanTaskDeleted(data) {
                const kanbanBoard = document.querySelector('.kanban-board');
                if (!kanbanBoard) return;

                // Find and remove card
                const card = kanbanBoard.querySelector(`.task-card[onclick*="openTaskModal(${data.id})"]`);
                if (!card) return;

                const column = card.closest('.kanban-column');

                // Animate removal
                card.style.animation = 'fadeOut 0.3s ease';
                card.style.opacity = '0';

                setTimeout(() => {
                    card.remove();

                    // Update column count
                    if (column) {
                        const count = column.querySelector('.kanban-column-count');
                        if (count) {
                            count.textContent = Math.max(0, parseInt(count.textContent || '1') - 1);
                        }
                    }
                }, 300);

                // Update state
                if (this.state.currentTasks) {
                    this.state.currentTasks = this.state.currentTasks.filter(t => t.id !== data.id);
                }

                console.log(` Kanban: Removed task ${data.id}`);
            },

            // ============================================
            // UNIFIED REAL-TIME HANDLERS FOR ALL VIEWS
            // ============================================

            // Update internal state with new/updated task
            updateStateTask(taskData, action = 'upsert') {
                if (!this.state.currentTasks) this.state.currentTasks = [];

                const transformedTask = this.transformTasksFromAPI([taskData])[0];
                if (!transformedTask) return null;

                if (action === 'delete') {
                    this.state.currentTasks = this.state.currentTasks.filter(t => t.id !== taskData.id);
                } else {
                    const idx = this.state.currentTasks.findIndex(t => t.id === taskData.id);
                    if (idx >= 0) {
                        this.state.currentTasks[idx] = { ...this.state.currentTasks[idx], ...transformedTask };
                    } else {
                        this.state.currentTasks.push(transformedTask);
                    }
                }
                return transformedTask;
            },

            // Unified handler - calls appropriate view handlers
            handleTaskRealTimeEvent(data, action) {
                console.log(` Real-time ${action}:`, data.id, data.title);

                // Check if task belongs to current project view
                if (this.state.currentProjectId && data.project_id !== this.state.currentProjectId) {
                    console.log('    Task belongs to different project, skipping view update');
                    return;
                }

                // Update internal state
                const task = this.updateStateTask(data, action);

                // Update whichever view is active
                if (action === 'create') {
                    this.handleKanbanTaskCreated(data);
                    this.handleListTaskCreated(data);
                    this.handleGanttTaskCreated(data);
                } else if (action === 'update') {
                    this.handleKanbanTaskUpdated(data);
                    this.handleListTaskUpdated(data);
                    this.handleGanttTaskUpdated(data);
                } else if (action === 'delete') {
                    this.handleKanbanTaskDeleted(data);
                    this.handleListTaskDeleted(data);
                    this.handleGanttTaskDeleted(data);
                }

                // Update dashboard widgets
                this.handleDashboardWidgetsUpdate(data, action);
            },

            // LIST VIEW HANDLERS
            handleListTaskCreated(data) {
                const listTable = document.querySelector('.list-table tbody');
                if (!listTable) return;

                const task = this.transformTasksFromAPI([data])[0];
                if (!task) return;

                const rowHtml = this.renderListRow(task);
                listTable.insertAdjacentHTML('afterbegin', rowHtml);

                const newRow = listTable.querySelector(`tr[data-task-id="${task.id}"]`);
                if (newRow) {
                    newRow.style.animation = 'fadeIn 0.3s ease';
                    newRow.style.background = 'rgba(246, 146, 29, 0.1)';
                    setTimeout(() => { newRow.style.background = ''; }, 2000);
                }
                console.log(` List: Added task ${data.id}`);
            },

            handleListTaskUpdated(data) {
                const existingRow = document.querySelector(`.list-table tr[data-task-id="${data.id}"]`);
                if (!existingRow) return;

                const task = this.transformTasksFromAPI([data])[0];
                if (!task) return;

                const tempDiv = document.createElement('tbody');
                tempDiv.innerHTML = this.renderListRow(task);
                const newRow = tempDiv.firstElementChild;

                existingRow.innerHTML = newRow.innerHTML;
                existingRow.style.animation = 'pulse 0.5s ease';
                existingRow.style.background = 'rgba(246, 146, 29, 0.05)';
                setTimeout(() => { existingRow.style.background = ''; }, 1500);

                console.log(` List: Updated task ${data.id}`);
            },

            handleListTaskDeleted(data) {
                const row = document.querySelector(`.list-table tr[data-task-id="${data.id}"]`);
                if (!row) return;

                row.style.animation = 'fadeOut 0.3s ease';
                row.style.opacity = '0';
                setTimeout(() => row.remove(), 300);
                console.log(` List: Removed task ${data.id}`);
            },

            renderListRow(task) {
                const priorityColors = { low: '#64748b', medium: '#3b82f6', high: '#f59e0b', critical: '#ef4444' };
                const statusLabels = { backlog: 'Backlog', todo: 'Por Hacer', doing: 'En Progreso', done: 'Completada' };
                const statusColors = { backlog: '#64748b', todo: '#f59e0b', doing: '#3b82f6', done: '#22c55e' };
                const pLabel = task.priorityLabel || this.formatPriority(task.priority);
                const pColor = priorityColors[task.priority] || '#3b82f6';
                const dueStr = task.dueDate ? new Date(task.dueDate).toLocaleDateString('es-ES', { day: '2-digit', month: 'short' }) : '-';

                return `
                    <tr data-task-id="${task.id}" onclick="App.openTaskModal(${task.id})" style="cursor: pointer;">
                        <td>
                            <div style="font-weight: 500;">${task.title}</div>
                            <div style="font-size: 11px; color: var(--text-muted); max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${task.description || ''}</div>
                        </td>
                        <td>
                            <span style="display: inline-flex; align-items: center; gap: 6px;">
                                <span style="width: 8px; height: 8px; border-radius: 50%; background: ${statusColors[task.status]};"></span>
                                ${statusLabels[task.status] || task.status}
                            </span>
                        </td>
                        <td>
                            <span style="background: ${pColor}20; color: ${pColor}; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 700;">
                                ${pLabel}
                            </span>
                        </td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <div style="flex: 1; height: 4px; background: var(--bg-tertiary); border-radius: 2px; overflow: hidden;">
                                    <div style="width: ${task.progress || 0}%; height: 100%; background: ${pColor};"></div>
                                </div>
                                <span style="font-size: 10px; color: var(--text-muted);">${task.progress || 0}%</span>
                            </div>
                        </td>
                        <td style="font-size: 12px;">${task.assignee || '-'}</td>
                        <td style="font-size: 12px;">${dueStr}</td>
                    </tr>
                `;
            },

            // GANTT VIEW HANDLERS
            handleGanttTaskCreated(data) {
                const ganttBody = document.querySelector('.gantt-body');
                if (!ganttBody) return;
                if (data.status === 'completed' || data.status === 'done') return; // Gantt doesn't show completed

                const task = this.transformTasksFromAPI([data])[0];
                if (!task) return;

                const rowHtml = this.renderGanttRow(task);
                ganttBody.insertAdjacentHTML('afterbegin', rowHtml);

                const newRow = ganttBody.querySelector(`div.gantt-row[data-task-id="${task.id}"]`);
                if (newRow) {
                    newRow.style.animation = 'fadeIn 0.3s ease';
                }
                console.log(` Gantt: Added task ${data.id}`);
            },

            handleGanttTaskUpdated(data) {
                const existingRow = document.querySelector(`.gantt-row[data-task-id="${data.id}"]`);

                // If task is now completed, remove from Gantt
                if (data.status === 'completed' || data.status === 'done') {
                    if (existingRow) {
                        existingRow.style.animation = 'fadeOut 0.3s ease';
                        setTimeout(() => existingRow.remove(), 300);
                    }
                    return;
                }

                if (!existingRow) {
                    // Task wasn't in Gantt, add it
                    this.handleGanttTaskCreated(data);
                    return;
                }

                const task = this.transformTasksFromAPI([data])[0];
                if (!task) return;

                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = this.renderGanttRow(task);
                const newRow = tempDiv.firstElementChild;

                existingRow.outerHTML = newRow.outerHTML;
                console.log(` Gantt: Updated task ${data.id}`);
            },

            handleGanttTaskDeleted(data) {
                const row = document.querySelector(`.gantt-row[data-task-id="${data.id}"]`);
                if (!row) return;

                row.style.animation = 'fadeOut 0.3s ease';
                row.style.opacity = '0';
                setTimeout(() => row.remove(), 300);
                console.log(` Gantt: Removed task ${data.id}`);
            },

            renderGanttRow(task) {
                const priorityColors = { low: '#64748b', medium: '#3b82f6', high: '#f59e0b', critical: '#ef4444' };
                const pColor = priorityColors[task.priority] || '#3b82f6';
                const pLabel = task.priorityLabel || this.formatPriority(task.priority);

                // Calculate timeline positioning
                const today = new Date();
                const startDate = new Date(today);
                startDate.setDate(today.getDate() - 14); // 2 weeks back
                const totalDays = 8 * 7;

                const taskDue = task.dueDate ? new Date(task.dueDate) : new Date(Date.now() + 14 * 24 * 60 * 60 * 1000);
                const taskStart = task.createdAt ? new Date(task.createdAt) : new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
                const startOffset = Math.max(0, Math.floor((taskStart - startDate) / (1000 * 60 * 60 * 24)));
                const duration = Math.max(5, Math.ceil((taskDue - taskStart) / (1000 * 60 * 60 * 24)));
                const leftPercent = Math.max(0, Math.min(95, (startOffset / totalDays) * 100));
                const widthPercent = Math.max(5, Math.min((duration / totalDays) * 100, 100 - leftPercent));

                return `
                    <div class="gantt-row" data-task-id="${task.id}" onclick="App.openTaskModal(${task.id})" style="cursor: pointer;">
                        <div class="gantt-row-label" style="display: flex; align-items: center; gap: 8px;">
                            <span style="background: ${pColor}20; color: ${pColor}; padding: 2px 6px; border-radius: 4px; font-size: 9px; font-weight: 700;">${pLabel}</span>
                            <span style="flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${task.title}</span>
                        </div>
                        <div class="gantt-row-bars">
                            <div class="gantt-bar" style="left: ${leftPercent}%; width: ${widthPercent}%; background: ${pColor}; opacity: 0.85; border-radius: 4px;">
                                ${task.progress > 0 ? `<div style="position: absolute; left: 0; top: 0; bottom: 0; width: ${task.progress}%; background: ${pColor}; opacity: 1; border-radius: 4px 0 0 4px;"></div>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            },

            // DASHBOARD WIDGETS HANDLER
            handleDashboardWidgetsUpdate(data, action) {
                // Update KPIs card if on dashboard
                const kpiTasks = document.querySelector('.metric-value[data-metric="tasks"]');
                if (kpiTasks) {
                    const current = parseInt(kpiTasks.textContent) || 0;
                    if (action === 'create') kpiTasks.textContent = current + 1;
                    if (action === 'delete') kpiTasks.textContent = Math.max(0, current - 1);
                }

                // Update project cards progress if visible
                const projectCard = document.querySelector(`.project-card[data-project-id="${data.project_id}"]`);
                if (projectCard) {
                    // Refresh project card via API would be overkill, just flash it
                    projectCard.style.boxShadow = '0 0 0 2px var(--solaria-orange)';
                    setTimeout(() => { projectCard.style.boxShadow = ''; }, 1500);
                }

                console.log(` Dashboard: Widgets notified of ${action}`);
            },

            renderGanttView(tasks) {
                // Generate weeks for the next 8 weeks
                const weeks = [];
                const today = new Date();
                for (let i = -2; i < 6; i++) {
                    const weekStart = new Date(today);
                    weekStart.setDate(today.getDate() + (i * 7) - today.getDay());
                    weeks.push({
                        label: `Sem ${weekStart.getDate()}/${weekStart.getMonth() + 1}`,
                        start: weekStart
                    });
                }

                const totalDays = 8 * 7; // 8 weeks
                const startDate = weeks[0].start;

                const priorityColors = {
                    low: '#64748b',
                    medium: '#3b82f6',
                    high: '#f59e0b',
                    critical: '#ef4444'
                };

                // Filter and sort tasks for Gantt
                const ganttTasks = tasks
                    .filter(t => t.status !== 'done')
                    .sort((a, b) => {
                        const priorityOrder = { critical: 0, high: 1, medium: 2, low: 3 };
                        return (priorityOrder[a.priority] || 2) - (priorityOrder[b.priority] || 2);
                    })
                    .slice(0, 15);

                return `
                    <div class="gantt-container" style="background: var(--bg-secondary); border-radius: 12px; padding: 16px;">
                        <div class="gantt-header" style="padding-left: 250px;">
                            ${weeks.map(w => `<div class="gantt-header-cell">${w.label}</div>`).join('')}
                        </div>
                        <div class="gantt-body">
                            ${ganttTasks.map(task => {
                                const taskDue = task.dueDate ? new Date(task.dueDate) : new Date(Date.now() + 14 * 24 * 60 * 60 * 1000);
                                const taskStart = task.createdAt ? new Date(task.createdAt) : new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);

                                // Calculate positions
                                const startOffset = Math.max(0, Math.floor((taskStart - startDate) / (1000 * 60 * 60 * 24)));
                                const duration = Math.max(5, Math.ceil((taskDue - taskStart) / (1000 * 60 * 60 * 24)));

                                const leftPercent = Math.max(0, Math.min(95, (startOffset / totalDays) * 100));
                                const widthPercent = Math.max(5, Math.min((duration / totalDays) * 100, 100 - leftPercent));

                                const pColor = priorityColors[task.priority] || '#3b82f6';
                                const pLabel = task.priorityLabel || this.formatPriority(task.priority);

                                return `
                                    <div class="gantt-row" onclick="App.openTaskModal(${task.id})" style="cursor: pointer;">
                                        <div class="gantt-row-label" style="display: flex; align-items: center; gap: 8px;">
                                            <span style="background: ${pColor}20; color: ${pColor}; padding: 2px 6px; border-radius: 4px; font-size: 9px; font-weight: 700;">${pLabel}</span>
                                            <span style="flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${task.title}</span>
                                        </div>
                                        <div class="gantt-row-bars">
                                            <div class="gantt-bar" style="left: ${leftPercent}%; width: ${widthPercent}%; background: ${pColor}; opacity: 0.85; border-radius: 4px;">
                                                ${task.progress > 0 ? `<div style="position: absolute; left: 0; top: 0; bottom: 0; width: ${task.progress}%; background: ${pColor}; opacity: 1; border-radius: 4px 0 0 4px;"></div>` : ''}
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        ${ganttTasks.length === 0 ? '<div style="text-align: center; padding: 40px; color: var(--text-muted);">No hay tareas pendientes para mostrar en el Gantt</div>' : ''}
                    </div>
                `;
            },

            renderListView(tasks) {
                const sortedTasks = [...tasks].sort((a, b) => {
                    const statusOrder = { doing: 0, todo: 1, backlog: 2, done: 3 };
                    return statusOrder[a.status] - statusOrder[b.status];
                });

                const priorityColors = {
                    low: '#64748b',
                    medium: '#3b82f6',
                    high: '#f59e0b',
                    critical: '#ef4444'
                };

                return `
                    <div class="project-card" style="padding: 0; overflow: hidden;">
                        <table class="list-table">
                            <thead>
                                <tr>
                                    <th style="width: 35%;">Tarea</th>
                                    <th style="width: 12%;">Estado</th>
                                    <th style="width: 10%;">Prioridad</th>
                                    <th style="width: 10%;">Progreso</th>
                                    <th style="width: 18%;">Asignado</th>
                                    <th style="width: 15%;">Fecha</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${sortedTasks.map(task => {
                                    const statusLabels = { backlog: 'Backlog', todo: 'Por Hacer', doing: 'En Progreso', done: 'Completada' };
                                    const statusColors = { backlog: '#64748b', todo: '#f59e0b', doing: '#3b82f6', done: '#22c55e' };
                                    const pLabel = task.priorityLabel || this.formatPriority(task.priority);
                                    const pColor = priorityColors[task.priority] || '#3b82f6';
                                    const dueStr = task.dueDate ? new Date(task.dueDate).toLocaleDateString('es-ES', { day: '2-digit', month: 'short' }) : '-';

                                    return `
                                        <tr onclick="App.openTaskModal(${task.id})" style="cursor: pointer;">
                                            <td>
                                                <div style="font-weight: 500;">${task.title}</div>
                                                <div style="font-size: 11px; color: var(--text-muted); max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${task.description || ''}</div>
                                            </td>
                                            <td>
                                                <span style="display: inline-flex; align-items: center; gap: 6px;">
                                                    <span style="width: 8px; height: 8px; border-radius: 50%; background: ${statusColors[task.status]};"></span>
                                                    ${statusLabels[task.status]}
                                                </span>
                                            </td>
                                            <td>
                                                <span style="background: ${pColor}20; color: ${pColor}; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 700;">
                                                    ${pLabel}
                                                </span>
                                            </td>
                                            <td>
                                                <div style="display: flex; align-items: center; gap: 6px;">
                                                    <div style="flex: 1; height: 4px; background: var(--bg-tertiary); border-radius: 2px; overflow: hidden;">
                                                        <div style="width: ${task.progress || 0}%; height: 100%; background: ${pColor};"></div>
                                                    </div>
                                                    <span style="font-size: 10px; color: var(--text-muted);">${task.progress || 0}%</span>
                                                </div>
                                            </td>
                                            <td style="font-size: 12px;">${task.assignee}</td>
                                            <td style="font-size: 12px;">${dueStr}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            },

            switchTasksView(view) {
                this.state.tasksView = view;
                // Re-render with cached tasks if available
                const project = this.state.currentProject;
                const tasks = this.state.currentTasks;
                if (project && tasks && tasks.length > 0) {
                    this.renderTasksDetailPage(project, tasks);
                } else {
                    this.openTasksDetail(); // Fetch fresh if no cached tasks
                }
            },

            createNewTask(status = 'backlog') {
                alert(`Crear nueva tarea en columna: ${status}\n\n(Esta funcionalidad se conectara con la API)`);
            },

            async openTaskModal(taskId) {
                // Find task from current tasks or fetch from API
                let task = this.state.currentTasks?.find(t => t.id === taskId);

                if (!task) {
                    console.warn('Task not found:', taskId);
                    return;
                }

                // Fetch task items (checklist) from API
                try {
                    const itemsResponse = await API.getTaskItems(taskId);
                    if (itemsResponse && itemsResponse.items) {
                        task = { ...task, items: itemsResponse.items };
                    }
                } catch (error) {
                    console.warn('Could not load task items:', error);
                    task = { ...task, items: [] };
                }

                const priorityColors = {
                    low: '#64748b',
                    medium: '#3b82f6',
                    high: '#f59e0b',
                    critical: '#ef4444'
                };

                const statusLabels = {
                    'pending': 'Pendiente',
                    'in_progress': 'En Progreso',
                    'review': 'En Revision',
                    'completed': 'Completada',
                    'blocked': 'Bloqueada',
                    'cancelled': 'Cancelada'
                };

                const pLabel = task.priorityLabel || this.formatPriority(task.priority);
                const pColor = priorityColors[task.priority] || '#3b82f6';
                const statusLabel = statusLabels[task.originalStatus] || task.originalStatus || 'Sin estado';

                const createdDate = task.createdAt ? new Date(task.createdAt).toLocaleDateString('es-ES', {
                    day: '2-digit',
                    month: 'long',
                    year: 'numeric'
                }) : 'N/A';

                const dueDate = task.dueDate ? new Date(task.dueDate).toLocaleDateString('es-ES', {
                    day: '2-digit',
                    month: 'long',
                    year: 'numeric'
                }) : 'Sin fecha limite';

                // Format estimated hours display
                const hoursDisplay = task.estimatedHours
                    ? (Number.isInteger(task.estimatedHours)
                        ? `${task.estimatedHours}h`
                        : `${task.estimatedHours.toFixed(1)}h`)
                    : '0h';

                // Render description with basic markdown support
                const descriptionHTML = this.renderMarkdownDescription(task.description);

                const modalHTML = `
                    <div class="edit-modal-overlay" id="taskModalOverlay" onclick="App.closeTaskModal(event)">
                        <div class="edit-modal" onclick="event.stopPropagation()" style="max-width: 600px; max-height: 90vh; overflow-y: auto;">
                            <div class="edit-modal-header" style="border-left: 4px solid ${pColor};">
                                <div>
                                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 4px;">
                                        <span style="background: ${pColor}20; color: ${pColor}; font-size: 11px; padding: 3px 8px; border-radius: 4px; font-weight: 700;">
                                            ${pLabel}
                                        </span>
                                        <span style="background: var(--bg-tertiary); padding: 3px 8px; border-radius: 4px; font-size: 11px;">
                                            ${statusLabel}
                                        </span>
                                        <span style="color: var(--text-muted); font-size: 11px;">${task.task_code || '#' + task.id}</span>
                                    </div>
                                    <h3 class="edit-modal-title" style="font-size: 16px;">${this.escapeHtml(task.title)}</h3>
                                </div>
                                <button class="edit-modal-close" onclick="App.closeTaskModal()">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>

                            <div class="edit-modal-body" style="padding: 20px;">
                                <!-- Description with Markdown -->
                                <div class="form-section" style="margin-bottom: 20px;">
                                    <h4 class="form-section-title" style="margin-bottom: 8px;">
                                        <i class="fas fa-align-left" style="color: var(--solaria-orange);"></i> Descripcion
                                    </h4>
                                    <div class="task-description-content" style="color: var(--text-secondary); font-size: 13px; line-height: 1.6;">
                                        ${descriptionHTML}
                                    </div>
                                </div>

                                <!-- Progress Bar -->
                                ${task.progress > 0 ? `
                                    <div class="form-section" style="margin-bottom: 20px;">
                                        <h4 class="form-section-title" style="margin-bottom: 8px;">
                                            <i class="fas fa-tasks" style="color: var(--solaria-orange);"></i> Progreso
                                        </h4>
                                        <div style="display: flex; align-items: center; gap: 12px;">
                                            <div style="flex: 1; height: 8px; background: var(--bg-tertiary); border-radius: 4px; overflow: hidden;">
                                                <div style="width: ${task.progress}%; height: 100%; background: ${pColor}; border-radius: 4px;"></div>
                                            </div>
                                            <span style="font-size: 14px; font-weight: 600; color: ${pColor};">${task.progress}%</span>
                                        </div>
                                    </div>
                                ` : ''}

                                <!-- Tags Section (DFO-036) -->
                                <div class="form-section" style="margin-bottom: 20px;">
                                    <h4 class="form-section-title" style="margin-bottom: 8px;">
                                        <i class="fas fa-tags" style="color: var(--solaria-orange);"></i> Etiquetas
                                    </h4>
                                    <div id="taskTagsContainer" data-task-id="${task.id}" style="display: flex; flex-wrap: wrap; gap: 6px;">
                                        <span style="color: var(--text-muted); font-size: 12px;">Cargando...</span>
                                    </div>
                                    <div class="tag-picker" id="tagPicker" style="display: none;">
                                    </div>
                                    <button type="button" onclick="App.toggleTagPicker(${task.id})" style="
                                        margin-top: 8px;
                                        padding: 4px 10px;
                                        font-size: 11px;
                                        border: 1px dashed var(--border-color);
                                        background: transparent;
                                        color: var(--text-muted);
                                        border-radius: 6px;
                                        cursor: pointer;
                                    ">
                                        <i class="fas fa-plus"></i> Agregar
                                    </button>
                                </div>

                                <!-- Checklist Section -->
                                ${task.items && task.items.length > 0 ? `
                                    <div class="form-section" style="margin-bottom: 20px; padding: 16px; background: var(--bg-secondary); border-radius: 12px;">
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                            <h4 class="form-section-title" style="margin: 0;">
                                                <i class="fas fa-tasks" style="color: var(--solaria-orange); margin-right: 8px;"></i>
                                                Checklist de Trabajo
                                            </h4>
                                            <span style="font-size: 12px; color: var(--text-muted);">
                                                ${task.items.filter(i => i.is_completed).length}/${task.items.length} completadas
                                            </span>
                                        </div>

                                        <div class="checklist-items" style="display: flex; flex-direction: column; gap: 8px; max-height: 300px; overflow-y: auto;">
                                            ${task.items.sort((a, b) => (a.sort_order || 0) - (b.sort_order || 0)).map(item => `
                                                <div class="checklist-item" style="
                                                    display: flex;
                                                    align-items: flex-start;
                                                    gap: 12px;
                                                    padding: 12px;
                                                    background: var(--bg-tertiary);
                                                    border-radius: 8px;
                                                    border-left: 3px solid ${item.is_completed ? '#22c55e' : 'var(--border-color)'};
                                                    ${item.is_completed ? 'opacity: 0.7;' : ''}
                                                ">
                                                    <div style="
                                                        width: 22px;
                                                        height: 22px;
                                                        border-radius: 6px;
                                                        border: 2px solid ${item.is_completed ? '#22c55e' : 'var(--border-color)'};
                                                        background: ${item.is_completed ? 'rgba(34, 197, 94, 0.2)' : 'transparent'};
                                                        display: flex;
                                                        align-items: center;
                                                        justify-content: center;
                                                        flex-shrink: 0;
                                                    ">
                                                        ${item.is_completed ? '<i class="fas fa-check" style="font-size: 11px; color: #22c55e;"></i>' : ''}
                                                    </div>
                                                    <div style="flex: 1; min-width: 0;">
                                                        <div style="
                                                            font-size: 13px;
                                                            color: var(--text-primary);
                                                            ${item.is_completed ? 'text-decoration: line-through; color: var(--text-muted);' : ''}
                                                        ">
                                                            ${item.title}
                                                        </div>
                                                        ${item.description ? `
                                                            <div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">
                                                                ${item.description}
                                                            </div>
                                                        ` : ''}
                                                        ${item.completed_at ? `
                                                            <div style="font-size: 10px; color: var(--text-muted); margin-top: 6px;">
                                                                <i class="fas fa-clock" style="margin-right: 4px;"></i>
                                                                Completado: ${new Date(item.completed_at).toLocaleString('es-MX', {
                                                                    day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit'
                                                                })}
                                                                ${item.actual_minutes ? ` (${item.actual_minutes} min)` : ''}
                                                            </div>
                                                        ` : ''}
                                                    </div>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                ` : `
                                    <div class="form-section" style="
                                        margin-bottom: 20px;
                                        padding: 20px;
                                        background: var(--bg-secondary);
                                        border-radius: 12px;
                                        text-align: center;
                                        color: var(--text-muted);
                                    ">
                                        <i class="fas fa-list-check" style="font-size: 24px; margin-bottom: 8px; opacity: 0.5;"></i>
                                        <div style="font-size: 13px;">Sin checklist de trabajo definido</div>
                                        <div style="font-size: 11px; margin-top: 4px;">El agente creara el desglose al iniciar la tarea</div>
                                    </div>
                                `}

                                <!-- Details Grid -->
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
                                    <div class="form-section">
                                        <h4 class="form-section-title" style="margin-bottom: 6px;">
                                            <i class="fas fa-user" style="color: #60a5fa;"></i> Asignado a
                                        </h4>
                                        <p style="font-size: 13px;">${task.assignee}</p>
                                    </div>

                                    <div class="form-section">
                                        <h4 class="form-section-title" style="margin-bottom: 6px;">
                                            <i class="fas fa-clock" style="color: #fbbf24;"></i> Horas Estimadas
                                        </h4>
                                        <p style="font-size: 13px;">${hoursDisplay}</p>
                                    </div>

                                    <div class="form-section">
                                        <h4 class="form-section-title" style="margin-bottom: 6px;">
                                            <i class="fas fa-calendar-plus" style="color: #22c55e;"></i> Fecha Creacion
                                        </h4>
                                        <p style="font-size: 13px;">${createdDate}</p>
                                    </div>

                                    <div class="form-section">
                                        <h4 class="form-section-title" style="margin-bottom: 6px;">
                                            <i class="fas fa-calendar-check" style="color: #ef4444;"></i> Fecha Limite
                                        </h4>
                                        <p style="font-size: 13px;">${dueDate}</p>
                                    </div>

                                    ${task.epic ? `
                                        <div class="form-section">
                                            <h4 class="form-section-title" style="margin-bottom: 6px;">
                                                <i class="fas fa-layer-group" style="color: #a855f7;"></i> Epic
                                            </h4>
                                            <p style="font-size: 13px;">${task.epic}</p>
                                        </div>
                                    ` : ''}

                                    ${task.sprint ? `
                                        <div class="form-section">
                                            <h4 class="form-section-title" style="margin-bottom: 6px;">
                                                <i class="fas fa-running" style="color: #14b8a6;"></i> Sprint
                                            </h4>
                                            <p style="font-size: 13px;">${task.sprint}</p>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>

                            <div class="edit-modal-footer" style="justify-content: space-between;">
                                <button class="btn-secondary" onclick="App.closeTaskModal()">
                                    Cerrar
                                </button>
                                <div style="display: flex; gap: 8px;">
                                    <button class="btn-secondary" onclick="alert('Edicion via API - Proximamente')">
                                        <i class="fas fa-edit"></i> Editar
                                    </button>
                                    <button class="btn-primary" onclick="alert('Cambiar estado via API - Proximamente')">
                                        <i class="fas fa-check"></i> Marcar Completada
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                document.body.insertAdjacentHTML('beforeend', modalHTML);

                // Load task tags (DFO-036)
                this.loadTaskTags(task.id);
            },

            closeTaskModal(e) {
                if (e && e.target !== e.currentTarget) return;
                const overlay = document.getElementById('taskModalOverlay');
                if (overlay) overlay.remove();
            },

            // ============================================
            // TASK TAGS (DFO-036)
            // ============================================

            async loadTaskTags(taskId) {
                const container = document.getElementById('taskTagsContainer');
                if (!container) return;

                try {
                    const response = await API.getTaskTags(taskId);
                    const tags = response.tags || [];

                    if (tags.length === 0) {
                        container.innerHTML = '<span style="color: var(--text-muted); font-size: 12px; font-style: italic;">Sin etiquetas</span>';
                    } else {
                        container.innerHTML = tags.map(tag => this.renderTaskTag(tag, taskId)).join('');
                    }
                } catch (error) {
                    console.error('Error loading task tags:', error);
                    container.innerHTML = '<span style="color: var(--text-muted); font-size: 12px;">Error cargando etiquetas</span>';
                }
            },

            renderTaskTag(tag, taskId) {
                return `
                    <span class="task-tag" style="background: ${tag.color}20; color: ${tag.color};" title="${tag.description || tag.name}">
                        <i class="fas fa-${tag.icon || 'tag'}"></i>
                        ${tag.name}
                        <i class="fas fa-times" style="margin-left: 4px; cursor: pointer; opacity: 0.7;"
                           onclick="event.stopPropagation(); App.removeTagFromTask(${taskId}, ${tag.id})"></i>
                    </span>
                `;
            },

            async toggleTagPicker(taskId) {
                const picker = document.getElementById('tagPicker');
                if (!picker) return;

                if (picker.style.display === 'none' || !picker.style.display) {
                    // Load available tags
                    picker.innerHTML = TASK_TAGS_DATA.map(tag => {
                        return `
                            <span class="tag-picker-item"
                                  style="background: ${tag.color}15; color: ${tag.color};"
                                  onclick="App.addTagToTask(${taskId}, '${tag.name}')">
                                <i class="fas fa-${tag.icon || 'tag'}"></i>
                                ${tag.name}
                            </span>
                        `;
                    }).join('');
                    picker.style.display = 'flex';
                } else {
                    picker.style.display = 'none';
                }
            },

            async addTagToTask(taskId, tagName) {
                try {
                    await API.addTaskTag(taskId, tagName);
                    await this.loadTaskTags(taskId);

                    // Hide picker after adding
                    const picker = document.getElementById('tagPicker');
                    if (picker) picker.style.display = 'none';

                    // Show notification
                    this.showNotification(`Etiqueta "${tagName}" agregada`, 'success');
                } catch (error) {
                    if (error.message?.includes('409')) {
                        this.showNotification('Esta etiqueta ya esta asignada', 'warning');
                    } else {
                        console.error('Error adding tag:', error);
                        this.showNotification('Error al agregar etiqueta', 'error');
                    }
                }
            },

            async removeTagFromTask(taskId, tagId) {
                try {
                    await API.removeTaskTag(taskId, tagId);
                    await this.loadTaskTags(taskId);
                    this.showNotification('Etiqueta eliminada', 'info');
                } catch (error) {
                    console.error('Error removing tag:', error);
                    this.showNotification('Error al eliminar etiqueta', 'error');
                }
            },

            goBackToProjectDetail() {
                if (this.state.currentProject) {
                    this.renderProjectDetail(this.state.currentProject);
                } else {
                    this.renderProjectsPage();
                }
            },

            // ============================================
            // BUDGET DETAIL PAGE
            // ============================================

            openBudgetDetail() {
                const project = this.state.currentProject;
                if (!project) {
                    console.warn('No project selected');
                    return;
                }

                const { budget, deadline } = project.stats;
                const budgetFormatted = new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'USD' }).format(budget);

                // Mock budget data
                const executed = Math.round(budget * 0.65);
                const remaining = budget - executed;
                const executedFormatted = new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'USD' }).format(executed);
                const remainingFormatted = new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'USD' }).format(remaining);

                const deadlineDate = new Date(deadline);
                const today = new Date();
                const daysRemaining = Math.ceil((deadlineDate - today) / (1000 * 60 * 60 * 24));

                // Mock monthly data
                const monthlyData = [
                    { month: 'Sep', planned: 15000, actual: 14200 },
                    { month: 'Oct', planned: 25000, actual: 27500 },
                    { month: 'Nov', planned: 35000, actual: 32000 },
                    { month: 'Dic', planned: 45000, actual: 43800 },
                    { month: 'Ene', planned: 55000, actual: 52000 },
                    { month: 'Feb', planned: 65000, actual: 0 }
                ];

                // Mock expense categories
                const categories = [
                    { name: 'Desarrollo', amount: executed * 0.45, icon: 'fa-code', color: '#3b82f6' },
                    { name: 'Diseo', amount: executed * 0.2, icon: 'fa-palette', color: '#a855f7' },
                    { name: 'Infraestructura', amount: executed * 0.15, icon: 'fa-server', color: '#22c55e' },
                    { name: 'Gestion', amount: executed * 0.12, icon: 'fa-users', color: '#f59e0b' },
                    { name: 'Otros', amount: executed * 0.08, icon: 'fa-ellipsis-h', color: '#64748b' }
                ];

                this.elements.contentArea.innerHTML = `
                    <div class="section-header">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <button class="header-btn" onclick="App.goBackToProjectDetail()" title="Volver al proyecto">
                                <i class="fas fa-arrow-left"></i>
                            </button>
                            <div>
                                <h1 class="section-title">Presupuesto - ${project.name}</h1>
                                <p class="section-subtitle">Gestion financiera del proyecto</p>
                            </div>
                        </div>
                        <div class="section-actions">
                            <button class="btn-secondary" onclick="App.exportBudgetReport()">
                                <i class="fas fa-download"></i> Exportar
                            </button>
                        </div>
                    </div>

                    <!-- Budget Summary -->
                    <div class="metrics-row" style="margin-bottom: 16px;">
                        <div class="metric-cell">
                            <div class="metric-label">Presupuesto Total</div>
                            <div class="metric-value" style="color: var(--solaria-orange);">${budgetFormatted}</div>
                        </div>
                        <div class="metric-divider"></div>
                        <div class="metric-cell">
                            <div class="metric-label">Ejecutado</div>
                            <div class="metric-value" style="color: #3b82f6;">${executedFormatted}</div>
                            <span class="metric-change neutral">${Math.round((executed/budget)*100)}%</span>
                        </div>
                        <div class="metric-divider"></div>
                        <div class="metric-cell">
                            <div class="metric-label">Disponible</div>
                            <div class="metric-value" style="color: #22c55e;">${remainingFormatted}</div>
                        </div>
                        <div class="metric-divider"></div>
                        <div class="metric-cell">
                            <div class="metric-label">Dias Restantes</div>
                            <div class="metric-value" style="color: ${daysRemaining < 30 ? '#ef4444' : '#22c55e'};">${daysRemaining}</div>
                        </div>
                    </div>

                    <div class="scrollable" style="flex: 1; overflow-y: auto;">
                        <div class="info-cards-grid" style="grid-template-columns: 2fr 1fr;">
                            <!-- Execution Chart -->
                            <div class="project-card" style="padding: 20px;">
                                <h4 class="card-title">
                                    <i class="fas fa-chart-line" style="color: #3b82f6;"></i>
                                    Ejecucion Mensual
                                </h4>
                                <div style="display: flex; align-items: flex-end; justify-content: space-between; height: 200px; padding: 16px 0; border-bottom: 1px solid var(--border-color);">
                                    ${monthlyData.map(m => {
                                        const maxVal = Math.max(...monthlyData.map(d => Math.max(d.planned, d.actual)));
                                        const plannedHeight = (m.planned / maxVal) * 100;
                                        const actualHeight = (m.actual / maxVal) * 100;
                                        return `
                                            <div style="display: flex; flex-direction: column; align-items: center; gap: 8px; flex: 1;">
                                                <div style="display: flex; align-items: flex-end; gap: 4px; height: 160px;">
                                                    <div style="width: 20px; height: ${plannedHeight}%; background: rgba(59, 130, 246, 0.3); border-radius: 4px 4px 0 0;"></div>
                                                    <div style="width: 20px; height: ${actualHeight}%; background: #3b82f6; border-radius: 4px 4px 0 0;"></div>
                                                </div>
                                                <span style="font-size: 10px; color: var(--text-muted);">${m.month}</span>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                                <div style="display: flex; justify-content: center; gap: 24px; padding-top: 12px;">
                                    <span style="display: flex; align-items: center; gap: 6px; font-size: 11px; color: var(--text-muted);">
                                        <span style="width: 12px; height: 12px; background: rgba(59, 130, 246, 0.3); border-radius: 2px;"></span>
                                        Planificado
                                    </span>
                                    <span style="display: flex; align-items: center; gap: 6px; font-size: 11px; color: var(--text-muted);">
                                        <span style="width: 12px; height: 12px; background: #3b82f6; border-radius: 2px;"></span>
                                        Ejecutado
                                    </span>
                                </div>
                            </div>

                            <!-- Categories Breakdown -->
                            <div class="project-card" style="padding: 20px;">
                                <h4 class="card-title">
                                    <i class="fas fa-pie-chart" style="color: #a855f7;"></i>
                                    Por Categoria
                                </h4>
                                <div style="display: flex; flex-direction: column; gap: 12px; margin-top: 16px;">
                                    ${categories.map(cat => {
                                        const percent = Math.round((cat.amount / executed) * 100);
                                        const amountFormatted = new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(cat.amount);
                                        return `
                                            <div style="display: flex; align-items: center; gap: 12px;">
                                                <div style="width: 32px; height: 32px; border-radius: 8px; background: ${cat.color}20; display: flex; align-items: center; justify-content: center;">
                                                    <i class="fas ${cat.icon}" style="color: ${cat.color}; font-size: 12px;"></i>
                                                </div>
                                                <div style="flex: 1;">
                                                    <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                                        <span style="font-size: 12px; font-weight: 500;">${cat.name}</span>
                                                        <span style="font-size: 11px; color: var(--text-muted);">${amountFormatted}</span>
                                                    </div>
                                                    <div style="height: 6px; background: var(--bg-tertiary); border-radius: 3px; overflow: hidden;">
                                                        <div style="height: 100%; width: ${percent}%; background: ${cat.color}; border-radius: 3px;"></div>
                                                    </div>
                                                </div>
                                                <span style="font-size: 11px; font-weight: 600; color: ${cat.color};">${percent}%</span>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        </div>

                        <!-- Deadline Timeline -->
                        <div class="project-card" style="padding: 20px; margin-top: 16px;">
                            <h4 class="card-title">
                                <i class="fas fa-calendar-alt" style="color: #22c55e;"></i>
                                Timeline del Proyecto
                            </h4>
                            <div style="display: flex; align-items: center; gap: 16px; margin-top: 16px;">
                                <div style="text-align: center;">
                                    <div style="font-size: 10px; color: var(--text-muted); text-transform: uppercase;">Inicio</div>
                                    <div style="font-size: 14px; font-weight: 600;">Sep 2024</div>
                                </div>
                                <div style="flex: 1; position: relative; height: 8px; background: var(--bg-tertiary); border-radius: 4px;">
                                    <div style="position: absolute; left: 0; top: 0; height: 100%; width: 65%; background: linear-gradient(90deg, #22c55e, #3b82f6); border-radius: 4px;"></div>
                                    <div style="position: absolute; left: 65%; top: -6px; width: 20px; height: 20px; background: var(--solaria-orange); border-radius: 50%; border: 3px solid var(--bg-primary);"></div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 10px; color: var(--text-muted); text-transform: uppercase;">Entrega</div>
                                    <div style="font-size: 14px; font-weight: 600;">${deadlineDate.toLocaleDateString('es-ES', { month: 'short', year: 'numeric' })}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            },

            exportBudgetReport() {
                alert('Exportar reporte de presupuesto\n\n(Esta funcionalidad generara un PDF/Excel)');
            },

            // ============================================
            // URLS DETAIL PAGE
            // ============================================

            openUrlsDetail() {
                const project = this.state.currentProject;
                if (!project) {
                    console.warn('No project selected');
                    return;
                }

                const urls = project.urls || {};

                // URL types configuration
                const urlTypes = [
                    { key: 'production', label: 'Produccion', icon: 'fa-globe', color: '#22c55e', desc: 'URL del sitio en vivo' },
                    { key: 'staging', label: 'Staging / Test', icon: 'fa-flask', color: '#f59e0b', desc: 'Ambiente de pruebas' },
                    { key: 'local', label: 'Desarrollo Local', icon: 'fa-laptop-code', color: '#6366f1', desc: 'Servidor de desarrollo' },
                    { key: 'repository', label: 'Repositorio', icon: 'fa-code-branch', color: '#a855f7', desc: 'Codigo fuente en Git' },
                    { key: 'projectPortal', label: 'Portal DFO', icon: 'fa-solar-panel', color: 'var(--solaria-orange)', desc: 'Panel de gestion del proyecto' }
                ];

                // Mock health status
                const healthStatus = {
                    production: { status: 'online', latency: '145ms', uptime: '99.9%' },
                    staging: { status: 'online', latency: '230ms', uptime: '98.5%' },
                    local: { status: 'offline', latency: '-', uptime: '-' },
                    repository: { status: 'online', latency: '89ms', uptime: '99.99%' },
                    projectPortal: { status: 'online', latency: '120ms', uptime: '99.5%' }
                };

                this.elements.contentArea.innerHTML = `
                    <div class="section-header">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <button class="header-btn" onclick="App.goBackToProjectDetail()" title="Volver al proyecto">
                                <i class="fas fa-arrow-left"></i>
                            </button>
                            <div>
                                <h1 class="section-title">Direcciones - ${project.name}</h1>
                                <p class="section-subtitle">URLs y accesos del proyecto</p>
                            </div>
                        </div>
                        <div class="section-actions">
                            <button class="btn-primary" onclick="App.addNewUrl()">
                                <i class="fas fa-plus"></i> Agregar URL
                            </button>
                        </div>
                    </div>

                    <!-- Status Summary -->
                    <div class="metrics-row" style="margin-bottom: 16px;">
                        <div class="metric-cell">
                            <div class="metric-label">Total URLs</div>
                            <div class="metric-value">${Object.values(urls).filter(u => u).length}</div>
                        </div>
                        <div class="metric-divider"></div>
                        <div class="metric-cell">
                            <div class="metric-label">Online</div>
                            <div class="metric-value" style="color: #22c55e;">${Object.keys(urls).filter(k => urls[k] && healthStatus[k]?.status === 'online').length}</div>
                        </div>
                        <div class="metric-divider"></div>
                        <div class="metric-cell">
                            <div class="metric-label">Offline</div>
                            <div class="metric-value" style="color: #ef4444;">${Object.keys(urls).filter(k => urls[k] && healthStatus[k]?.status === 'offline').length}</div>
                        </div>
                    </div>

                    <div class="scrollable" style="flex: 1; overflow-y: auto;">
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                            ${urlTypes.map(type => {
                                const url = urls[type.key];
                                const health = healthStatus[type.key] || { status: 'unknown', latency: '-', uptime: '-' };
                                const statusColor = health.status === 'online' ? '#22c55e' : (health.status === 'offline' ? '#ef4444' : '#64748b');

                                return `
                                    <div class="project-card" style="padding: 16px;">
                                        <div style="display: flex; align-items: center; gap: 16px;">
                                            <!-- Icon -->
                                            <div style="width: 48px; height: 48px; border-radius: 12px; background: ${type.color}20; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                                <i class="fas ${type.icon}" style="color: ${type.color}; font-size: 18px;"></i>
                                            </div>

                                            <!-- Info -->
                                            <div style="flex: 1; min-width: 0;">
                                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                                    <span style="font-size: 14px; font-weight: 600;">${type.label}</span>
                                                    <span style="width: 8px; height: 8px; border-radius: 50%; background: ${statusColor};"></span>
                                                </div>
                                                <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 6px;">${type.desc}</div>
                                                ${url ? `
                                                    <a href="${url}" target="_blank" style="font-size: 12px; color: ${type.color}; text-decoration: none; word-break: break-all;">
                                                        ${url} <i class="fas fa-external-link-alt" style="font-size: 9px; margin-left: 4px;"></i>
                                                    </a>
                                                ` : `
                                                    <span style="font-size: 12px; color: var(--text-muted); font-style: italic;">No configurada</span>
                                                `}
                                            </div>

                                            <!-- Health Stats -->
                                            ${url ? `
                                                <div style="display: flex; gap: 16px; flex-shrink: 0;">
                                                    <div style="text-align: center;">
                                                        <div style="font-size: 9px; color: var(--text-muted); text-transform: uppercase;">Latencia</div>
                                                        <div style="font-size: 13px; font-weight: 600;">${health.latency}</div>
                                                    </div>
                                                    <div style="text-align: center;">
                                                        <div style="font-size: 9px; color: var(--text-muted); text-transform: uppercase;">Uptime</div>
                                                        <div style="font-size: 13px; font-weight: 600; color: #22c55e;">${health.uptime}</div>
                                                    </div>
                                                </div>
                                            ` : ''}

                                            <!-- Actions -->
                                            <div style="display: flex; gap: 8px; flex-shrink: 0;">
                                                ${url ? `
                                                    <button class="header-btn" onclick="App.copyUrl('${url}')" title="Copiar URL">
                                                        <i class="fas fa-copy"></i>
                                                    </button>
                                                    <a href="${url}" target="_blank" class="header-btn" title="Abrir en nueva ventana">
                                                        <i class="fas fa-external-link-alt"></i>
                                                    </a>
                                                    <button class="header-btn" onclick="App.checkUrlHealth('${type.key}')" title="Verificar estado">
                                                        <i class="fas fa-heartbeat"></i>
                                                    </button>
                                                ` : ''}
                                                <button class="header-btn" onclick="App.editUrl('${type.key}')" title="Editar URL">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>

                        <!-- Quick Links Section -->
                        <div class="project-card" style="padding: 20px; margin-top: 16px;">
                            <h4 class="card-title">
                                <i class="fas fa-bolt" style="color: #f59e0b;"></i>
                                Acceso Rapido
                            </h4>
                            <div style="display: flex; flex-wrap: wrap; gap: 12px; margin-top: 16px;">
                                ${Object.entries(urls).filter(([k, v]) => v).map(([key, url]) => {
                                    const type = urlTypes.find(t => t.key === key);
                                    if (!type) return '';
                                    return `
                                        <a href="${url}" target="_blank" class="quick-link-btn" style="display: inline-flex; align-items: center; gap: 8px; padding: 10px 16px; background: ${type.color}20; border-radius: 8px; text-decoration: none; color: ${type.color}; font-size: 12px; font-weight: 500; transition: all 0.2s;">
                                            <i class="fas ${type.icon}"></i>
                                            ${type.label}
                                        </a>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                `;
            },

            copyUrl(url) {
                navigator.clipboard.writeText(url).then(() => {
                    alert('URL copiada al portapapeles');
                }).catch(err => {
                    console.error('Error al copiar:', err);
                });
            },

            checkUrlHealth(urlKey) {
                alert(`Verificando estado de ${urlKey}...\n\n(Esta funcionalidad realizara un ping/health check real)`);
            },

            editUrl(urlKey) {
                const project = this.state.currentProject;
                const currentUrl = project.urls?.[urlKey] || '';
                const newUrl = prompt(`Editar URL para ${urlKey}:`, currentUrl);

                if (newUrl !== null) {
                    if (!project.urls) project.urls = {};
                    project.urls[urlKey] = newUrl || null;
                    this.openUrlsDetail(); // Refresh view
                }
            },

            addNewUrl() {
                alert('Agregar nueva URL personalizada\n\n(Esta funcionalidad permitira agregar URLs adicionales)');
            },

            // ============================================
            // SOCKET.IO & NOTIFICATIONS SYSTEM
            // ============================================

            initSocket() {
                if (typeof io === 'undefined') {
                    console.warn('Socket.IO not available');
                    return;
                }

                this.socket = io();

                this.socket.on('connect', () => {
                    console.log(' Socket connected:', this.socket.id);

                    // Authenticate with token
                    const token = localStorage.getItem('authToken');
                    if (token) {
                        this.socket.emit('authenticate', token);
                    }

                    // Subscribe to notifications channel
                    this.socket.emit('subscribe_notifications');
                });

                this.socket.on('authenticated', (data) => {
                    console.log(' Socket authenticated:', data.user?.name);
                });

                // Listen for real-time notifications
                this.socket.on('notification', (notification) => {
                    this.addNotification(notification);
                });

                this.socket.on('task_created', (data) => {
                    console.log(' task_created event:', data);
                    this.addNotification({
                        type: 'task',
                        title: 'Nueva tarea creada',
                        message: data.title || 'Se creo una nueva tarea',
                        projectId: data.project_id,
                        taskId: data.id,
                        timestamp: new Date().toISOString()
                    });
                    // Real-time update ALL views (Kanban, List, Gantt, Widgets)
                    this.handleTaskRealTimeEvent(data, 'create');
                });

                this.socket.on('task_updated', (data) => {
                    console.log(' task_updated event:', data);
                    this.addNotification({
                        type: 'task',
                        title: 'Tarea actualizada',
                        message: data.title || 'Se actualizo una tarea',
                        projectId: data.project_id,
                        taskId: data.id,
                        timestamp: new Date().toISOString()
                    });
                    // Real-time update ALL views (Kanban, List, Gantt, Widgets)
                    this.handleTaskRealTimeEvent(data, 'update');
                });

                this.socket.on('task_deleted', (data) => {
                    console.log(' task_deleted event:', data);
                    this.addNotification({
                        type: 'task',
                        title: 'Tarea eliminada',
                        message: `Tarea #${data.id} eliminada`,
                        projectId: data.project_id,
                        taskId: data.id,
                        timestamp: new Date().toISOString()
                    });
                    // Real-time update ALL views (Kanban, List, Gantt, Widgets)
                    this.handleTaskRealTimeEvent(data, 'delete');
                });

                this.socket.on('task_completed', (data) => {
                    console.log(' task_completed event:', data);
                    this.addNotification({
                        type: 'task',
                        title: 'Tarea completada',
                        message: data.title || 'Se completo una tarea',
                        projectId: data.project_id,
                        taskId: data.id,
                        timestamp: new Date().toISOString()
                    });

                    // Update completed tasks feed on dashboard (real-time)
                    this.addCompletedTaskToFeed({
                        id: data.id,
                        title: data.title || `Tarea #${data.id}`,
                        project_id: data.project_id,
                        project_name: data.project_name || 'Proyecto',
                        agent_name: data.agent_name,
                        priority: data.priority || 'medium',
                        completed_at: new Date().toISOString()
                    });
                    // Real-time update ALL views with completed status
                    this.handleTaskRealTimeEvent({ ...data, status: 'completed' }, 'update');
                });

                this.socket.on('project_updated', (data) => {
                    this.addNotification({
                        type: 'project',
                        title: 'Proyecto actualizado',
                        message: data.name || 'Se actualizo un proyecto',
                        projectId: data.id,
                        timestamp: new Date().toISOString()
                    });
                });

                this.socket.on('disconnect', () => {
                    console.log(' Socket disconnected');
                });
            },

            initNotifications() {
                // Update badge on load
                this.updateNotificationBadge();
                this.renderNotificationsList();

                // Notification button click
                this.elements.notificationsBtn?.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.toggleNotificationsPanel();
                });

                // Clear all button
                this.elements.clearNotifications?.addEventListener('click', () => {
                    this.clearAllNotifications();
                });

                // Close panel on outside click
                document.addEventListener('click', (e) => {
                    if (this.state.notificationsPanelOpen &&
                        !this.elements.notificationsPanel?.contains(e.target) &&
                        !this.elements.notificationsBtn?.contains(e.target)) {
                        this.closeNotificationsPanel();
                    }
                });
            },

            addNotification(notification) {
                const newNotif = {
                    id: Date.now(),
                    ...notification,
                    read: false,
                    timestamp: notification.timestamp || new Date().toISOString()
                };

                // Add to beginning of array (newest first)
                this.state.notifications.unshift(newNotif);

                // Keep only last 50 notifications
                if (this.state.notifications.length > 50) {
                    this.state.notifications = this.state.notifications.slice(0, 50);
                }

                // Save to localStorage
                this.saveNotifications();

                // Update UI
                this.updateNotificationBadge();
                this.renderNotificationsList();

                // Show toast notification
                this.showNotificationToast(newNotif);
            },

            saveNotifications() {
                localStorage.setItem('dfo_notifications', JSON.stringify(this.state.notifications));
            },

            updateNotificationBadge() {
                const unreadCount = this.state.notifications.filter(n => !n.read).length;
                const badge = this.elements.notificationBadge;

                if (badge) {
                    if (unreadCount > 0) {
                        badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
                        badge.classList.add('has-notifications');
                    } else {
                        badge.textContent = '';
                        badge.classList.remove('has-notifications');
                    }
                }
            },

            toggleNotificationsPanel() {
                if (this.state.notificationsPanelOpen) {
                    this.closeNotificationsPanel();
                } else {
                    this.openNotificationsPanel();
                }
            },

            openNotificationsPanel() {
                this.state.notificationsPanelOpen = true;
                this.elements.notificationsPanel?.classList.add('show');
                this.elements.notificationsBtn?.classList.add('active');

                // Mark all as read when opening
                this.state.notifications.forEach(n => n.read = true);
                this.saveNotifications();
                this.updateNotificationBadge();
            },

            closeNotificationsPanel() {
                this.state.notificationsPanelOpen = false;
                this.elements.notificationsPanel?.classList.remove('show');
                this.elements.notificationsBtn?.classList.remove('active');
            },

            renderNotificationsList() {
                const list = this.elements.notificationsList;
                if (!list) return;

                if (this.state.notifications.length === 0) {
                    list.innerHTML = `
                        <div class="notifications-empty">
                            <i class="fas fa-bell-slash"></i>
                            <p>No hay notificaciones</p>
                        </div>
                    `;
                    return;
                }

                list.innerHTML = this.state.notifications.map(notif => {
                    const icon = this.getNotificationIcon(notif.type);
                    const timeAgo = this.getTimeAgo(notif.timestamp);

                    return `
                        <div class="notification-item ${notif.read ? '' : 'unread'}"
                             onclick="App.handleNotificationClick(${notif.id})">
                            <div class="notification-icon ${notif.type}">
                                <i class="fas ${icon}"></i>
                            </div>
                            <div class="notification-content">
                                <div class="notification-title">${this.escapeHtml(notif.title)}</div>
                                <div class="notification-message">${this.escapeHtml(notif.message)}</div>
                                <div class="notification-time">${timeAgo}</div>
                            </div>
                        </div>
                    `;
                }).join('');
            },

            getNotificationIcon(type) {
                const icons = {
                    task: 'fa-tasks',
                    project: 'fa-folder',
                    business: 'fa-building',
                    alert: 'fa-exclamation-triangle',
                    info: 'fa-info-circle'
                };
                return icons[type] || 'fa-bell';
            },

            getTimeAgo(timestamp) {
                const now = new Date();
                const date = new Date(timestamp);
                const seconds = Math.floor((now - date) / 1000);

                if (seconds < 60) return 'Ahora mismo';
                if (seconds < 3600) return `Hace ${Math.floor(seconds / 60)} min`;
                if (seconds < 86400) return `Hace ${Math.floor(seconds / 3600)}h`;
                if (seconds < 604800) return `Hace ${Math.floor(seconds / 86400)}d`;
                return date.toLocaleDateString('es-ES', { day: 'numeric', month: 'short' });
            },

            handleNotificationClick(notifId) {
                const notif = this.state.notifications.find(n => n.id === notifId);
                if (!notif) return;

                // Mark as read
                notif.read = true;
                this.saveNotifications();
                this.renderNotificationsList();

                // Navigate based on type
                if (notif.type === 'task' && notif.projectId) {
                    this.closeNotificationsPanel();
                    // Navigate to project tasks
                    window.location.hash = `#project/${notif.projectId}/tasks`;
                } else if (notif.type === 'project' && notif.projectId) {
                    this.closeNotificationsPanel();
                    window.location.hash = `#project/${notif.projectId}`;
                }
            },

            clearAllNotifications() {
                this.state.notifications = [];
                this.saveNotifications();
                this.updateNotificationBadge();
                this.renderNotificationsList();
            },

            // Simple notification helper for in-app feedback
            showNotification(message, type = 'info') {
                const iconMap = {
                    success: 'fa-check-circle',
                    error: 'fa-exclamation-circle',
                    warning: 'fa-exclamation-triangle',
                    info: 'fa-info-circle'
                };
                const typeMap = {
                    success: 'project',
                    error: 'alert',
                    warning: 'business',
                    info: 'task'
                };
                this.showNotificationToast({
                    title: type.charAt(0).toUpperCase() + type.slice(1),
                    message: message,
                    type: typeMap[type] || 'task'
                });
            },

            showNotificationToast(notif) {
                // Create toast element
                const toast = document.createElement('div');
                toast.className = 'notification-toast';
                toast.innerHTML = `
                    <div class="notification-icon ${notif.type}">
                        <i class="fas ${this.getNotificationIcon(notif.type)}"></i>
                    </div>
                    <div class="notification-content">
                        <div class="notification-title">${this.escapeHtml(notif.title)}</div>
                        <div class="notification-message">${this.escapeHtml(notif.message)}</div>
                    </div>
                `;

                // Add styles if not exists
                if (!document.getElementById('toast-styles')) {
                    const style = document.createElement('style');
                    style.id = 'toast-styles';
                    style.textContent = `
                        .notification-toast {
                            position: fixed;
                            top: 80px;
                            right: 20px;
                            display: flex;
                            gap: 12px;
                            padding: 16px;
                            background: var(--bg-card);
                            border: 1px solid var(--border-color);
                            border-radius: 12px;
                            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
                            z-index: 2000;
                            animation: slideIn 0.3s ease, fadeOut 0.3s ease 4.7s;
                            max-width: 350px;
                        }
                        @keyframes slideIn {
                            from { transform: translateX(100%); opacity: 0; }
                            to { transform: translateX(0); opacity: 1; }
                        }
                        @keyframes fadeOut {
                            from { opacity: 1; }
                            to { opacity: 0; }
                        }
                    `;
                    document.head.appendChild(style);
                }

                document.body.appendChild(toast);

                // Remove after 5 seconds
                setTimeout(() => toast.remove(), 5000);
            },

            // Render markdown description with basic formatting support
            // Supports: **bold**, *italic*, `code`, - lists, ## headers, checkboxes
            renderMarkdownDescription(text) {
                if (!text) return '<span style="color: var(--text-muted); font-style: italic;">Sin descripcion</span>';

                // Escape HTML first for security
                let html = this.escapeHtml(text);

                // Convert markdown to HTML
                // Headers (## and ###)
                html = html.replace(/^### (.+)$/gm, '<h4 style="margin: 12px 0 6px; font-size: 13px; font-weight: 600; color: var(--text-primary);">$1</h4>');
                html = html.replace(/^## (.+)$/gm, '<h3 style="margin: 16px 0 8px; font-size: 14px; font-weight: 600; color: var(--text-primary);">$1</h3>');

                // Bold and italic
                html = html.replace(/\*\*(.+?)\*\*/g, '<strong style="font-weight: 600; color: var(--text-primary);">$1</strong>');
                html = html.replace(/\*(.+?)\*/g, '<em>$1</em>');

                // Inline code
                html = html.replace(/`([^`]+)`/g, '<code style="background: var(--bg-tertiary); padding: 2px 6px; border-radius: 4px; font-family: monospace; font-size: 12px;">$1</code>');

                // Checkboxes: - [ ] and - [x]
                html = html.replace(/^- \[x\] (.+)$/gm,
                    '<div style="display: flex; align-items: flex-start; gap: 8px; margin: 4px 0; padding: 6px 10px; background: rgba(34, 197, 94, 0.1); border-radius: 6px; border-left: 3px solid #22c55e;">' +
                    '<i class="fas fa-check-square" style="color: #22c55e; margin-top: 2px;"></i>' +
                    '<span style="text-decoration: line-through; color: var(--text-muted);">$1</span></div>');
                html = html.replace(/^- \[ \] (.+)$/gm,
                    '<div style="display: flex; align-items: flex-start; gap: 8px; margin: 4px 0; padding: 6px 10px; background: var(--bg-secondary); border-radius: 6px; border-left: 3px solid var(--border-color);">' +
                    '<i class="far fa-square" style="color: var(--text-muted); margin-top: 2px;"></i>' +
                    '<span>$1</span></div>');

                // Regular list items
                html = html.replace(/^- (.+)$/gm,
                    '<div style="display: flex; align-items: flex-start; gap: 8px; margin: 3px 0; padding-left: 4px;">' +
                    '<span style="color: var(--solaria-orange);"></span><span>$1</span></div>');

                // Numbered lists
                html = html.replace(/^(\d+)\. (.+)$/gm,
                    '<div style="display: flex; align-items: flex-start; gap: 8px; margin: 3px 0; padding-left: 4px;">' +
                    '<span style="color: var(--solaria-orange); font-weight: 600; min-width: 18px;">$1.</span><span>$2</span></div>');

                // Line breaks (convert double newlines to paragraph breaks)
                html = html.replace(/\n\n/g, '</p><p style="margin: 8px 0;">');
                html = html.replace(/\n/g, '<br>');

                // Wrap in paragraph if no HTML block elements
                if (!html.startsWith('<h') && !html.startsWith('<div')) {
                    html = '<p style="margin: 0;">' + html + '</p>';
                }

                return html;
            },

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        };

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', () => App.init());
    </script>
</body>
</html>
