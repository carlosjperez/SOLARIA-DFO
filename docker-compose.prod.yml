# SOLARIA Digital Field Operations - Production Docker Compose
# For deployment on dfo.solaria.agency (148.230.118.124)

version: '3.8'

services:
  # ===========================================
  # OFFICE: Dashboard + MariaDB (unified)
  # ===========================================
  office:
    build:
      context: .
      dockerfile: office.Dockerfile
    container_name: solaria-dfo-office
    ports:
      - "3030:3030"
    environment:
      - DB_PASSWORD=${DB_PASSWORD:-solaria2024}
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD:-SolariaRoot2024}
      - DB_NAME=solaria_construction
      - DB_USER=solaria_user
      - JWT_SECRET=${JWT_SECRET:-solaria_jwt_secret_2024_min32chars_secure}
      - NODE_ENV=production
      - PORT=3030
    volumes:
      - office_mysql_data:/var/lib/mysql
      - ./logs:/app/logs
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:3030/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    restart: always
    networks:
      - solaria-dfo-network

  # ===========================================
  # MCP-HTTP: HTTP Transport for remote agents
  # ===========================================
  mcp-http:
    build:
      context: ./mcp-server
      dockerfile: Dockerfile.http
    container_name: solaria-dfo-mcp
    ports:
      - "3031:3031"
    environment:
      - DASHBOARD_API_URL=http://office:3030/api
      - DASHBOARD_USER=${DASHBOARD_USER:-carlosjperez}
      - DASHBOARD_PASS=${DASHBOARD_PASS:-bypass}
      - MCP_PORT=3031
      - JWT_SECRET=${JWT_SECRET:-solaria_jwt_secret_2024_min32chars_secure}
      - NODE_ENV=production
    depends_on:
      office:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "-O-", "http://127.0.0.1:3031/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    restart: always
    networks:
      - solaria-dfo-network

  # ===========================================
  # REDIS: Cache and job queues
  # ===========================================
  redis:
    image: redis:7-alpine
    container_name: solaria-dfo-redis
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: always
    networks:
      - solaria-dfo-network

  # ===========================================
  # WORKER: Background Jobs + Embedding Service
  # Transformers.js for local vector embeddings
  # ===========================================
  worker:
    build:
      context: .
      dockerfile: worker.Dockerfile
    container_name: solaria-dfo-worker
    ports:
      - "3032:3032"
    environment:
      - REDIS_URL=redis://redis:6379
      - DASHBOARD_URL=http://office:3030
      - DB_HOST=office
      - DB_PORT=3306
      - DB_USER=solaria_user
      - DB_PASSWORD=${DB_PASSWORD:-solaria2024}
      - DB_NAME=solaria_construction
      - EMBEDDING_HTTP_PORT=3032
      - NODE_ENV=production
    volumes:
      - worker_models:/app/models
      - worker_cache:/app/.cache
    depends_on:
      office:
        condition: service_healthy
      redis:
        condition: service_healthy
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 512M
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3032/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    restart: always
    networks:
      - solaria-dfo-network

  # ===========================================
  # NGINX: Unified reverse proxy for all SOLARIA domains
  # Manages: dfo.solaria.agency, office.solaria.agency, prilabsa.solaria.agency
  # ===========================================
  nginx:
    image: nginx:alpine
    container_name: solaria-dfo-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./infrastructure/nginx/nginx.prod.conf:/etc/nginx/nginx.conf:ro
      - ./scripts/install-mcp-remote.sh:/etc/nginx/install-mcp-remote.sh:ro
      - /etc/letsencrypt:/etc/letsencrypt:ro
      - certbot_webroot:/var/www/certbot
      # Office CRM React app (served as static files)
      - /var/www/office-app:/var/www/office-app:ro
      # PRILABSA static files (external volumes from prilabsa-production)
      - prilabsa_frontend:/usr/share/nginx/prilabsa/frontend:ro
      - prilabsa_dashboard:/usr/share/nginx/prilabsa/dashboard:ro
      - prilabsa_landing:/usr/share/nginx/prilabsa/landing:ro
      - prilabsa_uploads:/usr/share/nginx/prilabsa/uploads:ro
      - prilabsa_wp_uploads:/usr/share/nginx/prilabsa/wp-uploads:ro
    depends_on:
      office:
        condition: service_healthy
      mcp-http:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "-O-", "http://127.0.0.1/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    restart: always
    networks:
      - solaria-dfo-network
      - prilabsa-network

volumes:
  office_mysql_data:
    driver: local
  redis_data:
    driver: local
  worker_models:
    driver: local
  worker_cache:
    driver: local
  certbot_webroot:
    driver: local
  # PRILABSA external volumes (created by prilabsa-production stack)
  prilabsa_frontend:
    external: true
    name: prilabsa-production_frontend_dist
  prilabsa_dashboard:
    external: true
    name: prilabsa-production_dashboard_dist
  prilabsa_landing:
    external: true
    name: prilabsa-production_landing_dist
  prilabsa_uploads:
    external: true
    name: prilabsa-production_api_uploads
  prilabsa_wp_uploads:
    external: true
    name: prilabsa-production_wordpress_uploads

networks:
  solaria-dfo-network:
    driver: bridge
  prilabsa-network:
    external: true
    name: prilabsa-production-network
