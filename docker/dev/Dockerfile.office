# SOLARIA DFO - Office Development Dockerfile
# Dashboard + MariaDB (with hot-reload)
FROM node:22-bookworm

ENV DEBIAN_FRONTEND=noninteractive

# Install MariaDB and tools
RUN apt-get update \
 && apt-get install -y --no-install-recommends mariadb-server curl \
 && rm -rf /var/lib/apt/lists/*

# Create mysql user data dir
RUN mkdir -p /var/run/mysqld /var/lib/mysql /docker-entrypoint-initdb.d \
 && chown -R mysql:mysql /var/run/mysqld /var/lib/mysql /docker-entrypoint-initdb.d

# Dashboard app workdir
WORKDIR /app

# Install ALL dependencies (including devDependencies for hot-reload)
COPY dashboard/package*.json ./
RUN npm install

# NOTE: Code is mounted as volume for hot-reload
# No COPY of source code here

# Init SQL
COPY infrastructure/database/mysql-init.sql /docker-entrypoint-initdb.d/01-init.sql

# Entrypoint script (development version with hot-reload)
COPY office-entrypoint-dev.sh /usr/local/bin/office-entrypoint.sh
RUN chmod +x /usr/local/bin/office-entrypoint.sh

EXPOSE 3030 3306
VOLUME ["/var/lib/mysql", "/app/logs"]

# Development environment variables
ENV DB_PASSWORD=solaria2024 \
    MYSQL_ROOT_PASSWORD=SolariaRoot2024 \
    DB_NAME=solaria_construction \
    DB_USER=solaria_user \
    JWT_SECRET=solaria_jwt_secret_dev_not_for_production \
    NODE_ENV=development \
    PORT=3030

ENTRYPOINT ["/usr/local/bin/office-entrypoint.sh"]
