# SOLARIA DFO MCP v2.0 - Nginx Configuration
# Simplified configuration for dual MCP deployment

user nginx;
worker_processes auto;
error_log /var/log/nginx/error.log notice;
pid /var/run/nginx.pid;

events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    log_format main '\$remote_addr - \$remote_user [\$time_local] "\$request" '
                 '\$status \$body_bytes_sent "\$http_referer" '
                 '"\$http_user_agent" "\$http_x_forwarded_for"';

    access_log /var/log/nginx/access.log main;

    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;
    client_max_body_size 50M;

    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css text/xml text/javascript
                application/javascript application/json application/xml;

    # ===========================================
    # SOLARIA DFO Upstreams
    # ===========================================

    upstream dashboard {
        server solaria-dfo-office:3030;
    }

    upstream mcp_http_v1 {
        server solaria-dfo-mcp:3031;
    }

    # MCP-HTTP v2.0 (Sketch Pattern) - NEW
    upstream mcp_http_v2 {
        server solaria-dfo-mcp-v2:3032;
    }

    # ===========================================
    # Server blocks
    # ===========================================

    server {
        listen 80;
        server_name dfo.solaria.agency;

        # MCP HTTP v1.0
        location /mcp {
            proxy_pass http://mcp_http_v1;

            # Default to v1.0 if no version header
            set \$mcp_version 1.0;
            proxy_set_header X-MCP-Version 1.0;

            # Health check
            location /mcp/health {
                proxy_pass http://mcp_http_v1;
                access_log off;
                return 200 'v1.0 healthy';
            }

            # Tools list
            location /mcp/tools/list {
                proxy_pass http://mcp_http_v1;
                if (\$request_method = 'OPTIONS') {
                    add_header 'Access-Control-Max-Age' 1728000;
                    add_header 'Content-Type' 'text/plain charset=UTF-8';
                    add_header 'Content-Length' 0;
                    return 204;
                }

                set \$mcp_version 1.0;
                proxy_pass http://mcp_http_v1;

                add_header 'Access-Control-Allow-Origin' '*' always;
                add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS' always;
                add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type, Content-Length, X-MCP-Version, X-Project-Id, Mcp-Session-Id' always;
            }
        }

        # MCP HTTP v2.0 (Sketch Pattern)
        location /mcp-v2 {
            proxy_pass http://mcp_http_v2;

            # Default to v2.0
            set \$mcp_version 2.0;
            proxy_set_header X-MCP-Version 2.0;

            # Health check
            location /mcp-v2/health {
                proxy_pass http://mcp_http_v2;
                access_log off;
                return 200 'v2.0 healthy';
            }

            # Tools list
            location /mcp-v2/tools/list {
                proxy_pass http://mcp_http_v2;
                if (\$request_method = 'OPTIONS') {
                    add_header 'Access-Control-Max-Age' 1728000;
                    add_header 'Content-Type' 'text/plain charset=UTF-8';
                    add_header 'Content-Length' 0;
                    return 204;
                }

                set \$mcp_version 2.0;
                proxy_pass http://mcp_http_v2;

                add_header 'Access-Control-Allow-Origin' '*' always;
                add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS' always;
                add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type, Content-Length, X-MCP-Version, X-Project-Id, Mcp-Session-Id' always;
            }
        }
    }
